<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Avançado de Checklist de Manutenção</title>
    <script>(function(){try{var s=localStorage.getItem('theme');var p=window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;var d=s?s==='dark':p;if(d){document.documentElement.classList.add('dark');}}catch(e){}})();</script>
    
    <!-- Cliente API Personalizado (Substitui Supabase) -->
    <script src="apiClient.js"></script>
    
    <!-- Outras dependências -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js" defer></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.30.0/index.min.js" defer></script>
    <script>
        // Configuração do Tailwind (Play CDN)
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        'primary-dark': '#4B46C7',
                        'primary-light': '#8B8DF0',
                        success: '#10B981',
                        warning: '#F59E0B', 
                        danger: '#EF4444',
                        info: '#3B82F6'
                    },
                    backdropBlur: {
                        'xs': '2px'
                    }
                }
            },
            darkMode: 'class'
        }
    </script>
    
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Animações avançadas */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        .slide-in { animation: slideInLeft 0.4s ease-out; }
        .slide-up { animation: slideUp 0.3s ease-out; }
        .bounce-in { animation: bounceIn 0.6s ease-out; }
        .float { animation: float 3s ease-in-out infinite; }
        .glow { animation: glow 2s ease-in-out infinite alternate; }
        .pulse-glow { animation: pulseGlow 1.5s ease-in-out infinite; }
        .scale-in { animation: scaleIn 0.3s ease-out; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes slideInLeft { 
            from { opacity: 0; transform: translateX(-30px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        @keyframes slideInRight { 
            from { opacity: 0; transform: translateX(30px); } 
            to { opacity: 1; transform: translateX(0); } 
        }
        @keyframes slideUp { 
            from { opacity: 0; transform: translateY(30px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        @keyframes bounceIn { 
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { transform: scale(1); }
        }
        @keyframes float { 
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        @keyframes glow {
            from { box-shadow: 0 0 5px #5D5CDE, 0 0 10px #5D5CDE, 0 0 15px #5D5CDE; }
            to { box-shadow: 0 0 10px #5D5CDE, 0 0 20px #5D5CDE, 0 0 30px #5D5CDE; }
        }
        @keyframes pulseGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(93, 92, 222, 0.3); }
            50% { box-shadow: 0 8px 25px rgba(93, 92, 222, 0.6); }
        }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.9); }
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes progress {
            from { width: 0%; }
            to { width: var(--progress-width); }
        }
        
        /* Glass Morphism Effect */
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .dark .glass-morphism {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Gradient Backgrounds */
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-primary {
            background: linear-gradient(135deg, #5D5CDE 0%, #8B8DF0 100%);
        }
        .gradient-success {
            background: linear-gradient(135deg, #10B981 0%, #34D399 100%);
        }
        .gradient-warning {
            background: linear-gradient(135deg, #F59E0B 0%, #FBBF24 100%);
        }
        .gradient-danger {
            background: linear-gradient(135deg, #EF4444 0%, #F87171 100%);
        }
        
        /* Progress Bar */
        .progress-bar {
            transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Notifications */
        .notification-slide {
            animation: slideInFromTop 0.4s ease-out;
        }
        @keyframes slideInFromTop {
            from { transform: translateY(-100px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        /* Loading Skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
        }
        .dark .skeleton {
            background: linear-gradient(90deg, #374151 25%, #4B5563 50%, #374151 75%);
            background-size: 200% 100%;
        }
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Tooltips */
        .tooltip {
            position: relative;
        }
        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
            z-index: 1000;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .tooltip:hover::after {
            opacity: 1;
        }
        
        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #c1c1c1, #a8a8a8);
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #a8a8a8, #959595);
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, #6B7280, #9CA3AF);
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, #9CA3AF, #D1D5DB);
        }
        
        /* Card Hover Effects */
        .card-hover {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        .dark .card-hover:hover {
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3), 0 10px 10px -5px rgba(0, 0, 0, 0.2);
        }
        
        /* Interactive Elements */
        .interactive-scale {
            transition: transform 0.2s ease-in-out;
        }
        .interactive-scale:hover {
            transform: scale(1.02);
        }
        .interactive-scale:active {
            transform: scale(0.98);
        }
        
        /* Status Indicators */
        .status-dot {
            position: relative;
        }
        .status-dot::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border-radius: 50%;
            animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;
        }
        .status-dot.success::before {
            background-color: #10B981;
        }
        .status-dot.warning::before {
            background-color: #F59E0B;
        }
        .status-dot.danger::before {
            background-color: #EF4444;
        }
        
        /* Data visualization */
        .chart-container {
            position: relative;
            height: min(400px, 50vh);
            min-height: 240px;
            width: 100%;
        }
        
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                font-size: 12px;
            }
        }
        
        /* Novos estilos para melhorias */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .login-container {
            max-width: 400px;
            margin: 2rem auto;
            padding: 2rem;
        }
        
        .equipment-image {
            width: 100%;
            height: auto;
            max-height: 120px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .qr-code {
            width: clamp(80px, 25vw, 120px);
            height: clamp(80px, 25vw, 120px);
            margin: 0 auto;
            display: block;
        }
        
        .inspection-details-modal {
            width: 90vw;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .tire-grid { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:14px; }
        .tire-row { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:8px; align-items:center; }
        .tire-circle { width:44px; height:44px; border-radius:9999px; display:flex; align-items:center; justify-content:center; font-weight:600; border:2px solid #9CA3AF; background:#F9FAFB; color:#111827; }
        .tire-circle.dark { background:#374151; color:#F3F4F6; border-color:#4B5563; }
        .tire-label { font-size:12px; color:#6B7280; text-align:center; }
        .calib-highlight { box-shadow: 0 0 0 2px #5D5CDE inset; border-color: #5D5CDE !important; }
        .map-tabs { display:flex; gap:8px; }
        .map-tab { font-size:12px; padding:6px 10px; border:1px solid #e5e7eb; border-radius:8px; background:#fff; color:#374151; }
        .dark .map-tab { background:#374151; border-color:#4B5563; color:#e5e7eb; }
        .map-tab.active { background:#5D5CDE; color:#fff; border-color:#5D5CDE; }
        .vehicle-body { height:48px; border:2px dashed #9CA3AF; border-radius:10px; background:#F9FAFB; }
        .dark .vehicle-body { border-color:#4B5563; background:#374151; }
        .axle-row { display:grid; grid-template-columns: repeat(3,minmax(0,1fr)); gap:8px; align-items:center; }
        .axle-label { font-size:12px; color:#6B7280; text-align:center; }
        .record-modal { color:#111827; }
        .dark .record-modal { color:#F3F4F6; }
        .record-table { width:100%; border-collapse:collapse; font-size:12px; }
        .record-table th, .record-table td { border:1px solid #e5e7eb; padding:6px; text-align:left; }
        .dark .record-table th, .dark .record-table td { border-color:#4B5563; }
        .muted { color:#6B7280; font-size:12px; }
        .dark .muted { color:#D1D5DB; }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 transition-colors duration-300">
    <!-- Login Modal -->
    <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="glass-morphism p-8 rounded-xl shadow-lg max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-primary rounded-lg flex items-center justify-center mx-auto mb-4">
                    <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                    </svg>
                </div>
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Sistema de Checklist</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Faça login para acessar o sistema</p>
            </div>
            
            <form id="loginForm" data-mode="login">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                    <input type="email" id="loginEmail" required placeholder="Digite seu email" title="Email de acesso" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">

                </div>
                <div class="mb-2">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Senha</label>
                    <input type="password" id="loginPassword" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div class="flex justify-end mb-4">
                    <button type="button" onclick="showForgotPassword()" class="text-sm text-primary hover:text-primary-dark font-medium">Esqueceu a senha?</button>
                </div>

                <div id="firstNameGroup" class="mb-4 hidden">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome</label>
                    <input type="text" id="firstName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <div id="lastNameGroup" class="mb-6 hidden">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sobrenome</label>
                    <input type="text" id="lastName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                <button id="loginSubmit" type="submit" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200 font-medium interactive-scale">
                    Entrar
                </button>
            </form>
            
            <div class="mt-6 text-center">
                <p class="text-sm text-gray-600 dark:text-gray-400">
                    Não tem uma conta? 
                    <button onclick="toggleAuthMode()" class="text-primary hover:text-primary-dark font-medium">Cadastre-se</button>
                </p>
            </div>
        </div>
    </div>

    <!-- Forgot Password Modal -->
    <div id="forgotPasswordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-morphism p-8 rounded-xl shadow-lg max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h2 class="text-xl font-bold text-gray-900 dark:text-white">Recuperar Senha</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Informe seu email para receber o link de recuperação</p>
            </div>
            
            <form id="forgotPasswordForm">
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Email</label>
                    <input type="email" id="forgotEmail" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                </div>
                
                <button type="submit" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200 font-medium">
                    Enviar Link
                </button>
                
                <button type="button" onclick="closeForgotPassword()" class="mt-4 w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
                    Voltar
                </button>
            </form>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="glass-morphism p-8 rounded-xl shadow-lg max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Completar perfil</h2>
                <p class="text-gray-600 dark:text-gray-400 mt-2">Informe seu nome e sobrenome</p>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Nome</label>
                <input type="text" id="pmFirstName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div class="mb-6">
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Sobrenome</label>
                <input type="text" id="pmLastName" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
            </div>
            <div class="flex items-center gap-3">
                <button id="pmSave" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200 font-medium">Salvar</button>
                <button id="pmCancel" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300">Agora não</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="glass-morphism p-6 rounded-lg shadow-lg">
            <div class="flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                <span class="text-gray-900 dark:text-white">Carregando...</span>
            </div>
        </div>
    </div>

    <!-- Main App (inicialmente oculto) -->
    <div id="mainApp" class="hidden">
        <!-- Header -->
        <header class="glass-morphism backdrop-blur-xs shadow-sm border-b border-gray-200 dark:border-gray-700">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center h-16">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center glow">
                            <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h1 class="text-xl font-semibold text-gray-900 dark:text-white">Sistema de Checklist</h1>
                        <span class="ml-2 px-2 py-1 text-xs font-semibold text-primary border border-primary rounded">GGOMES-LOG</span>
                    </div>
                    
                    <div class="flex items-center space-x-4">
                        <div class="text-sm text-gray-500 dark:text-gray-400" id="currentDateTime"></div>
                        <button onclick="toggleTheme()" aria-label="Alternar tema" title="Alternar tema" class="p-2 rounded-md glass-morphism backdrop-blur-xs interactive-scale tooltip" data-tooltip="Alternar tema">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300 inline dark:hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3m15.364-6.364l-1.414 1.414M7.05 16.95l-1.414 1.414m12.728 0l-1.414-1.414M7.05 7.05L5.636 5.636M12 8a4 4 0 100 8 4 4 0 000-8z"/>
                            </svg>
                            <svg class="w-5 h-5 text-gray-300 dark:text-gray-100 hidden dark:inline" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 118.646 3.646a7 7 0 1011.708 11.708z"/>
                            </svg>
                        </button>
                        <button onclick="openSettings()" aria-label="Configurações" title="Configurações" class="p-2 rounded-md glass-morphism backdrop-blur-xs interactive-scale tooltip" data-tooltip="Configurações">
                            <svg class="w-5 h-5 text-gray-700 dark:text-gray-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11.049 2.927c.3-1.14 1.952-1.14 2.252 0a1.724 1.724 0 002.573 1.066c.986-.57 2.23.37 1.995 1.454a1.724 1.724 0 001.051 1.93c1.07.39 1.07 1.92 0 2.31a1.724 1.724 0 00-1.051 1.93c.235 1.083-.999 2.024-1.995 1.454a1.724 1.724 0 00-2.573 1.066c-.3 1.14-1.952 1.14-2.252 0a1.724 1.724 0 00-2.573-1.066c-.996.57-2.23-.37-1.995-1.454a1.724 1.724 0 00-1.051-1.93c-1.07-.39-1.07-1.92 0-2.31.63-.23 1.06-.77 1.051-1.93-.235-1.083.999-2.024 1.995-1.454.87.503 1.973.07 2.573-1.066z"/>
                            </svg>
                        </button>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-700 dark:text-gray-300" id="userEmail"></span>
                            <button onclick="logout()" class="text-sm text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300">
                                Sair
                            </button>
                        </div>
                    </div>
                    <div id="irrChecklistForm" class="hidden mt-6">
                        <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                            <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="irrChecklistTitle">Checklist • Irrigação</h3>
                                <div class="flex items-center gap-3">
                                    <label class="text-sm text-gray-700 dark:text-gray-300">Equipamento em reforma?</label>
                                    <select id="irrReformaStatus" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                        <option value="nao" selected>Não</option>
                                        <option value="sim">Sim</option>
                                    </select>
                                </div>
                            </div>
                            <div class="p-6">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
                                        <input type="date" id="irrDataInspecao" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frota</label>
                                        <div class="flex gap-2">
                                            <select id="irrFrotaSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                                <option value="">Selecione uma frota</option>
                                                <option value="custom">Outro (digitar)</option>
                                            </select>
                                            <button type="button" onclick="showIrrSubsection('equipamentos')" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Gerenciar</button>
                                        </div>
                                        <input type="text" id="irrFrotaCustom" placeholder="Digite a identificação da frota" class="mt-2 hidden w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Líder</label>
                                        <input type="text" id="irrMecanico" placeholder="Nome do líder responsável" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                                <div class="mb-8">
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Itens de Verificação</h4>
                                    <div id="irrChecklistItems" class="space-y-3"></div>
                                </div>
                                <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                                    <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Resultado</h4>
                                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="irrItensOK">0</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Itens OK</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="irrItensNaoOK">0</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Itens NÃO OK</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-2xl font-bold text-primary" id="irrPercentual">0%</div>
                                            <div class="text-sm text-gray-500 dark:text-gray-400">Percentual</div>
                                        </div>
                                        <div class="text-center">
                                            <div class="text-sm font-medium text-gray-900 dark:text-white" id="irrNivelManutencao">Nível de Manutenção: -</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col sm:flex-row gap-3">
                                    <button onclick="clearIrrForm()" class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600">Limpar</button>
                                    <button onclick="saveIrrInspection()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark">Salvar Inspeção</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="glass-morphism backdrop-blur-xs border-b border-gray-200 dark:border-gray-700 sticky top-0 z-40">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center">
                    <div class="flex space-x-8">
                        <button onclick="showSection('dashboard')" class="nav-btn active border-b-2 border-primary text-primary px-1 py-4 text-sm font-medium">
                            Dashboard
                        </button>
                        <button onclick="showSection('cct_coque')" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                            CCT
                        </button>
                        <button onclick="showSection('irrigacao')" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                            IRRIGAÇÃO
                        </button>
                        <button onclick="showSection('historico')" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                            Histórico
                        </button>
                        <button onclick="showSection('global-analytics')" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                            Analytics
                        </button>
                        <button onclick="showSection('relatorios')" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                            Relatórios
                        </button>
                        
                        <button onclick="showSection('equipamentos')" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                            Equipamentos
                        </button>
                        <button onclick="showSection('inventario')" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium">
                            Inventário de Pneus
                        </button>
                        <button onclick="showSection('admin')" id="adminNavBtn" class="nav-btn border-b-2 border-transparent text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-300 px-1 py-4 text-sm font-medium hidden">
                            Admin
                        </button>
                    </div>
                    
                    <!-- Search and Quick Actions -->
                    <div class="flex items-center space-x-4">
                        <div class="relative">
                            <input type="text" id="globalSearch" placeholder="Buscar inspeções..." class="w-full sm:w-64 px-4 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                            <svg class="absolute right-3 top-2.5 h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                        </div>
                        <button onclick="showNotificationCenter()" aria-label="Notificações" title="Notificações" class="relative p-2 text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                            <span id="notificationBadge" class="absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center hidden">3</span>
                        </button>
                        <button onclick="exportData()" aria-label="Exportar dados" title="Exportar dados" class="tooltip px-3 py-2 text-sm bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors duration-200 interactive-scale" data-tooltip="Exportar dados">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3M3 17V7a2 2 0 012-2h6l2 2h6a2 2 0 012 2v10a2 2 0 01-2 2H5a2 2 0 01-2-2z"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Notification Center -->
        <div id="notificationCenter" class="hidden fixed top-16 right-4 z-50 w-full max-w-sm glass-morphism shadow-2xl rounded-xl border border-gray-200 dark:border-gray-700 max-h-96 overflow-hidden">
            <div class="p-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Notificações</h3>
                <div class="flex items-center gap-3">
                    <button onclick="markAllNotificationsRead()" class="text-sm text-gray-600 dark:text-gray-300 hover:text-gray-800 dark:hover:text-white">Marcar como lidas</button>
                    <button onclick="clearAllNotifications()" class="text-sm text-primary hover:text-primary-dark">Limpar todas</button>
                </div>
            </div>
            <div id="notificationList" class="max-h-80 overflow-y-auto custom-scrollbar p-2">
                <!-- Notifications will be populated here -->
            </div>
        </div>

        <!-- Settings Modal -->
        <div id="settingsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
            <div class="glass-morphism p-6 rounded-xl shadow-2xl w-full max-w-sm mx-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Configurações</h3>
                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tema</label>
                <select id="themeModeSelect" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    <option value="system">Sistema</option>
                    <option value="light">Claro</option>
                    <option value="dark">Escuro</option>
                </select>
                <div class="mt-6 flex justify-end gap-2">
                    <button onclick="closeModal('settingsModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 interactive-scale">Cancelar</button>
                    <button onclick="applyThemeChoice()" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark interactive-scale">Aplicar</button>
                </div>
            </div>
        </div>

        <!-- Floating Notification Container -->
        <div id="notificationContainer" class="fixed top-4 right-4 z-50 space-y-3 glass-morphism p-2 rounded-xl"></div>
        <div id="mobileActionBar" class="fixed bottom-0 inset-x-0 z-40 bg-white dark:bg-gray-800 border-t border-gray-200 dark:border-gray-700 px-4 py-3 flex items-center justify-between sm:hidden hidden">
            <div class="flex items-center gap-3">
                <button onclick="backToSelection()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300">Voltar</button>
                <span id="mobileSummary" class="text-sm text-gray-700 dark:text-gray-300"></span>
            </div>
            <button id="mobileSaveBtn" onclick="saveInspection()" class="px-6 py-2 bg-primary text-white rounded-md interactive-scale">Salvar</button>
        </div>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- Dashboard Section -->
            <section id="dashboard" class="section-content">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Dashboard</h2>
                    <p class="text-gray-600 dark:text-gray-400">Visão geral das inspeções e manutenções</p>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total de Inspeções</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="totalInspecoes">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Inspeções Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="inspecoesHoje">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Equipamentos Ativos</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="equipamentosAtivos">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Nível Médio</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="nivelMedio">0%</p>
                                </div>
                                <div class="ml-auto">
                                    <svg width="48" height="48">
                                        <circle stroke="#e5e7eb" stroke-width="6" fill="transparent" r="20" cx="24" cy="24"></circle>
                                        <circle id="nivelMedioCircle" stroke="#10B981" stroke-width="6" fill="transparent" r="20" cx="24" cy="24" stroke-dasharray="125.6" stroke-dashoffset="125.6"></circle>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700">
                        <div class="p-6">
                            <div class="flex items-center">
                                <div class="flex-shrink-0">
                                    <div class="w-10 h-10 bg-teal-100 dark:bg-teal-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-6 h-6 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Taxa Hoje</p>
                                    <p class="text-2xl font-bold text-gray-900 dark:text-white" id="taxaHoje">0%</p>
                                </div>
                                <div class="ml-auto">
                                    <svg width="48" height="48">
                                        <circle stroke="#e5e7eb" stroke-width="6" fill="transparent" r="20" cx="24" cy="24"></circle>
                                        <circle id="taxaHojeCircle" stroke="#10B981" stroke-width="6" fill="transparent" r="20" cx="24" cy="24" stroke-dasharray="125.6" stroke-dashoffset="125.6"></circle>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="mb-4 flex justify-end">
                    <select id="dashboardChartPeriod" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                        <option value="7" selected>Últimos 7 dias</option>
                        <option value="15">Últimos 15 dias</option>
                        <option value="30">Últimos 30 dias</option>
                        <option value="90">Últimos 90 dias</option>
                    </select>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Volume de Inspeções</h3>
                        <div class="chart-container" style="height: 300px;">
                            <canvas id="weeklyInspectionsChart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Status das Inspeções</h3>
                        <div class="chart-container flex justify-center" style="height: 300px;">
                            <canvas id="inspectionStatusChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Critical Alerts & Recent Inspections -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Critical Alerts -->
                    <div class="lg:col-span-1 bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 bg-red-50 dark:bg-red-900/20">
                            <h3 class="text-lg font-semibold text-red-700 dark:text-red-400 flex items-center gap-2">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"/>
                                </svg>
                                Atenção Necessária
                            </h3>
                        </div>
                        <div class="p-6">
                            <div id="criticalAlerts" class="space-y-4">
                                <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                                    <p>Nenhum alerta crítico no momento</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Equipment Breakdown -->
                    <div class="lg:col-span-1 bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Frota Ativa</h3>
                        </div>
                        <div class="p-6 space-y-4">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                        </svg>
                                    </div>
                                    <span class="text-gray-900 dark:text-white font-medium">Colhedoras</span>
                                </div>
                                <span class="text-2xl font-bold text-gray-900 dark:text-white" id="countColhedoras">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-teal-100 dark:bg-teal-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12M6 12h12"/>
                                        </svg>
                                    </div>
                                    <span class="text-gray-900 dark:text-white font-medium">Plantadoras</span>
                                </div>
                                <span class="text-2xl font-bold text-gray-900 dark:text-white" id="countPlantadoras">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-cyan-100 dark:bg-cyan-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
                                        </svg>
                                    </div>
                                    <span class="text-gray-900 dark:text-white font-medium">Distribuidoras</span>
                                </div>
                                <span class="text-2xl font-bold text-gray-900 dark:text-white" id="countDistribuidoras">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2v0a2 2 0 01-2-2v-2a2 2 0 00-2-2H8z"/>
                                        </svg>
                                    </div>
                                    <span class="text-gray-900 dark:text-white font-medium">Reboques</span>
                                </div>
                                <span class="text-2xl font-bold text-gray-900 dark:text-white" id="countReboques">0</span>
                            </div>
                            <div class="flex items-center justify-between">
                                <div class="flex items-center space-x-3">
                                    <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M6 11h12M8 15h8"/>
                                        </svg>
                                    </div>
                                    <span class="text-gray-900 dark:text-white font-medium">Transbordos</span>
                                </div>
                                <span class="text-2xl font-bold text-gray-900 dark:text-white" id="countTransbordo">0</span>
                            </div>
                        </div>
                    </div>

                    <!-- Recent Inspections Table -->
                    <div class="lg:col-span-1 bg-white dark:bg-gray-800 overflow-hidden shadow-sm rounded-xl border border-gray-200 dark:border-gray-700 card-hover">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex justify-between items-center">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Últimas</h3>
                            <button onclick="showSection('historico')" class="text-sm text-primary hover:text-primary-dark font-medium">Ver todas</button>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <tbody id="recentInspectionsTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                    <!-- Rows populated by JS -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="irrigacao" class="section-content hidden">
                <div class="mb-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">IRRIGAÇÃO</h2>
                            <p class="text-gray-600 dark:text-gray-400">Operações e análise do módulo de irrigação</p>
                        </div>
                    </div>
                </div>
                <div class="mb-6">
                    <div class="flex flex-wrap gap-3">
                        <button onclick="showIrrSubsection('inicio')" class="irr-sub-btn px-3 py-2 text-sm border-b-2 border-primary text-primary">Nova Inspeção</button>
                        <button onclick="showIrrSubsection('historico')" class="irr-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Histórico</button>
                        <button onclick="showIrrSubsection('analytics')" class="irr-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Analytics</button>
                        <button onclick="showIrrSubsection('relatorios')" class="irr-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Relatórios</button>
                        <button onclick="showIrrSubsection('equipamentos')" class="irr-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Equipamentos</button>
                    </div>
                </div>
                <div id="irr-sub-inicio" class="">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Nova Inspeção • Irrigação</h3>
                        <div id="irrEquipCards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4">
                          <div onclick="selectIrrEquipment('motobombas')" class="equipment-card bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200 h-[116px] flex items-center">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-rose-100 dark:bg-rose-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-rose-600 dark:text-rose-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4a7 7 0 100 14h6a3 3 0 000-6h-1a4 4 0 01-4-4V4z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-base font-semibold text-gray-900 dark:text-white">MotoBombas</h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Checklist detalhado conforme PDF</p>
                                    </div>
                                </div>
                          </div>
                          <div onclick="selectIrrEquipment('hidroroll')" class="equipment-card bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200 h-[116px] flex items-center">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h10M4 17h8"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-base font-semibold text-gray-900 dark:text-white">Hidro Roll</h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Checklist detalhado conforme PDF</p>
                                    </div>
                                </div>
                          </div>
                          <div onclick="selectIrrEquipment('caminhoes')" class="equipment-card bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200 h-[116px] flex items-center">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 13h13l3 3v3H3v-6zM16 6h3l2 5H16V6z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-base font-semibold text-gray-900 dark:text-white">Caminhões</h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Checklist dos caminhões de irrigação</p>
                                    </div>
                                </div>
                          </div>
                          <div onclick="selectIrrEquipment('tanques')" class="equipment-card bg-white dark:bg-gray-800 p-5 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200 h-[116px] flex items-center">
                                <div class="flex items-center space-x-4">
                                    <div class="w-10 h-10 bg-emerald-100 dark:bg-emerald-900 rounded-lg flex items-center justify-center">
                                        <svg class="w-5 h-5 text-emerald-600 dark:text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16v10H4zM6 9h12v6H6z"/></svg>
                                    </div>
                                    <div>
                                        <h3 class="text-base font-semibold text-gray-900 dark:text-white">Tanques</h3>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">Checklist de tanques de irrigação</p>
                                    </div>
                                </div>
                          </div>
                        </div>
                    </div>
                </div>
                <div id="irr-sub-historico" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Histórico • Irrigação</h3>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo</label>
                                <select id="irrFiltroTipo" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="">Todos</option>
                                    <option value="motobombas">MotoBombas</option>
                                    <option value="hidroroll">Hidro Roll</option>
                                    <option value="caminhoes">Caminhões</option>
                                    <option value="tanques">Tanques</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Inicial</label>
                                <input type="date" id="irrFiltroDataInicial" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Final</label>
                                <input type="date" id="irrFiltroDataFinal" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="flex items-end">
                                <button onclick="filterIrrHistory()" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark">Filtrar</button>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                                <thead class="bg-gray-50 dark:bg-gray-700">
                                    <tr>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Data</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Tipo</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Frota</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Líder</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">% OK</th>
                                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="irrHistoryBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="irr-sub-analytics" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Analytics • Irrigação</h3>
                            <div class="flex flex-wrap items-center gap-3">
                                <select id="irrChartPeriod" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30" selected>Últimos 30 dias</option>
                                    <option value="90">Últimos 90 dias</option>
                                </select>
                                <select id="irrEquipmentFilter" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="all" selected>Todos equipamentos</option>
                                    <option value="motobombas">MotoBombas</option>
                                    <option value="hidroroll">Hidro Roll</option>
                                    <option value="caminhoes">Caminhões</option>
                                    <option value="tanques">Tanques</option>
                                </select>
                                <select id="irrLeaderFilter" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="all" selected>Todos líderes</option>
                                </select>
                                <button onclick="clearIrrAnalyticsFilters()" class="text-sm px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Limpar</button>
                                <button onclick="updateIrrAnalytics(); updateIrrAnalyticsSummary();" class="text-sm px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Atualizar</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                            <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-blue-100 text-sm font-medium">Taxa de Aprovação</p>
                                        <p class="text-3xl font-bold" id="irrApprovalRate">0%</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-green-100 text-sm font-medium">Tempo Médio</p>
                                        <p class="text-3xl font-bold" id="irrAvgTime">0min</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-yellow-100 text-sm font-medium">Críticos</p>
                                        <p class="text-3xl font-bold" id="irrCriticalCountCard">0</p>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-purple-100 text-sm font-medium">Produtividade</p>
                                        <p class="text-3xl font-bold" id="irrProductivity">0%</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                            <div class="relative h-40 sm:h-64">
                                <canvas id="irrPerformanceChart"></canvas>
                            </div>
                            <div class="relative h-40 sm:h-64">
                                <canvas id="irrEquipmentChart"></canvas>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                            <div class="xl:col-span-2 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                                <div class="flex items-center justify-between mb-6">
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Problemas Críticos</h3>
                                    <span id="irrCriticalCountBadge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">0 ativos</span>
                                </div>
                                <div class="space-y-4" id="irrCriticalIssues"></div>
                            </div>
                            <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Top Líderes</h3>
                                <div class="space-y-4" id="irrTopMecanicos"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="irr-sub-relatorios" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Relatórios • Irrigação</h3>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="lg:col-span-2">
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Relatório</label>
                                        <select id="irrReportType" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="geral" selected>Relatório Geral</option>
                                            <option value="equipamento">Por Equipamento</option>
                                            <option value="mecanico">Por Líder</option>
                                            <option value="periodo">Por Período</option>
                                            <option value="criticos">Problemas Críticos</option>
                                            <option value="maintenance">Manutenções (Itens NÃO OK)</option>
                                            <option value="performance">Performance (Itens OK)</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Período</label>
                                        <select id="irrReportPeriod" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="7">Últimos 7 dias</option>
                                            <option value="30" selected>Últimos 30 dias</option>
                                            <option value="90">Últimos 90 dias</option>
                                            <option value="custom">Personalizado</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Formato</label>
                                        <select id="irrReportFormat" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="csv" selected>CSV</option>
                                            <option value="excel">Excel</option>
                                            <option value="pdf">PDF</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Equipamento</label>
                                        <select id="irrReportEqType" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                            <option value="all">Todos</option>
                                            <option value="motobombas">MotoBombas</option>
                                            <option value="hidroroll">Hidro Roll</option>
                                            <option value="tortao">Tortão</option>
                                        </select>
                                    </div>
                                    <div class="flex items-end gap-3">
                                        <button onclick="generateIrrReport()" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark">Gerar Relatório</button>
                                        <button onclick="scheduleIrrReport()" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Agendar Envio</button>
                                    </div>
                                </div>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 border border-gray-200 dark:border-gray-700">
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white mb-4">Atalhos</h4>
                                <div class="grid grid-cols-1 gap-3">
                                    <button onclick="generateIrrQuickReport('resumo')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Resumo</button>
                                    <button onclick="generateIrrQuickReport('detalhado')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Detalhado</button>
                                    <button onclick="generateIrrQuickReport('equipamentos')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Equipamentos</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateIrrQuickReport('summary')">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-400 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Resumo Executivo</h3>
                                    <p class="text-blue-200 text-sm">Visão geral das operações</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateIrrQuickReport('performance')">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-400 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Performance</h3>
                                    <p class="text-green-200 text-sm">Análise de produtividade</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateIrrQuickReport('maintenance')">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-red-400 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.268 16.5c-.77.833.192 2.5 1.732 2.5z"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Manutenções</h3>
                                    <p class="text-red-200 text-sm">Relatório de problemas</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateIrrQuickReport('trends')">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-purple-400 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Tendências</h3>
                                    <p class="text-purple-200 text-sm">Análise temporal</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateIrrQuickReport('compliance')">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-yellow-400 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Conformidade</h3>
                                    <p class="text-yellow-200 text-sm">Relatório de compliance</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateIrrQuickReport('costs')">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-indigo-400 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold">Custos</h3>
                                    <p class="text-indigo-200 text-sm">Análise financeira</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="irr-sub-equipamentos" class="hidden">
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Equipamentos • Irrigação</h3>
                        <p class="text-gray-600 dark:text-gray-400">Cadastro e gestão de equipamentos de irrigação, separados do CCT.</p>
                    </div>
                </div>
            </section>

            <!-- CCT e Coque Section -->
            <section id="cct_coque" class="section-content hidden">
                <div class="mb-6">
                    <div class="flex flex-wrap gap-3">
                        <button onclick="showCCTSubsection('inicio')" class="cct-sub-btn px-3 py-2 text-sm border-b-2 border-primary text-primary">Início</button>
                        <button onclick="showCCTSubsection('historico')" class="cct-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Histórico</button>
                        <button onclick="showCCTSubsection('analytics')" class="cct-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Analytics</button>
                        <button onclick="showCCTSubsection('relatorios')" class="cct-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Relatórios</button>
                        <button onclick="showCCTSubsection('equipamentos')" class="cct-sub-btn px-3 py-2 text-sm border-b-2 border-transparent text-gray-600 dark:text-gray-300">Equipamentos</button>
                    </div>
                </div>
                <div id="cct-sub-historico" class="hidden"></div>
                <div id="cct-sub-analytics" class="hidden"></div>
                <div id="cct-sub-relatorios" class="hidden"></div>
                <div id="cct-sub-equipamentos" class="hidden"></div>
                <div id="equipmentSelection">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Nova Inspeção</h2>
                        <p class="text-gray-600 dark:text-gray-400">Selecione o tipo de equipamento para iniciar a inspeção</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div onclick="selectFromCCT('caminhao')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2v0a2 2 0 01-2-2v-2a2 2 0 00-2-2H8z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Caminhão</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist completo para liberação de caminhões</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectFromCCT('trator')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Trator</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist para liberação de tratores agrícolas</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectFromCCT('colhedora')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Colhedora</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist para colhedoras de cana</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectFromCCT('plantadora')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-teal-100 dark:bg-teal-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12M6 12h12"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Plantadora de Cana</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist de reforma/entressafra</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectFromCCT('distribuidora')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-cyan-100 dark:bg-cyan-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Distribuidora de Cana</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist de reforma/entressafra</p>
                                </div>
                            </div>
                        </div>


                        <div onclick="selectFromCCT('cobridores')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-fuchsia-100 dark:bg-fuchsia-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-fuchsia-600 dark:text-fuchsia-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12M6 12h12"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Cobridores</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist de reforma/entressafra</p>
                                </div>
                            </div>
                        </div>


                        <div onclick="selectFromCCT('reboque')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2v0a2 2 0 01-2-2v-2a2 2 0 00-2-2H8z"/>
                                        </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reboque</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist para reboques e semi-reboques</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectFromCCT('transbordo')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v6H4zM4 14h16v6H4z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Transbordo</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist de manutenção de transbordos</p>
                                </div>
                            </div>
                        </div>
                        <div onclick="selectFromCCT('tortao')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-red-100 dark:bg-red-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12M6 12h12"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Tortão</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist conforme PDF, por seção</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="checklistForm" class="hidden">
                    <div class="mb-6">
                        <button onclick="backToSelection()" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Voltar à seleção
                        </button>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="checklistTitle">Checklist</h3>
                            <div class="flex items-center gap-3">
                                <label class="text-sm text-gray-700 dark:text-gray-300">Equipamento em reforma?</label>
                                <select id="reformaStatus" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="nao" selected>Não</option>
                                    <option value="sim">Sim</option>
                                </select>
                            </div>
                        </div>
                        <div class="p-6">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
                                    <input type="date" id="dataInspecao" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frota</label>
                                    <div class="flex gap-2">
                                        <select id="frotaSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="">Selecione uma frota</option>
                                            <option value="custom">Outro (digitar)</option>
                                        </select>
                                        <button type="button" onclick="showSection('equipamentos')" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Gerenciar</button>
                                    </div>
                                    <input type="text" id="frotaCustom" placeholder="Digite a identificação da frota" class="mt-2 hidden w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Líder</label>
                                    <input type="text" id="mecanico" placeholder="Nome do líder responsável" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                            </div>
                            <div class="mb-8">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Itens de Verificação</h4>
                                <div id="checklistItems" class="space-y-3"></div>
                            </div>
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Resultado da Inspeção</h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="itensOK">0</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Itens OK</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="itensNaoOK">0</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Itens NÃO OK</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-primary" id="percentual">0%</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Percentual</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" id="nivelManutencao">Nível de Manutenção: -</div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button onclick="clearForm()" class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200">Limpar</button>
                                <button onclick="saveInspection()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duração-200 font-medium interactive-scale">Salvar Inspeção</button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Nova Inspeção Section -->
            <section id="nova-inspecao-deprecated" class="section-content hidden">
                <!-- Equipment Selection -->
                <div id="equipmentSelection">
                    <div class="mb-8">
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Nova Inspeção</h2>
                        <p class="text-gray-600 dark:text-gray-400">Selecione o tipo de equipamento para iniciar a inspeção</p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div onclick="selectEquipment('caminhao')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2v0a2 2 0 01-2-2v-2a2 2 0 00-2-2H8z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Caminhão</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist completo para liberação de caminhões</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectEquipment('trator')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-green-100 dark:bg-green-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Trator</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist para liberação de tratores agrícolas</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectEquipment('colhedora')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Colhedora</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist para colhedoras de cana</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectEquipment('plantadora')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-teal-100 dark:bg-teal-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-teal-600 dark:text-teal-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v12M6 12h12"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Plantadora de Cana</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist de reforma/entressafra</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectEquipment('distribuidora')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-cyan-100 dark:bg-cyan-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-cyan-600 dark:text-cyan-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Distribuidora de Cana</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist de reforma/entressafra</p>
                                </div>
                            </div>
                        </div>

                        <div onclick="selectEquipment('reboque')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-yellow-100 dark:bg-yellow-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2v0a2 2 0 01-2-2v-2a2 2 0 00-2-2H8z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Reboque</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist para reboques e semi-reboques</p>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div onclick="selectEquipment('transbordo')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-orange-100 dark:bg-orange-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4h16v6H4zM4 14h16v6H4z"/>
                                    </svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Transbordo</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Checklist de manutenção de transbordos</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checklist Form -->
                <div id="checklistForm" class="hidden">
                    <div class="mb-6">
                        <button onclick="backToSelection()" class="inline-flex items-center px-4 py-2 text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-800 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
                            </svg>
                            Voltar à seleção
                        </button>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                        <div class="px-6 py-4 border-b border-gray-200 dark:border-gray-700 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white" id="checklistTitle">Checklist</h3>
                            <div class="flex items-center gap-3">
                                <label class="text-sm text-gray-700 dark:text-gray-300">Equipamento em reforma?</label>
                                <select id="reformaStatus" class="px-3 py-1 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="nao" selected>Não</option>
                                    <option value="sim">Sim</option>
                                </select>
                            </div>
                        </div>
                <div class="p-6">
                    <!-- Form Fields -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
                                    <input type="date" id="dataInspecao" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frota</label>
                                    <div class="flex gap-2">
                                        <select id="frotaSelect" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                            <option value="">Selecione uma frota</option>
                                            <option value="custom">Outro (digitar)</option>
                                        </select>
                                        <button type="button" onclick="showSection('equipamentos')" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Gerenciar</button>
                                    </div>
                                    <input type="text" id="frotaCustom" placeholder="Digite a identificação da frota" class="mt-2 hidden w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Líder</label>
                            <input type="text" id="mecanico" placeholder="Nome do líder responsável" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                    </div>

                            <!-- Checklist Items -->
                            <div class="mb-8">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Itens de Verificação</h4>
                                <div id="checklistItems" class="space-y-3">
                                    <!-- Dynamic checklist items will be inserted here -->
                                </div>
                            </div>

                            <!-- Results Summary -->
                            <div class="bg-gray-50 dark:bg-gray-900 rounded-lg p-6 mb-6">
                                <h4 class="text-lg font-medium text-gray-900 dark:text-white mb-4">Resultado da Inspeção</h4>
                                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-green-600 dark:text-green-400" id="itensOK">0</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Itens OK</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-red-600 dark:text-red-400" id="itensNaoOK">0</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Itens NÃO OK</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-2xl font-bold text-primary" id="percentual">0%</div>
                                        <div class="text-sm text-gray-500 dark:text-gray-400">Percentual</div>
                                    </div>
                                    <div class="text-center">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white" id="nivelManutencao">Nível de Manutenção: -</div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button onclick="clearForm()" class="px-6 py-3 text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md hover:bg-gray-50 dark:hover:bg-gray-600 transition-colors duration-200">
                                    Limpar
                                </button>
                                <button onclick="saveInspection()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200 font-medium interactive-scale">
                                    Salvar Inspeção
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="admin" class="section-content hidden">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Admin</h2>
                    <p class="text-gray-600 dark:text-gray-400">Gerencie emails restritos e seções que podem visualizar.</p>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Cadastrar/Editar</h3>
                        <div class="space-y-3">
                            <input id="adminEmailInput" type="email" placeholder="email@dominio.com" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400" />
                            <div>
                                <p class="text-sm text-gray-700 dark:text-gray-300 mb-2">Seções permitidas</p>
                                <div class="space-y-3 text-gray-700 dark:text-gray-200" id="adminSectionsSelect">
                                    <div>
                                        <p class="text-xs font-medium text-gray-600 dark:text-gray-300">CCT</p>
                                        <div class="flex flex-wrap gap-3 mt-1">
                                            <label class="inline-flex items-center"><input type="checkbox" value="cct_coque" class="form-checkbox"><span class="ml-2 text-sm">CCT</span></label>
                                        </div>
                                        <div id="adminSectionsCCTDetail" class="mt-2 pl-3 border-l border-gray-200 dark:border-gray-700 hidden">
                                            <p class="text-xs text-gray-600 dark:text-gray-300">Funções CCT</p>
                                            <div class="flex flex-wrap gap-3 mt-1">
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="cct" value="historico" class="form-checkbox"><span class="ml-2 text-sm">Histórico</span></label>
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="cct" value="analytics" class="form-checkbox"><span class="ml-2 text-sm">Analytics</span></label>
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="cct" value="relatorios" class="form-checkbox"><span class="ml-2 text-sm">Relatórios</span></label>
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="cct" value="equipamentos" class="form-checkbox"><span class="ml-2 text-sm">Equipamentos</span></label>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs font-medium text-gray-600 dark:text-gray-300">IRRIGAÇÃO</p>
                                        <div class="flex flex-wrap gap-3 mt-1">
                                            <label class="inline-flex items-center"><input type="checkbox" value="irrigacao" class="form-checkbox"><span class="ml-2 text-sm">Irrigação</span></label>
                                        </div>
                                        <div id="adminSectionsIRRDetail" class="mt-2 pl-3 border-l border-gray-200 dark:border-gray-700 hidden">
                                            <p class="text-xs text-gray-600 dark:text-gray-300">Funções Irrigação</p>
                                            <div class="flex flex-wrap gap-3 mt-1">
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="irr" value="equipamentos" class="form-checkbox"><span class="ml-2 text-sm">Equipamentos</span></label>
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="irr" value="historico" class="form-checkbox"><span class="ml-2 text-sm">Histórico</span></label>
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="irr" value="analytics" class="form-checkbox"><span class="ml-2 text-sm">Analytics</span></label>
                                                <label class="inline-flex items-center"><input type="checkbox" data-section="irr" value="relatorios" class="form-checkbox"><span class="ml-2 text-sm">Relatórios</span></label>
                                            </div>
                                        </div>
                                    </div>
                                    <div>
                                        <p class="text-xs font-medium text-gray-600 dark:text-gray-300">GLOBAL</p>
                                        <div class="flex flex-wrap gap-3 mt-1">
                                            <label class="inline-flex items-center"><input type="checkbox" value="dashboard" class="form-checkbox"><span class="ml-2 text-sm">Dashboard</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="nova-inspecao" class="form-checkbox"><span class="ml-2 text-sm">Nova Inspeção</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="equipamentos" class="form-checkbox"><span class="ml-2 text-sm">Equipamentos</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="inventario" class="form-checkbox"><span class="ml-2 text-sm">Inventário de Pneus</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="calibragem" class="form-checkbox"><span class="ml-2 text-sm">Calibragem</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="controle3p" class="form-checkbox"><span class="ml-2 text-sm">Controle 3P</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="historico_pneus" class="form-checkbox"><span class="ml-2 text-sm">Histórico de Pneus</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="historico" class="form-checkbox"><span class="ml-2 text-sm">Histórico</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="analytics" class="form-checkbox"><span class="ml-2 text-sm">Analytics</span></label>
                                            <label class="inline-flex items-center"><input type="checkbox" value="relatorios" class="form-checkbox"><span class="ml-2 text-sm">Relatórios</span></label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="flex gap-3">
                                <button id="adminSaveRuleBtn" class="px-4 py-2 bg-primary text-white rounded-md">Salvar Regra</button>
                                <button id="adminClearBtn" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300">Limpar</button>
                                <button id="adminDiagnoseBtn" class="px-4 py-2 bg-yellow-600 text-white rounded-md">Diagnosticar tabela</button>
                            </div>
                            <div id="adminAccessControlsStatus" class="text-xs text-gray-600 dark:text-gray-300"></div>
                        </div>
                    </div>
                    <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Emails restritos</h3>
                        <div id="adminRulesList" class="space-y-2"></div>
                    </div>
                    <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Atualização do Sistema</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Enviar aviso e atualizar páginas dos usuários.</p>
                        <div class="space-y-3 mb-4">
                            <input id="adminUpdateMessage" type="text" placeholder="NOVA ATUALIZAÇÃO DO SISTEMA" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                            <label class="inline-flex items-center text-sm text-gray-700 dark:text-gray-300">
                                <input id="adminRequireConfirm" type="checkbox" class="form-checkbox">
                                <span class="ml-2">Usuários devem confirmar atualização</span>
                            </label>
                        </div>
                        <button id="adminForceRefreshBtn" class="px-4 py-2 bg-red-600 text-white rounded-md">Forçar atualização dos usuários</button>
                    </div>
                    <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Usuários</h3>
                        <div id="adminUsersList" class="space-y-2"></div>
                    </div>
                    <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Guia: Tabela de Usuários (SQL)</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Se os usuários não aparecem, copie e execute este SQL no Supabase.</p>
                        <div class="flex gap-3">
                            <button id="adminCopyUsersSqlBtn" class="px-4 py-2 bg-primary text-white rounded-md">Copiar SQL de criação</button>
                            <button id="adminCopyAuthSyncSqlBtn" class="px-4 py-2 bg-yellow-600 text-white rounded-md">Copiar SQL de migração (auth→users)</button>
                            <button id="adminRunAuthSyncBtn" class="px-4 py-2 bg-green-600 text-white rounded-md">Executar sincronização</button>
                        </div>
                    </div>
                    <div class="p-6 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-xl">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Guia: Regras de Acesso (SQL)</h3>
                        <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Se ao salvar regras aparecer erro da tabela <code>access_controls</code>, copie e execute este SQL no Supabase.</p>
                        <div class="flex gap-3">
                            <button id="adminCopyAccessControlsSqlBtn" class="px-4 py-2 bg-primary text-white rounded-md">Copiar SQL de criação</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Histórico Section -->
            <section id="historico" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Histórico de Inspeções</h2>
                    <p class="text-gray-600 dark:text-gray-400">Consulte e gerencie inspeções anteriores</p>
                </div>

                <!-- Filters -->
                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 mb-6">
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Equipamento</label>
                            <select id="filtroTipo" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="">Todos</option>
                                <option value="caminhao">Caminhão</option>
                                <option value="trator">Trator</option>
                                <option value="colhedora">Colhedora</option>
                                <option value="plantadora">Plantadora</option>
                                <option value="distribuidora">Distribuidora</option>
                                <option value="reboque">Reboque</option>
                                <option value="transbordo">Transbordo</option>
                                <option value="tortao">Tortão</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Inicial</label>
                            <input type="date" id="filtroDataInicial" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data Final</label>
                            <input type="date" id="filtroDataFinal" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div class="flex items-end">
                            <button onclick="filterHistory()" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200">
                                Filtrar
                            </button>
                        </div>
                    </div>
                </div>

                <!-- History Table -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Data</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Equipamento</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Frota</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Líder</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Status</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Nível</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-400 uppercase tracking-wider">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody" class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                                <tr>
                                    <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                                        <svg class="mx-auto h-12 w-12 text-gray-300 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                                        </svg>
                                        Nenhuma inspeção encontrada
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Analytics Section -->
            <section id="global-analytics" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-3">Analytics Avançado</h2>
                    <p class="text-gray-600 dark:text-gray-400">Insights detalhados sobre performance e tendências</p>
                </div>

                <!-- Advanced Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-blue-100 text-sm font-medium">Taxa de Aprovação</p>
                                <p class="text-3xl font-bold" id="approvalRate">85%</p>
                                <p class="text-blue-200 text-xs mt-1">↑ 12% vs mês anterior</p>
                            </div>
                            <div class="w-12 h-12 bg-blue-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-green-100 text-sm font-medium">Tempo Médio</p>
                                <p class="text-3xl font-bold" id="avgTime">15min</p>
                                <p class="text-green-200 text-xs mt-1">↓ 5min vs mês anterior</p>
                            </div>
                            <div class="w-12 h-12 bg-green-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-yellow-100 text-sm font-medium">Críticos</p>
                                <p class="text-3xl font-bold" id="criticalCountCard">3</p>
                                <p class="text-yellow-200 text-xs mt-1">Requerem atenção</p>
                            </div>
                            <div class="w-12 h-12 bg-yellow-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.268 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white card-hover">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-purple-100 text-sm font-medium">Produtividade</p>
                                <p class="text-3xl font-bold" id="productivity">92%</p>
                                <p class="text-purple-200 text-xs mt-1">Meta: 90%</p>
                            </div>
                            <div class="w-12 h-12 bg-purple-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                    <!-- Performance Chart -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 card-hover">
                        <div class="flex flex-wrap items-center justify-between gap-3 mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Performance Mensal</h3>
                            <div class="flex flex-wrap items-center gap-3">
                                <select id="chartPeriod" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30" selected>Últimos 30 dias</option>
                                    <option value="90">Últimos 90 dias</option>
                                </select>
                        <select id="equipmentFilter" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                            <option value="all" selected>Todos equipamentos</option>
                            <option value="caminhao">Caminhão</option>
                            <option value="trator">Trator</option>
                            <option value="colhedora">Colhedora</option>
                            <option value="reboque">Reboque</option>
                            <option value="plantadora">Plantadora</option>
                            <option value="distribuidora">Distribuidora</option>
                            <option value="transbordo">Transbordo</option>
                            <option value="tortao">Tortão</option>
                        </select>
                                <select id="leaderFilter" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="all" selected>Todos líderes</option>
                                </select>
                                <button id="clearAnalyticsFilters" class="text-sm px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Limpar</button>
                            </div>
                        </div>
                        <div class="relative h-40 sm:h-64">
                            <canvas id="performanceChart"></canvas>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button onclick="downloadChart('performanceChart', 'performance')" class="text-xs px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Baixar gráfico</button>
                        </div>
                    </div>

                    <!-- Equipment Distribution Chart -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 card-hover">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Distribuição por Equipamento</h3>
                        <div class="relative h-40 sm:h-64">
                            <canvas id="equipmentChart"></canvas>
                        </div>
                        <div class="mt-3 flex justify-end">
                            <button onclick="downloadChart('equipmentChart', 'equipamentos')" class="text-xs px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Baixar gráfico</button>
                        </div>
                    </div>
                </div>

                <!-- Detailed Analytics -->
                <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                    <!-- Critical Issues -->
                    <div class="xl:col-span-2 bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 card-hover">
                        <div class="flex items-center justify-between mb-6">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Problemas Críticos</h3>
                            <span id="criticalCountBadge" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">0 ativos</span>
                        </div>
                        <div class="space-y-4" id="criticalIssues">
                            <div class="flex items-start space-x-3 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-red-100 dark:bg-red-900 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-red-600 dark:text-red-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">Caminhão FR-001</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Sistema de freios apresentando falha crítica</p>
                                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">2 horas atrás</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3 p-4 bg-yellow-50 dark:bg-yellow-900/20 rounded-lg">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">Trator TR-203</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Sistema hidráulico com vazamento</p>
                                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">4 horas atrás</p>
                                </div>
                            </div>
                            
                            <div class="flex items-start space-x-3 p-4 bg-orange-50 dark:bg-orange-900/20 rounded-lg">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-orange-100 dark:bg-orange-900 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-orange-600 dark:text-orange-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">Colhedora CL-105</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Sistema de corte necessita manutenção urgente</p>
                                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">6 horas atrás</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Top Performers -->
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 card-hover">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Top Líderes</h3>
                        <div class="space-y-4" id="topMecanicos">
                            <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                                        <span class="text-green-600 dark:text-green-400 font-bold text-sm">1</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">João Silva</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">28 inspeções</p>
                                    </div>
                                </div>
                                <span class="text-green-600 dark:text-green-400 font-bold">96%</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-blue-50 dark:bg-blue-900/20 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 dark:text-blue-400 font-bold text-sm">2</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">Carlos Santos</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">22 inspeções</p>
                                    </div>
                                </div>
                                <span class="text-blue-600 dark:text-blue-400 font-bold">94%</span>
                            </div>
                            
                            <div class="flex items-center justify-between p-3 bg-purple-50 dark:bg-purple-900/20 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-purple-100 dark:bg-purple-900 rounded-full flex items-center justify-center">
                                        <span class="text-purple-600 dark:text-purple-400 font-bold text-sm">3</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">Maria Oliveira</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">19 inspeções</p>
                                    </div>
                                </div>
                                <span class="text-purple-600 dark:text-purple-400 font-bold">92%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Relatórios Section -->
            <section id="relatorios" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-3xl font-bold text-gray-900 dark:text-white mb-3">Relatórios</h2>
                    <p class="text-gray-600 dark:text-gray-400">Gere e exporte relatórios personalizados</p>
                </div>

                <!-- Report Generator -->
                <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-8">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Gerador de Relatórios</h3>
                    
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Relatório</label>
                            <select id="reportType" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="geral">Relatório Geral</option>
                                <option value="equipamento">Por Equipamento</option>
                                <option value="mecanico">Por Líder</option>
                                <option value="periodo">Por Período</option>
                                <option value="criticos">Problemas Críticos</option>
                                <option value="maintenance">Manutenções (Itens NÃO OK)</option>
                                <option value="performance">Performance (Itens OK)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Período</label>
                            <select id="reportPeriod" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="7">Últimos 7 dias</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 90 dias</option>
                                <option value="custom">Personalizado</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Formato</label>
                            <select id="reportFormat" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="pdf">PDF</option>
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo de Equipamento</label>
                            <select id="reportEqType" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="all">Todos</option>
                                <option value="caminhao">Caminhão</option>
                                <option value="trator">Trator</option>
                                <option value="colhedora">Colhedora</option>
                                <option value="plantadora">Plantadora</option>
                                <option value="distribuidora">Distribuidora</option>
                                <option value="reboque">Reboque</option>
                                <option value="transbordo">Transbordo</option>
                                <option value="cobridores">Cobridores</option>
                                <option value="tortao">Tortão</option>
                                <option value="motobombas">MotoBombas</option>
                                <option value="hidroroll">Hidro Roll</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex gap-4">
                        <button onclick="generateReport()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200 font-medium">
                            Gerar Relatório
                        </button>
                        <button onclick="scheduleReport()" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">
                            Agendar Envio
                        </button>
                    </div>
                </div>

                <!-- Quick Reports -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateQuickReport('summary')">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-blue-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Resumo Executivo</h3>
                                <p class="text-blue-200 text-sm">Visão geral das operações</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-green-500 to-green-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateQuickReport('performance')">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-green-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Performance</h3>
                                <p class="text-green-200 text-sm">Análise de produtividade</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-red-500 to-red-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateQuickReport('maintenance')">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-red-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.268 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Manutenções</h3>
                                <p class="text-red-200 text-sm">Relatório de problemas</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-500 to-purple-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateQuickReport('trends')">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-purple-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Tendências</h3>
                                <p class="text-purple-200 text-sm">Análise temporal</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-yellow-500 to-yellow-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateQuickReport('compliance')">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-yellow-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Conformidade</h3>
                                <p class="text-yellow-200 text-sm">Relatório de compliance</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 p-6 rounded-xl text-white cursor-pointer card-hover" onclick="generateQuickReport('costs')">
                        <div class="flex items-center space-x-4">
                            <div class="w-12 h-12 bg-indigo-400 rounded-lg flex items-center justify-center">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                                </svg>
                            </div>
                            <div>
                                <h3 class="text-lg font-semibold">Custos</h3>
                                <p class="text-indigo-200 text-sm">Análise financeira</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Equipamentos Section -->
    <section id="equipamentos" class="section-content hidden">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold text-gray-900 dark:text-white mb-2">Cadastro de Equipamentos</h2>
                    <p class="text-gray-600 dark:text-gray-400">Cadastre frotas por setor para uso nas inspeções</p>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 mb-6">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Novo Equipamento</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Setor</label>
                            <select id="equipTipo" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="caminhao">Caminhão</option>
                                <option value="trator">Trator</option>
                                <option value="colhedora">Colhedora</option>
                                <option value="plantadora">Plantadora</option>
                                <option value="distribuidora">Distribuidora</option>
                                <option value="reboque">Reboque</option>
                                <option value="transbordo">Transbordo</option>
                                <option value="outros">Outros</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frota</label>
                            <input type="text" id="equipFrota" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descrição</label>
                            <input type="text" id="equipDesc" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label>
                            <select id="equipStatus" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent">
                                <option value="ativo" selected>Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-4">
                        <button onclick="addEquipment()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200 font-medium">Salvar</button>
                        <button onclick="populateEquipmentList()" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors duration-200">Atualizar Lista</button>
                    </div>
                </div>

                <div class="bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Frotas Cadastradas</h3>
                            <select id="equipFilterTipo" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                <option value="all" selected>Todos</option>
                                <option value="caminhao">Caminhão</option>
                                <option value="trator">Trator</option>
                                <option value="colhedora">Colhedora</option>
                                <option value="plantadora">Plantadora</option>
                                <option value="distribuidora">Distribuidora</option>
                                <option value="reboque">Reboque</option>
                                <option value="transbordo">Transbordo</option>
                                <option value="outros">Outros</option>
                            </select>
                    </div>
                    <div id="equipList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </div>
    </section>

            <section id="inventario" class="section-content hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="glass-morphism rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-8">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                                    <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8"/></svg>
                                </div>
                                <div>
                                    <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Ficha de Inventário de Pneus</h2>
                                    <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">Selecione a ficha desejada para iniciar o lançamento</p>
                                </div>
                            </div>
                            <div class="hidden sm:flex items-center gap-2">
                                <span class="px-3 py-1 text-xs bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded-full">Inventário</span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <div onclick="showSection('calibragem')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-blue-100 dark:bg-blue-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Calibragem</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Lançar pressão e posições</p>
                                </div>
                            </div>
                        </div>
                        <div onclick="showSection('controle3p')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-purple-100 dark:bg-purple-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Ficha de Controle 3P</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Sulco, DOT e pressão</p>
                                </div>
                            </div>
                        </div>
                        <div onclick="showSection('historico_pneus')" class="equipment-card bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700 cursor-pointer hover:shadow-lg hover:border-primary transition-all duration-200">
                            <div class="flex items-center space-x-4">
                                <div class="w-12 h-12 bg-amber-100 dark:bg-amber-900 rounded-lg flex items-center justify-center">
                                    <svg class="w-6 h-6 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10m4-7v7m4-4v4"/></svg>
                                </div>
                                <div>
                                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Histórico de Pneus</h3>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">Calibragens e Fichas 3P</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <section id="controle3p" class="section-content hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-8">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900 flex items-center justify-center">
                                <svg class="w-5 h-5 text-purple-600 dark:text-purple-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16"/></svg>
                            </div>
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Ficha de Controle 3P</h2>
                                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">Preencha conforme a ficha de controle</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex gap-2">
                                <button id="c3pBtnSalvar" class="px-4 py-2 bg-primary text-white rounded-lg" onclick="saveControle3p()">Salvar</button>
                                <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg" onclick="clearControle3pForm()">Limpar</button>
                                <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg" onclick="window.print()">Imprimir</button>
                            </div>
                            <div id="controle3pStatus" class="text-sm text-gray-500 dark:text-gray-400"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Frota</label>
                                <select id="c3pFrotaSelect" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></select>
                                <input id="c3pFrotaCustom" placeholder="Digite a frota" type="text" class="mt-2 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hidden">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Equipamento</label>
                                <select id="c3pEquipamento" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="caminhao">Caminhão</option>
                                    <option value="transbordo">Transbordo</option>
                                    <option value="trator">Trator</option>
                                    <option value="colhedora">Colhedora</option>
                                    <option value="plantadora">Plantadora</option>
                                    <option value="distribuidora">Distribuidora</option>
                                    <option value="reboque">Reboque</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Hodômetro/Horímetro</label>
                                <input id="c3pHodo" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Ordem de Serviço/Item</label>
                                <input id="c3pOS" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Matrícula</label>
                                <input id="c3pMatricula" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="md:col-span-1">
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Nome</label>
                                <input id="c3pNome" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Inicial</label>
                                <input id="c3pDataIni" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Hora Inicial</label>
                                <input id="c3pHoraIni" type="time" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Final</label>
                                <input id="c3pDataFim" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Hora Final</label>
                                <input id="c3pHoraFim" type="time" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                        <div class="overflow-x-auto">
                            <table class="min-w-full text-sm table-fixed">
                                <thead class="sticky top-0 z-10">
                                    <tr class="bg-gray-50 dark:bg-gray-700 text-gray-700 dark:text-gray-200">
                                        <th class="px-2 py-2 text-left">SEQ</th>
                                        <th class="px-2 py-2 text-left">POSIÇÃO</th>
                                        <th class="px-2 py-2 text-left">Nº FOGO PNEU</th>
                                        <th class="px-2 py-2 text-left">MEDIDA</th>
                                        <th class="px-2 py-2 text-left">FABRICANTE</th>
                                        <th class="px-2 py-2 text-left">MODELO</th>
                                        <th class="px-2 py-2 text-left">ÍNDICE DE CARGA</th>
                                        <th class="px-2 py-2 text-left">DOT</th>
                                        <th class="px-2 py-2 text-left">1º SULCO</th>
                                        <th class="px-2 py-2 text-left">2º SULCO</th>
                                        <th class="px-2 py-2 text-left">3º SULCO</th>
                                        <th class="px-2 py-2 text-left">PRESSÃO ENCONTRADO</th>
                                    </tr>
                                </thead>
                                <tbody id="ctrl3pTableBody" class="divide-y divide-gray-100 dark:divide-gray-700"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="historico_pneus" class="section-content hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900 flex items-center justify-center">
                                <svg class="w-5 h-5 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10m4-7v7m4-4v4"/></svg>
                            </div>
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Histórico de Pneus</h2>
                                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">Calibragens e Fichas de Controle 3P</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-4 shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Tipo</label>
                                <select id="histEquipTipo" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="all">Todos</option>
                                    <option value="caminhao">Caminhão</option>
                                    <option value="transbordo">Transbordo</option>
                                    <option value="trator">Trator</option>
                                    <option value="colhedora">Colhedora</option>
                                    <option value="plantadora">Plantadora</option>
                                    <option value="distribuidora">Distribuidora</option>
                                    <option value="reboque">Reboque</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Frota</label>
                                <select id="histFrotaSelect" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></select>
                                <input id="histFrotaCustom" placeholder="Digite a frota" type="text" class="mt-2 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hidden">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Inicial</label>
                                <input id="histDataIni" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Final</label>
                                <input id="histDataFim" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="flex items-end">
                                <button class="w-full px-4 py-2 bg-primary text-white rounded-md" onclick="loadHistoricoPneus()">Atualizar</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <div class="map-tabs">
                                <button id="histTabCal" class="map-tab active" onclick="showHistoricoTab('cal')">Calibragens</button>
                                <button id="histTabC3p" class="map-tab" onclick="showHistoricoTab('c3p')">Controle 3P</button>
                            </div>
                            <div id="histStatus" class="text-sm text-gray-500 dark:text-gray-400"></div>
                        </div>
                    </div>
                    <div id="histCalList" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                        <div id="histCalRows" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
                    </div>
                    <div id="histC3pList" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm hidden">
                        <div id="histC3pRows" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
                    </div>
                </div>
            </section>
            <section id="historico_pneus" class="section-content hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="mb-6">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900 flex items-center justify-center">
                                <svg class="w-5 h-5 text-amber-600 dark:text-amber-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v10m4-7v7m4-4v4"/></svg>
                            </div>
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Histórico de Pneus</h2>
                                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">Calibragens e Fichas de Controle 3P</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-4 shadow-sm">
                        <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Tipo</label>
                                <select id="histEquipTipo" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="all">Todos</option>
                                    <option value="caminhao">Caminhão</option>
                                    <option value="transbordo">Transbordo</option>
                                    <option value="trator">Trator</option>
                                    <option value="colhedora">Colhedora</option>
                                    <option value="plantadora">Plantadora</option>
                                    <option value="distribuidora">Distribuidora</option>
                                    <option value="reboque">Reboque</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Frota</label>
                                <select id="histFrotaSelect" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></select>
                                <input id="histFrotaCustom" placeholder="Digite a frota" type="text" class="mt-2 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hidden">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Inicial</label>
                                <input id="histDataIni" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Final</label>
                                <input id="histDataFim" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="flex items-end">
                                <button class="w-full px-4 py-2 bg-primary text-white rounded-md" onclick="loadHistoricoPneus()">Atualizar</button>
                            </div>
                        </div>
                        <div class="flex items-center justify-between mt-4">
                            <div class="map-tabs">
                                <button id="histTabCal" class="map-tab active" onclick="showHistoricoTab('cal')">Calibragens</button>
                                <button id="histTabC3p" class="map-tab" onclick="showHistoricoTab('c3p')">Controle 3P</button>
                            </div>
                            <div id="histStatus" class="text-sm text-gray-500 dark:text-gray-400"></div>
                        </div>
                    </div>
                    <div id="histCalList" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                        <div id="histCalRows" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
                    </div>
                    <div id="histC3pList" class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm hidden">
                        <div id="histC3pRows" class="divide-y divide-gray-200 dark:divide-gray-700"></div>
                    </div>
                </div>
            </section>
            <section id="calibragem" class="section-content hidden">
                <div class="max-w-7xl mx-auto">
                    <div class="glass-morphism rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-8">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900 flex items-center justify-center">
                                <svg class="w-5 h-5 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v8m-4-4h8"/></svg>
                            </div>
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold text-gray-900 dark:text-white">Calibragem de Pneu</h2>
                                <p class="text-xs sm:text-sm text-gray-600 dark:text-gray-400">Preencha conforme a ficha de inventário. Consulte as abreviações abaixo.</p>
                            </div>
                        </div>
                    </div>
                    <div class="mb-6">
                        <div class="flex flex-wrap gap-2 text-xs">
                            <span class="px-2 py-1 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded">DE = Dianteiro Esquerdo</span>
                            <span class="px-2 py-1 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded">DI = Dianteiro Direito</span>
                            <span class="px-2 py-1 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded">EE = Externo Esquerdo</span>
                            <span class="px-2 py-1 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded">EI = Interno Esquerdo</span>
                            <span class="px-2 py-1 bg-blue-50 text-blue-700 dark:bg-blue-900/30 dark:text-blue-300 rounded">EST = Estepe</span>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-6 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex gap-2">
                                <button id="calBtnSalvar" class="px-4 py-2 bg-primary text-white rounded-lg" onclick="saveCalibragem()">Salvar</button>
                                <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg" onclick="clearCalibragemForm()">Limpar</button>
                                <button class="px-4 py-2 bg-gray-200 dark:bg-gray-700 text-gray-900 dark:text-white rounded-lg" onclick="window.print()">Imprimir</button>
                            </div>
                            <div id="calibragemStatus" class="text-sm text-gray-500 dark:text-gray-400"></div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4">
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Frota</label>
                                <select id="calFrotaSelect" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></select>
                                <input id="calFrotaCustom" placeholder="Digite a frota" type="text" class="mt-2 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white hidden">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Equipamento</label>
                                <select id="calEquipamento" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <option value="caminhao">Caminhão</option>
                                    <option value="transbordo">Transbordo</option>
                                    <option value="trator">Trator</option>
                                    <option value="colhedora">Colhedora</option>
                                    <option value="plantadora">Plantadora</option>
                                    <option value="distribuidora">Distribuidora</option>
                                    <option value="reboque">Reboque</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Hodômetro/Horímetro</label>
                                <input id="calHodo" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Ordem de Serviço/Item</label>
                                <input id="calOS" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Matrícula</label>
                                <input id="calMatricula" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div class="md:col-span-1">
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Nome</label>
                                <input id="calNome" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Inicial</label>
                                <input id="calDataIni" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Hora Inicial</label>
                                <input id="calHoraIni" type="time" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Data Final</label>
                                <input id="calDataFim" type="date" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Hora Final</label>
                                <div class="flex gap-2">
                                    <input id="calHoraFim" type="time" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <button class="mt-1 px-3 py-2 text-xs bg-gray-200 dark:bg-gray-700 rounded-lg" onclick="setCalibragemEndNow()">Agora</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-8 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Posição Nº Fogo dos Pneus</h3>
                        </div>
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">1º DE</label>
                                        <input id="pos_1de" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">1º DI</label>
                                        <input id="pos_1di" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">2º DE</label>
                                        <input id="pos_2de" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">2º DI</label>
                                        <input id="pos_2di" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">3º DE</label>
                                        <input id="pos_3de" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">3º DI</label>
                                        <input id="pos_3di" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">4º DE</label>
                                        <input id="pos_4de" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">4º DI</label>
                                        <input id="pos_4di" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="grid grid-cols-2 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">1º EE</label>
                                        <input id="pos_1ee" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">1º EI</label>
                                        <input id="pos_1ei" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">2º EE</label>
                                        <input id="pos_2ee" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">2º EI</label>
                                        <input id="pos_2ei" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">3º EE</label>
                                        <input id="pos_3ee" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">3º EI</label>
                                        <input id="pos_3ei" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">4º EE</label>
                                        <input id="pos_4ee" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">4º EI</label>
                                        <input id="pos_4ei" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                            </div>
                            <div class="space-y-3">
                                <div class="grid grid-cols-1 gap-2">
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">EST1</label>
                                        <input id="pos_est1" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                    <div>
                                        <label class="text-xs text-gray-500 dark:text-gray-400">EST2</label>
                                        <input id="pos_est2" type="text" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-8 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Medição de Sulco</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">1DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_1de_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_1de_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">1DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_1di_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_1di_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">2DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_2de_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_2de_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">2DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_2di_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_2di_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">3DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_3de_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_3de_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">3DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_3di_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_3di_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">4DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_4de_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_4de_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">4DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_4di_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_4di_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">1EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_1ei_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_1ei_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">1EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_1ee_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_1ee_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">2EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_2ei_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_2ei_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">2EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_2ee_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_2ee_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">3EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_3ei_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_3ei_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">3EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_3ee_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_3ee_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">4EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_4ei_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_4ei_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">4EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <input id="sulco_4ee_a" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="sulco_4ee_b" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 dark:text-gray-400">EST</label>
                                <input id="sulco_est" type="text" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 mb-8 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Mapa Visual de Posições</h3>
                            <div class="map-tabs">
                                <button id="tabTruck" class="map-tab active" onclick="setCalibMap('truck')">Caminhão</button>
                                <button id="tabTrans" class="map-tab" onclick="setCalibMap('transbordo')">Transbordo</button>
                            </div>
                        </div>
                        <div id="mapTruck">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div>
                                <div class="tire-label">Dianteiros</div>
                                <div class="space-y-3 mt-2">
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('1de')">1º DE</button>
                                        <div class="tire-label">Eixo 1</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('1di')">1º DI</button>
                                    </div>
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('2de')">2º DE</button>
                                        <div class="tire-label">Eixo 2</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('2di')">2º DI</button>
                                    </div>
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('3de')">3º DE</button>
                                        <div class="tire-label">Eixo 3</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('3di')">3º DI</button>
                                    </div>
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('4de')">4º DE</button>
                                        <div class="tire-label">Eixo 4</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('4di')">4º DI</button>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <div class="tire-label">Duplos</div>
                                <div class="space-y-3 mt-2">
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('1ee')">1º EE</button>
                                        <div class="tire-label">Eixo 1</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('1ei')">1º EI</button>
                                    </div>
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('2ee')">2º EE</button>
                                        <div class="tire-label">Eixo 2</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('2ei')">2º EI</button>
                                    </div>
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('3ee')">3º EE</button>
                                        <div class="tire-label">Eixo 3</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('3ei')">3º EI</button>
                                    </div>
                                    <div class="tire-row">
                                        <button class="tire-circle" onclick="focusCalibragemField('4ee')">4º EE</button>
                                        <div class="tire-label">Eixo 4</div>
                                        <button class="tire-circle" onclick="focusCalibragemField('4ei')">4º EI</button>
                                    </div>
                                </div>
                                <div class="tire-row mt-4">
                                    <button class="tire-circle" onclick="focusCalibragemField('est1')">EST1</button>
                                    <div class="tire-label">Estepe</div>
                                    <button class="tire-circle" onclick="focusCalibragemField('est2')">EST2</button>
                                </div>
                            </div>
                        </div>
                        </div>
                        <div id="mapTransbordo" class="hidden">
                            <div class="vehicle-body"></div>
                            <div class="space-y-3 mt-3">
                                <div class="axle-row">
                                    <button class="tire-circle" onclick="focusCalibragemField('1ee')">1º EE</button>
                                    <div class="axle-label">Eixo 1</div>
                                    <button class="tire-circle" onclick="focusCalibragemField('1ei')">1º EI</button>
                                </div>
                                <div class="axle-row">
                                    <button class="tire-circle" onclick="focusCalibragemField('2ee')">2º EE</button>
                                    <div class="axle-label">Eixo 2</div>
                                    <button class="tire-circle" onclick="focusCalibragemField('2ei')">2º EI</button>
                                </div>
                                <div class="axle-row">
                                    <button class="tire-circle" onclick="focusCalibragemField('3ee')">3º EE</button>
                                    <div class="axle-label">Eixo 3</div>
                                    <button class="tire-circle" onclick="focusCalibragemField('3ei')">3º EI</button>
                                </div>
                                <div class="axle-row">
                                    <button class="tire-circle" onclick="focusCalibragemField('4ee')">4º EE</button>
                                    <div class="axle-label">Eixo 4</div>
                                    <button class="tire-circle" onclick="focusCalibragemField('4ei')">4º EI</button>
                                </div>
                                <div class="axle-row mt-2">
                                    <button class="tire-circle" onclick="focusCalibragemField('est1')">EST1</button>
                                    <div class="axle-label">Estepe</div>
                                    <button class="tire-circle" onclick="focusCalibragemField('est2')">EST2</button>
                                </div>
                            </div>
                        </div>
                    </div>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Calibragem</h3>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                            <div id="calib_box_1de" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">1º DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_1de_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_1de_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_1di" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">1º DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_1di_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_1di_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_2de" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">2º DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_2de_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_2de_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_2di" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">2º DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_2di_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_2di_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_3de" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">3º DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_3de_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_3de_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_3di" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">3º DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_3di_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_3di_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_4de" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">4º DE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_4de_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_4de_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_4di" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">4º DI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_4di_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_4di_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_1ei" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">1º EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_1ei_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_1ei_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_1ee" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">1º EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_1ee_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_1ee_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_2ei" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">2º EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_2ei_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_2ei_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_2ee" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">2º EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_2ee_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_2ee_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_3ei" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">3º EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_3ei_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_3ei_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_3ee" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">3º EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_3ee_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_3ee_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_4ei" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">4º EI</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_4ei_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_4ei_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_4ee" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">4º EE</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_4ee_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_4ee_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_est1" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">EST1</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_est1_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_est1_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                            <div id="calib_box_est2" class="border border-transparent rounded-lg p-1">
                                <label class="text-xs text-gray-500 dark:text-gray-400">EST2</label>
                                <div class="grid grid-cols-2 gap-2 mt-1">
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Encontrada</div>
                                    <div class="text-[11px] text-gray-500 dark:text-gray-400">Aplicada</div>
                                    <input id="calib_est2_encon" placeholder="Encontrada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                    <input id="calib_est2_colo" placeholder="Aplicada" type="text" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white dark:bg-gray-800 rounded-xl border border-gray-200 dark:border-gray-700 p-6 shadow-sm">
                        <label class="text-xs font-medium text-gray-500 dark:text-gray-400">Observações</label>
                        <textarea id="calObservacoes" rows="4" class="mt-1 w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                </div>
            </section>
        </main>

        <!-- Success Modal -->
        <div id="successModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 fade-in">
                <div class="flex items-center space-x-3 mb-4">
                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                        <svg class="w-6 h-6 text-green-600 dark:text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                        </svg>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Sucesso!</h3>
                </div>
                <p class="text-gray-600 dark:text-gray-400 mb-4" id="successMessage">Inspeção salva com sucesso!</p>
                <button onclick="closeModal('successModal')" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200">
                    OK
                </button>
            </div>
        </div>
        <div id="inspectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start sm:items-center justify-center z-50 hidden p-4">
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full sm:max-w-2xl max-h-[80vh] sm:max-h-[85vh] overflow-y-auto mx-0 sm:mx-4 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Checklist Completo</h3>
                    <div class="flex gap-2">
                        <button id="printInspectionBtn" class="px-3 py-2 bg-primary text-white rounded-md">Imprimir</button>
                        <button onclick="closeModal('inspectionModal')" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300">Fechar</button>
                    </div>
                </div>
                <div id="inspectionAdminBar" class="flex items-center gap-2 mb-3 hidden">
                    <button onclick="openEditInspection(currentInspectionId)" class="px-3 py-2 bg-yellow-500 text-white rounded-md">Editar</button>
                    <button onclick="deleteInspection(currentInspectionId)" class="px-3 py-2 bg-red-600 text-white rounded-md">Excluir</button>
                </div>
                <div id="inspectionDetails" class="space-y-4"></div>
            </div>
        </div>

        <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
            <div class="glass-morphism p-6 rounded-xl shadow-lg max-w-lg w-full mx-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Editar Inspeção</h3>
                <input type="hidden" id="editId" />
                <input type="hidden" id="editSource" />
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Data</label>
                        <input type="date" id="editData" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" readonly />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frota</label>
                        <input type="text" id="editFrota" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Líder</label>
                        <input type="text" id="editMecanico" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" />
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Observação</label>
                        <textarea id="editObs" rows="3" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                </div>
                <div class="flex items-center gap-3 mt-6">
                    <button onclick="saveEditInspection()" class="px-4 py-2 bg-primary text-white rounded-md">Salvar</button>
                    <button onclick="closeModal('editModal')" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // CONFIGURAÇÃO DO API CLIENT
        // ==========================================
        const INSPECTION_PHOTOS_BUCKET = 'inspection-photos';
        
        // Inicializar cliente API (substitui Supabase)
        var supabase = window.createApiClient();
        
        // Estado global da aplicação
        let currentUser = null;
        let viewMode = 'global';
        let currentEquipment = '';
        let inspections = [];
        let equipments = [];
        let realtimeChannel = null;
        let systemBroadcastChannel = null;
        let presenceChannel = null;
        let onlineUsers = {};
        let usersList = [];
        let pollingTimer = null;
        let currentInspectionId = null;
        let currentPhotoSessionId = null;
        let savingInspection = false;
        let syncingInspections = false;
        const RESTRICTED_EMAILS = [''];
        function isOnline() { return navigator.onLine; }
        function getOfflineUser() { return { id: 'offline', email: 'Offline' }; }
        function getCachedUser() { try { return JSON.parse(localStorage.getItem('currentUser')); } catch(_) { return null; } }
        function setCachedUser(u) { try { localStorage.setItem('currentUser', JSON.stringify(u)); } catch(_) {} }
        function clearCachedUser() { try { localStorage.removeItem('currentUser'); } catch(_) {} }
        function getCachedInspections() { try { return JSON.parse(localStorage.getItem('cachedInspections')) || []; } catch(_) { return []; } }
        function setCachedInspections(list) { try { localStorage.setItem('cachedInspections', JSON.stringify(list)); } catch(_) {} }
        function getPendingInspections() { try { return JSON.parse(localStorage.getItem('pendingInspections')) || []; } catch(_) { return []; } }
        function setPendingInspections(list) { try { localStorage.setItem('pendingInspections', JSON.stringify(list)); } catch(_) {} }
        function queueInspection(item) { const q = getPendingInspections(); q.push(item); setPendingInspections(q); }
        function getCachedIrrInspections() { try { return JSON.parse(localStorage.getItem('cachedIrrInspections')) || []; } catch(_) { return []; } }
        function setCachedIrrInspections(list) { try { localStorage.setItem('cachedIrrInspections', JSON.stringify(list)); } catch(_) {} }
        function getPendingIrrInspections() { try { return JSON.parse(localStorage.getItem('pendingIrrInspections')) || []; } catch(_) { return []; } }
        function setPendingIrrInspections(list) { try { localStorage.setItem('pendingIrrInspections', JSON.stringify(list)); } catch(_) {} }
        function queueIrrInspection(item) { const q = getPendingIrrInspections(); q.push(item); setPendingIrrInspections(q); }
        function getCachedEquipments() { try { return JSON.parse(localStorage.getItem('cachedEquipments')) || []; } catch(_) { return []; } }
        function setCachedEquipments(list) { try { localStorage.setItem('cachedEquipments', JSON.stringify(list)); } catch(_) {} }
        function getPendingEquipments() { try { return JSON.parse(localStorage.getItem('pendingEquipments')) || []; } catch(_) { return []; } }
        function setPendingEquipments(list) { try { localStorage.setItem('pendingEquipments', JSON.stringify(list)); } catch(_) {} }
        function queueEquipment(item) { const q = getPendingEquipments(); q.push(item); setPendingEquipments(q); }
        function getCachedNotifications() { try { return JSON.parse(localStorage.getItem('cachedNotifications')) || []; } catch(_) { return []; } }
        function setCachedNotifications(list) { try { localStorage.setItem('cachedNotifications', JSON.stringify(list)); } catch(_) {} }
        function getPendingCalibragem() { try { return JSON.parse(localStorage.getItem('pendingCalibragem')) || []; } catch(_) { return []; } }
        function setPendingCalibragem(list) { try { localStorage.setItem('pendingCalibragem', JSON.stringify(list)); } catch(_) {} }
        function queueCalibragem(item) { const q = getPendingCalibragem(); q.push(item); setPendingCalibragem(q); }
        function getPendingControle3p() { try { return JSON.parse(localStorage.getItem('pendingControle3p')) || []; } catch(_) { return []; } }
        function setPendingControle3p(list) { try { localStorage.setItem('pendingControle3p', JSON.stringify(list)); } catch(_) {} }
        function queueControle3p(item) { const q = getPendingControle3p(); q.push(item); setPendingControle3p(q); }
        function addOrReplaceInspection(item) {
            const k = String(item.local_id || item.id || '');
            if (!k) {
                inspections.unshift(item);
                setCachedInspections(inspections);
                return;
            }
            const idx = inspections.findIndex(i => String(i.local_id || i.id || '') === k);
            if (idx >= 0) {
                inspections[idx] = item;
            } else {
                inspections.unshift(item);
            }
            setCachedInspections(inspections);
        }
        function dedupeInspections(list) {
            const seen = new Set();
            const out = [];
            for (const it of (list || [])) {
                const k = String(it.local_id || it.id || [it.data, it.tipo, it.frota, it.mecanico, it.created_at].join('|'));
                if (seen.has(k)) continue;
                seen.add(k);
                out.push(it);
            }
            return out;
        }
        async function seedTrucks() {
            if (!isOnline()) return;
            const trucks = [
                { tipo: 'truck', frota: '4786', descricao: 'QTR-5685', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '4787', descricao: 'QTR-5835', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6134', descricao: 'OMS-7B81', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6135', descricao: 'OMS-6J71', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6137', descricao: 'OMS-6891', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6138', descricao: 'OMS-6831', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6139', descricao: 'OMS-6I61', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6141', descricao: 'OMS-7E81', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6143', descricao: 'OMS-7B91', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6145', descricao: 'OMS-7F61', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6146', descricao: 'OMS-7F51', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6147', descricao: 'OMS-7F41', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6148', descricao: 'OMS-7F21', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6150', descricao: 'OMS-7H91', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6154', descricao: 'OMS-7651', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6155', descricao: 'OMS-7G31', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6416', descricao: 'PQS-4D11', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6418', descricao: 'PQS-4471', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6419', descricao: 'PQS-4F01', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6531', descricao: 'PRI-9R55', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6532', descricao: 'PRJ-7885', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6581', descricao: 'PRR-4C81', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6650', descricao: 'RCC-2I73', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6657', descricao: 'SCK-4B02', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6658', descricao: 'SCK-3J22', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6679', descricao: 'SBY-6F31', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6680', descricao: 'SBY-6F71', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6681', descricao: 'SBZ-0G11', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6682', descricao: 'SBY-6E21', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6697', descricao: 'SDC-3G12', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6698', descricao: 'SDC-3G22', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6699', descricao: 'SCW-7B53', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6700', descricao: 'SCW7C53', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6960', descricao: 'SDI-6F74', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6961', descricao: 'SDI-6C04', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6962', descricao: 'SDI-6F04', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6963', descricao: 'SDI-6A84', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6964', descricao: 'SDI-6D54', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6965', descricao: 'SDI-5J84', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6995', descricao: 'TFW-1G13', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6996', descricao: 'TFT-6D23', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6997', descricao: 'TFN-0G73', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6998', descricao: 'TFR-0E43', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'truck', frota: '6999', descricao: 'TGD-6H83', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = trucks.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'truck')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = trucks.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Frotas de caminhão cadastradas');
            }
        }
        async function seedHarvesters() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'colhedora', frota: '6602', descricao: 'Colhedora', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'colhedora', frota: '6988', descricao: 'Colhedora', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'colhedora', frota: '6989', descricao: 'Colhedora', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'colhedora', frota: '6721', descricao: 'Colhedora', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'colhedora', frota: '6990', descricao: 'Colhedora', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'colhedora', frota: '6722', descricao: 'Colhedora', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'colhedora', frota: '6702', descricao: 'Colhedora', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'colhedora', frota: '5911', descricao: 'colhedora', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'colhedora')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Colhedoras cadastradas');
            }
        }
        async function seedTractors() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'trator', frota: '6671', descricao: 'MF-Dyna', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6685', descricao: 'MF-Dyna', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6958', descricao: 'MF-Dyna', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6966', descricao: 'JHON DEERE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6967', descricao: 'JHON DEERE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6969', descricao: 'JHON DEERE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6668', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6669', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6670', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6617', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6968', descricao: 'JHON DEERE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6616', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6615', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6525', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6527', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6526', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6528', descricao: 'MF-7219', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6611', descricao: 'JHON DEERE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6612', descricao: 'JHON DEERE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6459', descricao: 'MF 7415', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6083', descricao: 'MF-4299', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6365', descricao: '', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6019', descricao: 'MF-7180', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6458', descricao: 'MF-7415', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6069', descricao: 'MF-4283', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6071', descricao: 'MF-4283', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'trator', frota: '6367', descricao: 'MF-4283', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'trator')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Tratores cadastrados');
            }
        }
        async function seedPlanters() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'plantadora', frota: '6474', descricao: 'ANTONIOSE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'plantadora', frota: '6476', descricao: 'ANTONIOSE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'plantadora', frota: '6473', descricao: 'ANTONIOSE', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'plantadora')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Plantadoras cadastradas');
            }
        }
        async function seedDistributors() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'distribuidora', frota: '5530', descricao: 'ANTONIOSE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'distribuidora', frota: '5684', descricao: 'ANTONIOSE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'distribuidora', frota: '4332', descricao: 'ANTONIOSE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'distribuidora', frota: '5812', descricao: 'ANTONIOSE', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'distribuidora', frota: '4105', descricao: 'COBRIDOR', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'distribuidora', frota: '6315', descricao: 'COBRIDOR', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'distribuidora', frota: '6316', descricao: 'COBRIDOR', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'distribuidora')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Distribuidoras cadastradas');
            }
        }
        async function seedTrailers() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'reboque', frota: '4371', descricao: 'Grupo 2 - OML-0082', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4373', descricao: 'Grupo 2 - OMK-9982', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4377', descricao: 'Grupo 2 - OML-5602', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4615', descricao: 'Grupo 1 - PQU-2651', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4619', descricao: 'Grupo 1 - PQU-2701', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4621', descricao: 'Grupo 1 - PQU-0271', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4631', descricao: 'Grupo 1 - PQU-2561', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4632', descricao: 'Grupo 1 - PQT-3481', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4645', descricao: 'Grupo 1 - PQU-4991', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4648', descricao: 'Grupo 1 - PQU-4721', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '4653', descricao: 'Grupo 1 - PQU-5161', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6181', descricao: 'Grupo 2 - OMK-3I32', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6182', descricao: 'Grupo 2 - OMK-3452', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6183', descricao: 'Grupo 2 - OMK-3472', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6184', descricao: 'Grupo 2 - OMK-9842', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6185', descricao: 'Grupo 2 - OMK-3842', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6186', descricao: 'Grupo 2 - OML-4B82', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6187', descricao: 'Grupo 2 - OMK3H02', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6188', descricao: 'Grupo 2 - OMK-3352', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6190', descricao: 'Grupo 2 - OML-5D22', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6191', descricao: 'Grupo 2 - OML-4882', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6193', descricao: 'Grupo 2 - OML-4802', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6194', descricao: 'Grupo 2 - OML-4152', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6195', descricao: 'Grupo 2 - OMK-3E12', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6196', descricao: 'Grupo 2 - OML-4212', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6197', descricao: 'Grupo 2 - OML-3J42', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6198', descricao: 'Grupo 2 - OMK-3J12', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6199', descricao: 'Grupo 2 - OMK-3H12', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6201', descricao: 'Grupo 2 - ONF-2I51', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6202', descricao: 'Grupo 2 - OML-4162', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6207', descricao: 'Grupo 2 - OML-4932', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6209', descricao: 'Grupo 2 - OML-5012', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6210', descricao: 'Grupo 2 - OML-3792', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6213', descricao: 'Grupo 2 - OML-4112', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6214', descricao: 'Grupo 2 - OML-4822', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6218', descricao: 'Grupo 2 - OMK-3I52', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6221', descricao: 'Grupo 2 - OMK-4B72', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6222', descricao: 'Grupo 2 - OML-4C72', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6224', descricao: 'Grupo 2 - OML-4J42', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6225', descricao: 'Grupo 2 - OML-4282', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6226', descricao: 'Grupo 2 - OML-3912', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6239', descricao: 'Grupo 2 - OML-3J32', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6241', descricao: 'Grupo 2 - OMK-3I82', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6242', descricao: 'Grupo 2 - OML-5D92', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6388', descricao: 'Grupo 1 - PQT-4811', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6389', descricao: 'Grupo 1 - PQT-5681', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6390', descricao: 'Grupo 1 - PQT-4941', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6391', descricao: 'Grupo 1 - PQT-5761', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6392', descricao: 'Grupo 1 - PQT-4721', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6393', descricao: 'Grupo 1 - PQT-5721', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6394', descricao: 'Grupo 1 - PQT-4781', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6395', descricao: 'Grupo 1 - PQT-5711', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6396', descricao: 'Grupo 1 - PQT-4881', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6397', descricao: 'Grupo 1 - PQT-5661', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6398', descricao: 'Grupo 1 - PQT-4991', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6399', descricao: 'Grupo 1 - PQT-5771', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6400', descricao: 'Grupo 1 - PQT-5171', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6401', descricao: 'Grupo 1 - PQT-5851', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6402', descricao: 'Grupo 1 - PQT-4931', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6403', descricao: 'Grupo 1 - PQT-5731', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6404', descricao: 'Grupo 1 - PQT-5061', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6405', descricao: 'Grupo 1 - PQT-5831', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6406', descricao: 'Grupo 1 - PQT-5041', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6407', descricao: 'Grupo 1 - PQT-5821', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6408', descricao: 'Grupo 1 - PQT-4961', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6409', descricao: 'Grupo 1 - PQT-5801', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6412', descricao: 'Grupo 1 - PQT-5031', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6413', descricao: 'Grupo 1 - PQT-5641', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6421', descricao: 'Grupo 1 - PQU-2741', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6422', descricao: 'Grupo 1 - PQU-2811', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6423', descricao: 'Grupo 1 - PQJ-8042', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6424', descricao: 'Grupo 1 - PQU-2521', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6425', descricao: 'Grupo 1 - PQU-2791', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6426', descricao: 'Grupo 1 - PQU-2801', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6427', descricao: 'Grupo 1 - PQU-2691', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6428', descricao: 'Grupo 1 - PQU-2821', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6429', descricao: 'Grupo 1 - PQU-2781', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6430', descricao: 'Grupo 1 - PQU-2731', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6431', descricao: 'Grupo 1 - PQU-2H61', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6432', descricao: 'Grupo 1 - PQU-3031', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6433', descricao: 'Grupo 1 - PQU-3021', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '6434', descricao: 'Grupo 1 - PQU-2711', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '9492', descricao: 'Grupo 2 - NKI-6386', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '9501', descricao: 'Grupo 2 - NKI-6F16', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '9542', descricao: 'Grupo 2 - NWF-7I74', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '9546', descricao: 'Grupo 2 - NWF-8644', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '30014', descricao: 'Grupo 3 - OOD3F98', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'reboque', frota: '30015', descricao: 'Grupo 3 - OOD4H78', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'reboque')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Reboques cadastrados');
            }
        }
        async function seedTransbordos() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'transbordo', frota: '176', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '481', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '494', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '531', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '532', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '549', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '562', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '563', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '689', descricao: 'TRANSBORDO CANA PICADA SMR10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '693', descricao: 'TRANSBORDO CANA PICADA SMR10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '696', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '883', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '889', descricao: 'TRANSBORDO CANA PICADA SMR10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '892', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '918', descricao: 'TRANSBORDO CANA PICADA SMR10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '924', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '3135', descricao: 'TRANSBORDO CANA PICADA SE 8500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '3138', descricao: 'TRANSBORDO CANA PICADA SE 8500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '3293', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '3294', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '5390', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '5398', descricao: 'TRANSBORDO CANA PICADA SMR 12500 SERMAG', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '5414', descricao: 'TRANSBORDO CANA PICADA SMR 8500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '5427', descricao: 'TRANSBORDO CANA PICADA SMR 8500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6511', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6512', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6513', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6514', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6515', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6516', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6517', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6518', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6675', descricao: 'TRANSBORDO CANA PICADA TASI 22/2200', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6676', descricao: 'TRANSBORDO CANA PICADA TASI 22/2200', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6678', descricao: 'TRANSBORDO CANA PICADA TASI 22/2200', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6726', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6951', descricao: 'TRANSBORDO CANA PICADA TASI 22/2200', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6992', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6993', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '6994', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '70032', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '8057', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '8058', descricao: 'TRANSBORDO CANA PICADA ATA 10500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '8150', descricao: 'TRANSBORDO CANA PICADA TASI 22/2200', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '8164', descricao: 'TRANSBORDO CANA PICADA ATA 21500', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'transbordo', frota: '9399', descricao: 'TRANSBORDO CANA PICADA SMR 8500', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'transbordo')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Transbordos cadastrados');
            }
        }
        async function seedCobridores() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'cobridores', frota: '4105', descricao: 'COBRIDOR', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'cobridores', frota: '6315', descricao: 'COBRIDOR', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'cobridores', frota: '6316', descricao: 'COBRIDOR', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'cobridores')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Cobridores cadastrados');
            }
        }
        async function seedTortao() {
            if (!isOnline()) return;
            const list = [
                { tipo: 'tortao', frota: '6486', descricao: 'SULCADOR TORTÃO • MF-DYNA', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'tortao', frota: '6506', descricao: 'SULCADOR TORTÃO • MF-DYNA', status: 'ativo', created_at: new Date().toISOString() },
                { tipo: 'tortao', frota: '6618', descricao: 'SULCADOR TORTÃO • MF-DYNA', status: 'ativo', created_at: new Date().toISOString() }
            ];
            const frotas = list.map(t => t.frota);
            const { data: existing, error } = await supabase
                .from('equipments')
                .select('frota,tipo')
                .eq('tipo', 'tortao')
                .in('frota', frotas);
            if (error) return;
            const existingSet = new Set((existing || []).map(e => String(e.frota)));
            const toInsert = list.filter(t => !existingSet.has(String(t.frota)));
            if (toInsert.length === 0) return;
            const { error: insErr } = await supabase
                .from('equipments')
                .insert(toInsert);
            if (!insErr) {
                await loadEquipments();
                populateEquipmentList();
                showFloatingNotification('success', 'Tortões cadastrados');
            }
        }
        let currentInspection = {
            items: [],
            results: {ok: 0, notOk: 0, percentage: 0}
        };

        // Equipment checklists
        const equipmentConfigs = {
            truck: {
                title: "Checklist de Liberação - Caminhão",
                sections: [
                    {
                        name: "CABINE",
                        items: [
                            "Bucha da suspensão",
                            "Batente e dobradiça portas",
                            "Borrachas das portas",
                            "Palhetas do limpador para-brisa",
                            "Maçanetas (internas/externas) e manivela dos vidros",
                            "Bancos (motorista e passageiro)",
                            "Conjunto de basculamento da cabine",
                            "Reservatório e mangueira do limpador de para-brisa",
                            "Estado da escada",
                            "Estado dos retrovisores",
                            "Paralama dianteiro"
                        ]
                    },
                    {
                        name: "CHASSI",
                        items: [
                            "Trincas no chassi e travessas",
                            "Rampa e quinta roda",
                            "Suportes de fixação (tq combustível, bateria, tq arla)",
                            "Danos paralamas traseiros",
                            "Danos e fixação do para barro",
                            "Trincas e fixação da boca de lobo",
                            "Parafuso de fixação do implemento",
                            "Plataformas e suportes dos cones"
                        ]
                    },
                    {
                        name: "MOTOR",
                        items: [
                            "Radiadores, reservatório de água e intercooler",
                            "Tensores de correia, roletes e polias",
                            "Mangueiras e abraçadeiras do sist. de arrefecimento",
                            "Mangueiras e abraçadeiras do sist. de admissão e intercooler",
                            "Regulagem de válvulas do motor e vazamentos (água/diesel/lub)",
                            "Coxins do motor",
                            "Protetores e fixação do silencioso",
                            "Folga no eixo da turbina ou vazamentos",
                            "Carcaça do filtro e tubulação de ar"
                        ]
                    },
                    {
                        name: "SISTEMA ELÉTRICO",
                        items: [
                            "Sinalização traseira e dianteira",
                            "Faróis e piscas",
                            "Chicotes elétricos",
                            "Luzes do painel",
                            "Alternador, correia e tensor",
                            "Ventilador, correia e tensor",
                            "Funcionamento dos vidros",
                            "Ar condicionado",
                            "Ventilador e distribuição do ar",
                            "Funcionamento do limpador de para-brisa",
                            "Motor de partida"
                        ]
                    },
                    {
                        name: "TRANSMISSÃO",
                        items: [
                            "Embreagem (folga/funcionamento)",
                            "Caixa de câmbio (vazamentos/ruídos)",
                            "Cardans e cruzetas",
                            "Acoplamentos e flanges",
                            "Diferencial (fixação/vazamentos)",
                            "Semieixos e juntas",
                            "Suportes e coxins da transmissão"
                        ]
                    },
                    {
                        name: "EIXO DIANTEIRO",
                        items: [
                            "Rolamentos e cubos",
                            "Manga de eixo",
                            "Amortecedores",
                            "Molas/feixes e fixações",
                            "Barra estabilizadora",
                            "Barra de direção e terminais",
                            "Geometria/folgas de direção"
                        ]
                    },
                    {
                        name: "EIXO TRASEIRO",
                        items: [
                            "Molas/feixes e fixações",
                            "Amortecedores",
                            "Braços/estabilizadores",
                            "Rolamentos e cubos",
                            "Eixo/diferencial (ruídos/vazamentos)"
                        ]
                    },
                    {
                        name: "SISTEMA PNEUMÁTICO",
                        items: [
                            "Reservatórios de ar",
                            "Válvulas e conexões",
                            "Mangueiras e flexíveis",
                            "Câmaras de freio",
                            "Tubulações do sistema",
                            "Vazamentos/pressão"
                        ]
                    },
                    {
                        name: "DIREÇÃO",
                        items: [
                            "Bomba da direção",
                            "Caixa de direção",
                            "Mangueiras e vazamentos",
                            "Folgas no sistema",
                            "Alinhamento/funcionamento"
                        ]
                    }
                ]
            },
            tractor: {
                title: "Checklist de Liberação - Trator",
                sections: [
                    {
                        name: "SISTEMA DO MOTOR",
                        items: [
                            "Correias e polias",
                            "Tensores",
                            "Bomba d'água",
                            "Turbina",
                            "Anéis e vedações",
                            "Bomba injetora",
                            "Bicos injetores",
                            "Mangotes",
                            "Radiadores",
                            "Trincas/Desgaste"
                        ]
                    },
                    {
                        name: "SISTEMA ELÉTRICO",
                        items: [
                            "Alternador",
                            "Bóia do tanque",
                            "Buzina",
                            "Rádio de comunicação",
                            "Ar condicionado",
                            "Faróis",
                            "Relógios em geral",
                            "Chicotes elétricos",
                            "Painel de Instrumentos",
                            "Bateria"
                        ]
                    },
                    {
                        name: "CHASSI E CABINE",
                        items: [
                            "Trincas",
                            "Desgaste",
                            "Fixação",
                            "Banco",
                            "Painel de Instrumentos",
                            "Alavancas e manoplas",
                            "Retrovisor"
                        ]
                    },
                    {
                        name: "TRANSMISSÃO",
                        items: [
                            "Caixa de câmbio",
                            "Cardans e cruzetas",
                            "Acoplamentos/Flanges",
                            "Diferencial (fixação/vazamentos)",
                            "Semieixos/Juntas",
                            "Coxins/Suportes"
                        ]
                    },
                    {
                        name: "EMBREAGEM",
                        items: [
                            "Acionamento",
                            "Folga",
                            "Desgaste",
                            "Vazamentos",
                            "Ajustes"
                        ]
                    },
                    {
                        name: "DIREÇÃO",
                        items: [
                            "Bomba da direção",
                            "Caixa de direção",
                            "Mangueiras/Vazamentos",
                            "Barra/Terminais",
                            "Folgas",
                            "Alinhamento"
                        ]
                    },
                    {
                        name: "EIXO DIANTEIRO",
                        items: [
                            "Rolamentos/Cubos",
                            "Manga de eixo",
                            "Amortecedores",
                            "Molas/Feixes e fixações",
                            "Barra estabilizadora"
                        ]
                    },
                    {
                        name: "EIXO TRASEIRO",
                        items: [
                            "Molas/Feixes e fixações",
                            "Amortecedores",
                            "Braços/Estabilizadores",
                            "Rolamentos/Cubos",
                            "Eixo/Diferencial (ruídos/vazamentos)"
                        ]
                    },
                    {
                        name: "SISTEMA HIDRÁULICO",
                        items: [
                            "Reservatório e filtros",
                            "Bombas hidráulicas",
                            "Válvulas/Distribuidores",
                            "Mangueiras/Flexíveis",
                            "Abraçadeiras/Conexões",
                            "Vazamentos/Pressão"
                        ]
                    },
                    {
                        name: "SISTEMA DE FREIO",
                        items: [
                            "Válvulas/Mangueiras",
                            "Câmaras de freio",
                            "Lonas/Pastilhas",
                            "Discos/Tambores",
                            "Nível de fluido",
                            "Reservatório de ar"
                        ]
                    },
                    {
                        name: "SISTEMA DE COMBUSTÍVEL",
                        items: [
                            "Tanque - Fixação",
                            "Tanque - Vazamentos",
                            "Bomba de combustível",
                            "Linhas/Conexões",
                            "Filtros",
                            "Tampa/vedação"
                        ]
                    },
                    {
                        name: "SISTEMA DE ARREFECIMENTO",
                        items: [
                            "Radiador",
                            "Ventiladores",
                            "Mangueiras/Abraçadeiras",
                            "Reservatório",
                            "Nível",
                            "Vazamentos"
                        ]
                    },
                    {
                        name: "SISTEMA DE LUBRIFICAÇÃO",
                        items: [
                            "Nível de óleo",
                            "Filtros",
                            "Linhas/Conexões",
                            "Pontos de graxa",
                            "Vazamentos"
                        ]
                    },
                    {
                        name: "PNEUS",
                        items: [
                            "Altura dos sulcos dos pneus",
                            "Emparelhamento de duplos",
                            "Desgaste irregular",
                            "Efetuar a calibragem dos pneus",
                            "Parafuso de roda"
                        ]
                    },
                    {
                        name: "SUSP. DIANT.",
                        items: [
                            "Alinhamento do eixo dianteiro",
                            "Balança (pino/bucha/mancal/fixação)",
                            "Feixe de mola",
                            "Braços tensores"
                        ]
                    },
                    {
                        name: "SUSP. TRAS.",
                        items: [
                            "Alinhamento do eixo traseiro",
                            "Balança (pino/bucha/mancal/fixação)",
                            "Feixe de mola",
                            "Braços tensores"
                        ]
                    },
                    {
                        name: "ESTRUTURA (SISTEMA DE LONAMENTO)",
                        items: [
                            "Braço dianteiro",
                            "Braço traseiro",
                            "Pinos",
                            "Rolamentos",
                            "Lona",
                            "Mola"
                        ]
                    },
                    {
                        name: "ADESIVOS E LACRES",
                        items: [
                            "Identificação da frota",
                            "Adesivos refletivos",
                            "Lacre da placa traseira"
                        ]
                    }
                ]
            },
            harvester: {
                title: "Checklist de Liberação - Colhedora",
                sections: [
                    {
                        name: "MOTOR DIESEL",
                        items: [
                            "Turbina - Fixação",
                            "Turbina - Vazamentos",
                            "Turbina - Funcionamento",
                            "Mangueiras/Mangotes - Fixação",
                            "Mangueiras/Mangotes - Vazamento",
                            "Mangueiras/Mangotes - Abraçadeiras",
                            "Motor - Fixação",
                            "Motor - Vazamentos",
                            "Motor - Funcionamento",
                            "Escapamento - Fixação"
                        ]
                    },
                    {
                        name: "SISTEMA ELÉTRICO",
                        items: [
                            "Correia do alternador - Alinhamento/Tensão",
                            "Correia do alternador - Cortes e rachaduras",
                            "Bóia do tanque - Fio da bóia",
                            "Buzina - Funcionamento",
                            "Rádio de comunicação",
                            "Computador de Bordo",
                            "Alarme de ré",
                            "Sensor de porta",
                            "Ar condicionado",
                            "Faróis",
                            "Chicotes e conexões"
                        ]
                    },
                    {
                        name: "MATERIAL RODANTE",
                        items: [
                            "Esteira - Tensionamento",
                            "Esteira - Desgaste",
                            "Roletes - Fixação",
                            "Roletes - Desgaste",
                            "Motores hidráulicos - Fixação",
                            "Motores hidráulicos - Vazamentos",
                            "Motores hidráulicos - Funcionamento",
                            "Sapatas/Roda Motriz - Parafusos",
                            "Sapatas/Roda Motriz - Proteção",
                            "Sapatas/Roda Motriz - Desgaste/Trincas"
                        ]
                    },
                    {
                        name: "PLATAFORMA / DIVISORES",
                        items: [
                            "Divisor de linhas - Fixação",
                            "Divisor de linhas - Ajustes",
                            "Guias e placas - Desgaste",
                            "Rolos alimentadores - Funcionamento",
                            "Rolos alimentadores - Vazamentos",
                            "Coberturas/Proteções"
                        ]
                    },
                    {
                        name: "CORTE DE BASE",
                        items: [
                            "Conjunto de facas - Fixação",
                            "Conjunto de facas - Desgaste",
                            "Altura de corte",
                            "Rolamentos/Conjuntos",
                            "Motores/Transmissão",
                            "Proteções"
                        ]
                    },
                    {
                        name: "CORTE DE PONTAS",
                        items: [
                            "Conjunto de facas - Fixação",
                            "Conjunto de facas - Desgaste",
                            "Altura/ajuste",
                            "Motores/Transmissão",
                            "Proteções"
                        ]
                    },
                    {
                        name: "ALIMENTADOR PRIMÁRIO",
                        items: [
                            "Esteira - Tensionamento",
                            "Esteira - Desgaste",
                            "Rolos - Fixação",
                            "Rolos - Desgaste",
                            "Motores/Válvulas",
                            "Guia/Proteções"
                        ]
                    },
                    {
                        name: "ALIMENTADOR SECUNDÁRIO",
                        items: [
                            "Esteira - Tensionamento",
                            "Esteira - Desgaste",
                            "Rolos - Fixação",
                            "Rolos - Desgaste",
                            "Motores/Válvulas",
                            "Guia/Proteções"
                        ]
                    },
                    {
                        name: "LIMPADOR / EXTRATOR",
                        items: [
                            "Extrator primário - Pá/desgaste",
                            "Extrator primário - Fixação",
                            "Extrator secundário - Pá/desgaste",
                            "Extrator secundário - Fixação",
                            "Motores/Válvulas",
                            "Proteções"
                        ]
                    },
                    {
                        name: "ELEVADOR",
                        items: [
                            "Correntes - Tensionamento",
                            "Correntes - Desgaste",
                            "Aletas/Pás",
                            "Trilhos/Guias",
                            "Motores/Válvulas",
                            "Proteções"
                        ]
                    },
                    {
                        name: "SISTEMA HIDRÁULICO",
                        items: [
                            "Reservatório e filtros",
                            "Bombas hidráulicas",
                            "Válvulas/Distribuidores",
                            "Mangueiras/Flexíveis",
                            "Abraçadeiras/Conexões",
                            "Vazamentos/Pressão"
                        ]
                    },
                    {
                        name: "TRANSMISSÃO HIDROSTÁTICA",
                        items: [
                            "Hidrostatic drive - Bombas",
                            "Hidrostatic drive - Motores",
                            "Acoplamentos/Flanges",
                            "Vazamentos",
                            "Fixações"
                        ]
                    },
                    {
                        name: "CABINE / COMANDOS",
                        items: [
                            "Assento/ajustes",
                            "Cintos de segurança",
                            "Painel/indicadores",
                            "Comandos/joysticks",
                            "Ar condicionado",
                            "Limpeza/visibilidade"
                        ]
                    },
                    {
                        name: "CHASSI / ESTRUTURA",
                        items: [
                            "Trincas/Desgaste",
                            "Soldas/Fixações",
                            "Pontos de apoio",
                            "Proteções",
                            "Plataformas/escadas"
                        ]
                    },
                    {
                        name: "PICADOR",
                        items: [
                            "Rotores/Facas - Fixação",
                            "Rotores/Facas - Desgaste",
                            "Balanceamento/ruídos",
                            "Rolamentos/Conjuntos",
                            "Proteções"
                        ]
                    },
                    {
                        name: "DESCARGA",
                        items: [
                            "Tubo de descarga - Fixação",
                            "Tubo de descarga - Giro/acionamento",
                            "Defletor/bica - Ajustes",
                            "Cilindros/mangueiras",
                            "Proteções"
                        ]
                    },
                    {
                        name: "GUIAMENTO / AUTOPILOTO",
                        items: [
                            "Guias/antenas",
                            "Sensores de linha",
                            "Calibração",
                            "Funcionamento",
                            "Telemetria/GPS"
                        ]
                    },
                    {
                        name: "SISTEMA DE COMBUSTÍVEL",
                        items: [
                            "Tanque - Fixação",
                            "Tanque - Vazamentos",
                            "Bomba de combustível",
                            "Linhas/Conexões",
                            "Filtros",
                            "Tampa/vedação"
                        ]
                    },
                    {
                        name: "SISTEMA DE ARREFECIMENTO",
                        items: [
                            "Radiador",
                            "Ventiladores",
                            "Mangueiras/Abraçadeiras",
                            "Reservatório",
                            "Nível",
                            "Vazamentos"
                        ]
                    },
                    {
                        name: "SISTEMA DE LUBRIFICAÇÃO",
                        items: [
                            "Nível de óleo",
                            "Filtros",
                            "Linhas/Conexões",
                            "Pontos de graxa",
                            "Vazamentos"
                        ]
                    },
                    {
                        name: "TRANSMISSÃO FINAL",
                        items: [
                            "Redutores finais",
                            "Fixações",
                            "Vazamentos",
                            "Níveis",
                            "Proteções"
                        ]
                    },
                    {
                        name: "SEGURANÇA",
                        items: [
                            "Extintor",
                            "Alarme de ré",
                            "Iluminação",
                            "Sinalização",
                            "Etiquetas/Avisos"
                        ]
                    }
                ]
            },
            planter: {
                title: "Checklist de Reforma/Entressafra - Plantadora de Cana",
                sections: [
                    {
                        name: "PRIMÁRIA",
                        items: [
                            "Lavagem geral",
                            "Lubrificação geral"
                        ]
                    },
                    {
                        name: "ALIMENTADOR DE ADUBO",
                        items: [
                            "Verificar vazamento nas mangueiras",
                            "Verificar vazamento no motor hidráulico"
                        ]
                    },
                    {
                        name: "ALIMENTADOR DE TOLETE",
                        items: [
                            "Verificar conjunto mecânico / reparar se necessário"
                        ]
                    },
                    {
                        name: "MECÂNICO",
                        items: [
                            "Corredor - reparar se necessário",
                            "Esteira - reparar se necessário",
                            "Plataforma - reparar se necessário",
                            "Rolo açamador - reparar se necessário",
                            "Tandem - reparar se necessário",
                            "Tanque"
                        ]
                    },
                    {
                        name: "ELÉTRICA",
                        items: [
                            "Verificar câmera da esteira",
                            "Verificar câmera da esteira traseira",
                            "Verificar câmera do corredor",
                            "Verificar conectores das câmeras",
                            "Verificar passagem de cabos",
                            "Verificar funcionamento do monitor das câmeras",
                            "Verificar alimentação do monitor interface",
                            "Verificar sensor rotação",
                            "Verificar sensores de fim de curso",
                            "Reparar tomada elétrica"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - ALIMENTADOR DE ADUBO",
                        items: [
                            "Verificar desgaste nas engrenagens",
                            "Verificar eixo das engrenagens",
                            "Verificar suporte do motor"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - ALIMENTADOR DE TOLETE",
                        items: [
                            "Verificar estrutura/ajustes"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - CAIXA DE ADUBO",
                        items: [
                            "Estrutura/vedações",
                            "Fixações"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - CHASSI",
                        items: [
                            "Trincas/soldas",
                            "Fixações",
                            "Nivelamento/estado"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - CORREDOR",
                        items: [
                            "Estrutura",
                            "Proteções/chapas"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - ENGATE",
                        items: [
                            "Estrutura",
                            "Pinos",
                            "Folgas"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - ESTEIRA",
                        items: [
                            "Estrutura",
                            "Guias",
                            "Proteções"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - GERAL",
                        items: [
                            "Reparos e reforços gerais",
                            "Soldas/chapas"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - PLATAFORMA",
                        items: [
                            "Estrutura",
                            "Fixações"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - ROLO DESTROÇADOR",
                        items: [
                            "Estrutura",
                            "Rolamentos",
                            "Fixações"
                        ]
                    },
                    {
                        name: "CALDEIRARIA - TANDEM",
                        items: [
                            "Estrutura",
                            "Fixações",
                            "Rolamentos"
                        ]
                    },
                    {
                        name: "PNEUS",
                        items: [
                            "Calibragem",
                            "Medição de sulco"
                        ]
                    },
                    {
                        name: "FUNILARIA",
                        items: [
                            "Adesivar",
                            "Pintura"
                        ]
                    }
                ]
            },
            distributor: {
                title: "Checklist de Reforma/Entressafra - Distribuidora de Cana",
                sections: [
                    {
                        name: "PRIMÁRIA",
                        items: [
                            "Lavagem geral",
                            "Lubrificação geral",
                            "Tandem"
                        ]
                    },
                    {
                        name: "MECÂNICO",
                        items: [
                            "Hidráulico",
                            "Inspeção",
                            "Reparar se necessário",
                            "Tandem - reparar se necessário"
                        ]
                    },
                    {
                        name: "ELÉTRICA",
                        items: [
                            "Revisar painel instrumentos/câmera",
                            "Revisar tomadas/pinos",
                            "Verificar chicotes elétricos",
                            "Verificar sinalizações e iluminação",
                            "Revisar câmera - reparar se necessário"
                        ]
                    },
                    {
                        name: "CALDEIRARIA",
                        items: [
                            "Cabeçalho - reparar se necessário"
                        ]
                    },
                    {
                        name: "PNEUS",
                        items: [
                            "Calibragem",
                            "Medição de sulco",
                            "Conferir parafusos e porcas",
                            "Reparar rodas",
                            "Revisar eixo/mancal",
                            "Reparar válvula",
                            "Balanceamento"
                        ]
                    },
                    {
                        name: "FUNILARIA",
                        items: [
                            "Pintura",
                            "Número/frota e logotipo"
                        ]
                    }
                ]
            },
            tortao: {
                title: "Checklist de Reforma/Entressafra - Tortão",
                sections: [
                    {
                        name: "PRIMÁRIA",
                        items: [
                            "Lavagem geral",
                            "Lubrificação geral"
                        ]
                    },
                    {
                        name: "MECÂNICO",
                        items: [
                            "Cesto - reparar se necessário",
                            "Hidráulico",
                            "Inspeção",
                            "Tandem - reparar se necessário"
                        ]
                    },
                    {
                        name: "CALDEIRARIA",
                        items: [
                            "Cesto - reparar se necessário",
                            "Cabeçalho - reparar se necessário"
                        ]
                    },
                    {
                        name: "PNEUS",
                        items: [
                            "Calibrar pneus e medir sulco",
                            "Colocar tampa de válvula",
                            "Conferir parafusos e porcas",
                            "Fazer rodízio",
                            "Inventariar equipamento",
                            "Reapertar rodas"
                        ]
                    },
                    {
                        name: "FUNILARIA",
                        items: [
                            "Pintura/Número frota e logotipo"
                        ]
                    }
                ]
            },
            cobridores: {
                title: "Checklist de Reforma/Entressafra - Cobridores",
                sections: [
                    {
                        name: "TIPO DE SERVIÇO",
                        items: [
                            "Trocar buchas e braços",
                            "Trocar discos de corte",
                            "Montagem",
                            "Revisar tanques, suportes e fixações; reparar se necessário",
                            "Corrigir trincas",
                            "Catalogar peças"
                        ]
                    }
                ]
            },
           
            trailer: {
                title: "Checklist de Liberação - Reboque/Semi-reboque",
                sections: [
                    {
                        name: "CHASSI",
                        items: [
                            "Nivelamento, estado e solda do chassi",
                            "Suporte da placa",
                            "Suporte da corrente",
                            "Suporte do documento",
                            "Trincas geral",
                            "Trincas mesa 5° roda",
                            "Viga frontal / traseira",
                            "Vigas laterais",
                            "Mancais de basculamento",
                            "Pino rei"
                        ]
                    },
                    {
                        name: "ELÉTRICO",
                        items: [
                            "Chicote elétrico",
                            "Iluminação traseira",
                            "Iluminação lateral (esquerdo e direito)",
                            "Funcionamento e limpeza das conexões"
                        ]
                    },
                    {
                        name: "FREIO",
                        items: [
                            "Freio pneumático (válvula, mangueiras)",
                            "Flexíveis e câmaras de freio",
                            "Desgastes da lona de freio",
                            "Sistema de freio",
                            "Reservatório de ar"
                        ]
                    }
                ]
            },
            transbordo: {
                title: "Checklist de Reforma/Entressafra - Transbordo de Cana",
                sections: [
                    {
                        name: "PRIMÁRIA",
                        items: [
                            "Lavagem geral",
                            "Lubrificação geral"
                        ]
                    },
                    {
                        name: "MECÂNICO",
                        items: [
                            "Desmontar cubos de roda",
                            "Desmontar tandem",
                            "Verificar tandem - rolamentos",
                            "Suspensão - pinos/buchas",
                            "Eixos/mancais",
                            "Conferir parafusos e porcas"
                        ]
                    },
                    {
                        name: "HIDRÁULICO",
                        items: [
                            "Reservatório e filtros",
                            "Bombas hidráulicas",
                            "Válvulas/Distribuidores",
                            "Mangueiras/Flexíveis",
                            "Abraçadeiras/Conexões",
                            "Vazamentos/Pressão"
                        ]
                    },
                    {
                        name: "ELÉTRICA",
                        items: [
                            "Chicotes elétricos",
                            "Iluminação traseira",
                            "Iluminação lateral",
                            "Tomadas/Pinos",
                            "Painel/Monitoramento"
                        ]
                    },
                    {
                        name: "CALDEIRARIA",
                        items: [
                            "Chassi/Estrutura",
                            "Soldas/Chapas",
                            "Proteções",
                            "Mancais de basculamento",
                            "Engate"
                        ]
                    },
                    {
                        name: "FREIO",
                        items: [
                            "Válvulas/Mangueiras",
                            "Flexíveis/Câmaras",
                            "Lonas/Pastilhas",
                            "Reservatório de ar"
                        ]
                    },
                    {
                        name: "PNEUS",
                        items: [
                            "Calibragem",
                            "Medição de sulco",
                            "Emparelhamento",
                            "Balanceamento"
                        ]
                    },
                    {
                        name: "FUNILARIA",
                        items: [
                            "Pintura",
                            "Número/frota e adesivos"
                        ]
                    }
                ]
            }
        };
            manutencao: [
                'Troca de filtros',
                'Verificação de fluidos',
                'Inspeção geral da estrutura',
                'Teste de sistemas',
                'Substituição de peças',
                'Calibragem e ajustes',
                'Limpeza geral',
                'Testes de funcionalidade'
            ]
        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            initTheme();
            checkAuthState();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            hydrateCCTSubsections();
        });

        // Inicializar aplicação
        document.addEventListener('DOMContentLoaded', function() {
            checkAuthState();
            updateDateTime();
            setInterval(updateDateTime, 60000);
        });

        // Verificar estado de autenticação
        async function checkAuthState() {
            showLoading(true);
            
            try {
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    console.error('Erro ao verificar sessão:', error);
                    if (!isOnline()) {
                        const cached = getCachedUser();
                        currentUser = cached || getOfflineUser();
                        showApp();
                        return;
                    }
                    showLogin();
                    return;
                }
                
                if (session) {
                    currentUser = session.user;
                    showApp();
                } else {
                    if (!isOnline()) {
                        const cached = getCachedUser();
                        currentUser = cached || getOfflineUser();
                        showApp();
                    } else {
                        showLogin();
                    }
                }
            } catch (error) {
                console.error('Erro ao verificar autenticação:', error);
                const cached = getCachedUser();
                if (!isOnline()) {
                    currentUser = cached || getOfflineUser();
                    showApp();
                } else {
                    if (cached) { currentUser = cached; showApp(); } else { showLogin(); }
                }
            } finally {
                showLoading(false);
            }
        }

        // Mostrar tela de login
        function showLogin() {
            document.getElementById('loginModal').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }

        // Mostrar aplicação principal
        function getDisplayName(u) {
            const fn = (u?.user_metadata?.first_name || '').trim();
            const ln = (u?.user_metadata?.last_name || '').trim();
            if (fn || ln) return `${fn} ${ln}`.trim();
            return (u?.email || '').split('@')[0];
        }

        function showApp() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userEmail').textContent = currentUser.email;
            const mech = document.getElementById('mecanico');
            if (mech) { mech.value = getDisplayName(currentUser); }
            if (!((currentUser.user_metadata?.first_name||'').trim() && (currentUser.user_metadata?.last_name||'').trim())) {
                const pm = document.getElementById('profileModal');
                if (pm) pm.classList.remove('hidden');
            }
            loadAccessControls().then(() => applyAccessControls());
            ensureUserRecord().then(() => { startPresence(); });
            loadInitialData();
            setupRealtime();
            startPolling();
            const last = localStorage.getItem('lastSection');
            if (last) { showSection(last); }
            else if (isRestrictedUser()) { showSection('cct_coque'); }
            if (isAdmin()) { const b = document.getElementById('adminNavBtn'); if (b) b.classList.remove('hidden'); }
            bindDraftPersistence();
        }

        function bindDraftPersistence() {
            const fields = [
                { id: 'mecanico', key: 'draft_mecanico' },
                { id: 'frotaSelect', key: 'draft_frota' },
                { id: 'calObservacoes', key: 'draft_cal_observacoes' }
            ];
            fields.forEach(f => {
                const el = document.getElementById(f.id);
                if (!el) return;
                try {
                    const saved = localStorage.getItem(f.key);
                    if (saved !== null && String(el.value || '') === '') { el.value = saved; }
                } catch {}
                try {
                    el.addEventListener('input', (e) => {
                        const v = e.target && 'value' in e.target ? e.target.value : '';
                        try { localStorage.setItem(f.key, String(v ?? '')); } catch {}
                    });
                    el.addEventListener('change', (e) => {
                        const v = e.target && 'value' in e.target ? e.target.value : '';
                        try { localStorage.setItem(f.key, String(v ?? '')); } catch {}
                    });
                } catch {}
            });
        }

        // Forgot Password Logic
        function showForgotPassword() {
            document.getElementById('loginModal').classList.add('hidden');
            document.getElementById('forgotPasswordModal').classList.remove('hidden');
        }

        function closeForgotPassword() {
            document.getElementById('forgotPasswordModal').classList.add('hidden');
            document.getElementById('loginModal').classList.remove('hidden');
        }

        document.getElementById('forgotPasswordForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const email = document.getElementById('forgotEmail').value;
            
            showLoading(true);
            try {
                // Determine the current URL to build the redirect URL
                const currentUrl = window.location.href;
                // Handle trailing slash or file name
                const baseUrl = currentUrl.substring(0, currentUrl.lastIndexOf('/') + 1);
                const redirectUrl = baseUrl + 'reset-password.html';

                const { error } = await supabase.auth.resetPasswordForEmail(email, {
                    redirectTo: redirectUrl
                });
                
                if (error) throw error;
                
                showFloatingNotification('success', 'Email de recuperação enviado! Verifique sua caixa de entrada.');
                closeForgotPassword();
            } catch (error) {
                console.error('Erro ao enviar recuperação:', error);
                showFloatingNotification('error', error.message || 'Erro ao enviar email.');
            } finally {
                showLoading(false);
            }
        });

        // Alternar entre login e cadastro
        function toggleAuthMode() {
            const loginForm = document.getElementById('loginForm');
            const loginTitle = document.querySelector('#loginModal h2');
            const loginButton = loginForm.querySelector('button[type="submit"]');
            const toggleText = document.querySelector('#loginModal .text-center p');
            const firstNameGroup = document.getElementById('firstNameGroup');
            const lastNameGroup = document.getElementById('lastNameGroup');
            
            if (loginForm.getAttribute('data-mode') === 'login') {
                // Mudar para modo cadastro
                loginForm.setAttribute('data-mode', 'signup');
                loginTitle.textContent = 'Criar Conta';
                loginButton.textContent = 'Cadastrar';
                toggleText.innerHTML = 'Já tem uma conta? <button onclick="toggleAuthMode()" class="text-primary hover:text-primary-dark font-medium">Faça login</button>';
                if (firstNameGroup) firstNameGroup.classList.remove('hidden');
                if (lastNameGroup) lastNameGroup.classList.remove('hidden');
            } else {
                // Mudar para modo login
                loginForm.setAttribute('data-mode', 'login');
                loginTitle.textContent = 'Sistema de Checklist';
                loginButton.textContent = 'Entrar';
                toggleText.innerHTML = 'Não tem uma conta? <button onclick="toggleAuthMode()" class="text-primary hover:text-primary-dark font-medium">Cadastre-se</button>';
                if (firstNameGroup) firstNameGroup.classList.add('hidden');
                if (lastNameGroup) lastNameGroup.classList.add('hidden');
            }
        }

        // Processar formulário de autenticação
        document.getElementById('loginForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const isSignUp = this.getAttribute('data-mode') === 'signup';
            const firstName = document.getElementById('firstName')?.value || '';
            const lastName = document.getElementById('lastName')?.value || '';
            
            showLoading(true);
            
            try {
                if (!window.supabase || !supabase) {
                    throw new Error('Cliente Supabase não inicializado. Verifique a URL e a chave.');
                }
                let result;
                
                if (isSignUp) {
                    if (!firstName.trim() || !lastName.trim()) {
                        showLoading(false);
                        showCustomAlert('Informe nome e sobrenome para cadastro.');
                        return;
                    }
                    result = await supabase.auth.signUp({
                        email,
                        password,
                        options: { data: { first_name: firstName.trim(), last_name: lastName.trim() } }
                    });
                } else {
                    result = await supabase.auth.signInWithPassword({
                        email,
                        password,
                    });
                }
                
                const { data, error } = result;
                
                if (error) {
                    throw error;
                }
                
                if (isSignUp && data.user && !data.session) {
                    showFloatingNotification('success', 'Conta criada com sucesso! Verifique seu email para confirmar.');
                    toggleAuthMode(); // Voltar para tela de login
                } else {
                    currentUser = data.user;
                    setCachedUser(data.user);
                    showApp();
                    const dn = (currentUser.user_metadata && ((currentUser.user_metadata.first_name||'').trim() + ' ' + (currentUser.user_metadata.last_name||'').trim()).trim()) || currentUser.email.split('@')[0];
                    showFloatingNotification('success', `Bem-vindo, ${dn}!`);
                }
            } catch (error) {
                console.error('Erro de autenticação:', error);
                
                // Fallback para modo offline em caso de erro de conexão ou CORS
                if (error.message && (error.message.includes('Failed to fetch') || error.message.includes('NetworkError') || error.message.includes('CORS'))) {
                    if (confirm('Erro de conexão com o servidor. Deseja entrar em Modo Offline?')) {
                        const offlineUser = { 
                            id: 'offline', 
                            email: email || 'offline@user.com', 
                            user_metadata: { first_name: 'Modo', last_name: 'Offline' },
                            aud: 'authenticated',
                            role: 'authenticated'
                        };
                        currentUser = offlineUser;
                        setCachedUser(offlineUser);
                        showApp();
                        showFloatingNotification('warning', 'Entrando em Modo Offline. Algumas funcionalidades podem estar limitadas.');
                        // Carregar dados locais
                        setTimeout(loadInitialData, 100);
                        return;
                    }
                }

                showCustomAlert(error.message || 'Falha na autenticação.');
                showFloatingNotification('error', error.message);
            } finally {
                showLoading(false);
            }
        });

        const loginSubmitBtn = document.getElementById('loginSubmit');
        if (loginSubmitBtn) {
            loginSubmitBtn.addEventListener('click', function(e) {
                e.preventDefault();
                const form = document.getElementById('loginForm');
                if (form) { form.requestSubmit(); }
            });
        }

        // Logout
        async function logout() {
            showLoading(true);
            
            try {
                const { error } = await supabase.auth.signOut();
                
                if (error) {
                    throw error;
                }
                
                currentUser = null;
                inspections = [];
                clearCachedUser();
                if (realtimeChannel) { try { supabase.removeChannel(realtimeChannel); } catch (_) {} realtimeChannel = null; }
                if (systemBroadcastChannel) { try { supabase.removeChannel(systemBroadcastChannel); } catch (_) {} systemBroadcastChannel = null; }
                if (pollingTimer) { clearInterval(pollingTimer); pollingTimer = null; }
                showLogin();
                showFloatingNotification('success', 'Logout realizado com sucesso!');
            } catch (error) {
                console.error('Erro ao fazer logout:', error);
                showFloatingNotification('error', 'Erro ao fazer logout');
            } finally {
                showLoading(false);
            }
        }

        async function saveProfile() {
            const fn = (document.getElementById('pmFirstName')?.value || '').trim();
            const ln = (document.getElementById('pmLastName')?.value || '').trim();
            if (!fn || !ln) { showCustomAlert('Preencha nome e sobrenome.'); return; }
            showLoading(true);
            try {
                const { data, error } = await supabase.auth.updateUser({ data: { first_name: fn, last_name: ln } });
                if (error) { throw error; }
                currentUser = data.user || currentUser;
                setCachedUser(currentUser);
                const mech = document.getElementById('mecanico');
                if (mech) mech.value = getDisplayName(currentUser);
                document.getElementById('profileModal').classList.add('hidden');
                showFloatingNotification('success', 'Perfil atualizado.');
            } catch (e) {
                showCustomAlert(e.message || 'Falha ao atualizar perfil.');
            } finally {
                showLoading(false);
            }
        }

        const pmSaveBtn = document.getElementById('pmSave');
        if (pmSaveBtn) { pmSaveBtn.addEventListener('click', function() { saveProfile(); }); }
        const pmCancelBtn = document.getElementById('pmCancel');
        if (pmCancelBtn) { pmCancelBtn.addEventListener('click', function() { document.getElementById('profileModal').classList.add('hidden'); }); }

        // Carregar dados iniciais
        async function loadInitialData() {
            showLoading(true);
            try {
                // Hidratar imediatamente com cache para acelerar a renderização
                try {
                    const cached = dedupeInspections(getCachedInspections());
                    inspections = cached || [];
                    irrigInspections = dedupeInspections(getCachedIrrInspections());
                    notifications = getCachedNotifications();
                    updateNotificationBadge();
                    updateStats();
                    updateDashboardStats();
                    updateAnalytics();
                    setTimeout(initializeCharts, 250);
                } catch(_) {}

                // Buscar online em paralelo e substituir cache quando disponível
                if (isOnline()) {
                    const fetchIns = supabase
                        .from('inspections')
                        .select('id,data,tipo,frota,mecanico,observacao,items,results,created_at,local_id')
                        .order('created_at', { ascending: false })
                        .limit(300);
                    const fetchIrr = supabase
                        .from('irrig_inspections')
                        .select('id,data,tipo,frota,mecanico,observacao,items,results,created_at,local_id')
                        .order('created_at', { ascending: false })
                        .limit(300);
                    const [resp, respIrr] = await Promise.allSettled([fetchIns, fetchIrr]);
                    if (resp.status === 'fulfilled' && !resp.value.error) {
                        const data = dedupeInspections(resp.value.data || []);
                        inspections = data || [];
                        setCachedInspections(inspections);
                    }
                    if (respIrr.status === 'fulfilled' && !respIrr.value.error) {
                        irrigInspections = dedupeInspections(respIrr.value.data || []);
                        setCachedIrrInspections(irrigInspections);
                    }
                } else {
                    showFloatingNotification('warning', 'Sem internet. Exibindo dados em cache.');
                }

                // Equipamentos e sementes em paralelo
                await loadEquipments();
                await Promise.all([
                    seedTrucks(),
                    seedHarvesters(),
                    seedTractors(),
                    seedPlanters(),
                    seedDistributors(),
                    seedTrailers(),
                    seedTransbordos(),
                    seedCobridores(),
                    seedTortao()
                ].map(p => p.catch ? p : Promise.resolve()));

                // Sincronizações pendentes em paralelo
                await Promise.all([
                    syncPendingInspections(),
                    syncPendingIrrInspections(),
                    syncPendingEquipments(),
                    syncPendingCalibragem(),
                    syncPendingControle3p()
                ].map(p => p.catch ? p : Promise.resolve()));

                updateStats();
                updateDashboardStats();
                updateAnalytics();
                setTimeout(initializeCharts, 250);
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
                showFloatingNotification('error', 'Erro ao carregar dados');
            } finally {
                showLoading(false);
            }
        }

        // Salvar inspeção no Supabase
        async function saveInspection() {
            await ensureUserRecord();
            if (!isApprovedUser()) { showCustomAlert('Aguardando aprovação do administrador.'); return; }
            if (savingInspection) return;
            // Validação do formulário
            const data = document.getElementById('dataInspecao').value;
            const frotaSel = document.getElementById('frotaSelect');
            const frotaCustom = document.getElementById('frotaCustom');
            const frota = frotaSel && frotaSel.value === 'custom' ? (frotaCustom.value || '').trim() : (frotaSel ? frotaSel.value.trim() : (document.getElementById('frota')?.value || '').trim());
            const mecanico = document.getElementById('mecanico').value.trim();
            const observacao = (document.getElementById('observacao')?.value || '').trim();
            const reformaStatus = (document.getElementById('reformaStatus')?.value || 'nao') === 'sim';
            const today = new Date().toISOString().split('T')[0];
            
            if (!data || !frota || !mecanico) {
                showCustomAlert('Por favor, preencha todos os campos obrigatórios.');
                return;
            }
            if (data !== today) {
                showCustomAlert('Lançamento permitido apenas para a data de hoje.');
                showFloatingNotification('warning', 'Data inválida: selecione a data de hoje.');
                return;
            }
            try {
                const now = Date.now();
                const windowMs = 30 * 60 * 1000;
                const recentLocal = (inspections || [])
                    .filter(i => i.tipo === currentEquipment && String(i.frota) === String(frota))
                    .sort((a,b) => new Date(b.created_at) - new Date(a.created_at))[0];
                let recentAt = recentLocal ? new Date(recentLocal.created_at).getTime() : 0;
                if (isOnline()) {
                    const sinceIso = new Date(now - windowMs).toISOString();
                    const resp = await supabase
                        .from('inspections')
                        .select('created_at')
                        .eq('tipo', currentEquipment)
                        .eq('frota', frota)
                        .gte('created_at', sinceIso)
                        .order('created_at', { ascending: false })
                        .limit(1);
                    if (!resp.error && resp.data && resp.data.length) {
                        recentAt = Math.max(recentAt, new Date(resp.data[0].created_at).getTime());
                    }
                }
                if (recentAt && (now - recentAt) < windowMs) {
                    const remainingMs = windowMs - (now - recentAt);
                    const mins = Math.floor(remainingMs / 60000);
                    const secs = Math.floor((remainingMs % 60000) / 1000);
                    showFloatingNotification('warning', `Já existe um checklist para este equipamento nos últimos 30 min. Tente novamente em ${mins}m ${secs}s.`);
                    showCustomAlert(`Registro bloqueado por 30 minutos. Tempo restante: ${mins} minutos e ${secs} segundos.`);
                    return;
                }
            } catch (_) {}
            
            const completedItems = currentInspection.items.filter(item => item.status !== null);
            if (completedItems.length === 0) {
                showCustomAlert('Por favor, marque pelo menos um item do checklist.');
                return;
            }

            showLoading(true);
            savingInspection = true;
            const saveBtns = Array.from(document.querySelectorAll('button[onclick="saveInspection()"]'));
            saveBtns.forEach(b => { b.disabled = true; });

            const user = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
            const isAuthenticated = !!(user && user.id && user.id !== 'offline');
            const localId = (crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString());
            const inspection = {
                data: data,
                tipo: currentEquipment,
                frota: frota,
                mecanico: mecanico,
                observacao: observacao,
                items: currentInspection.items,
                results: currentInspection.results,
                user_id: user.id,
                created_at: new Date().toISOString(),
                local_id: localId
            };
            try {
                const idxReforma = inspection.items.length;
                inspection.items.push({ id: idxReforma, name: 'Status: Equipamento em reforma', section: 'Geral', status: reformaStatus ? 'ok' : 'notok', note: reformaStatus ? 'Sim' : 'Não' });
            } catch(_) {}
            const dbInspection = { data: inspection.data, tipo: inspection.tipo, frota: inspection.frota, mecanico: inspection.mecanico, observacao: inspection.observacao, items: inspection.items, results: inspection.results, user_id: inspection.user_id, created_at: inspection.created_at, local_id: inspection.local_id };

            try {
                if (isOnline() && isAuthenticated) {
                    const { error } = await supabase
                        .from('inspections')
                        .upsert([dbInspection], { onConflict: 'local_id' });
                    if (error) {
                        const offlineItem = { ...inspection, offline: true };
                        offlineItem.id = offlineItem.local_id;
                        addOrReplaceInspection(offlineItem);
                        queueInspection(offlineItem);
                        
                        updateStats();
                        updateAnalytics();
                        showFloatingNotification('warning', `Erro ao salvar online: ${error.message}. Salvo offline e será sincronizado.`);
                        clearForm();
                        backToSelection();
                        return;
                    }
                    await loadInitialData();
                    showModal('successModal');
                    try { localStorage.removeItem('cctDraft'); } catch(_) {}
                    clearForm();
                    backToSelection();
                    showFloatingNotification('success', 'Inspeção salva com sucesso!');
                    try { await supabase.from('system_events').insert([{ type:'new_inspection', title:'Nova inspeção', message: `${inspection.tipo||''} • ${inspection.frota||''} • ${inspection.mecanico||''}`, payload: { tipo: inspection.tipo||'', frota: inspection.frota||'', mecanico: inspection.mecanico||'', data: inspection.data||'', local_id: inspection.local_id||'', modulo: 'cct' } }]); } catch(_) {}
                    try { systemBroadcastChannel && systemBroadcastChannel.send({ type:'broadcast', event:'new_inspection', payload: { modulo:'cct', tipo: inspection.tipo||'', frota: inspection.frota||'', mecanico: inspection.mecanico||'', data: inspection.data||'', local_id: inspection.local_id||'' } }); } catch(_) {}
                    try { pushNotification('info', 'Nova inspeção', inspection.frota ? `Inspeção lançada para ${inspection.frota}` : 'Inspeção lançada', { modulo:'cct', tipo: inspection.tipo||'', frota: inspection.frota||'', mecanico: inspection.mecanico||'', data: inspection.data||'', local_id: inspection.local_id||'' }); } catch(_) {}
                } else {
                    const offlineItem = { ...inspection, offline: true };
                    offlineItem.id = offlineItem.local_id;
                    addOrReplaceInspection(offlineItem);
                    queueInspection(offlineItem);
                    
                    updateStats();
                    updateAnalytics();
                    try { localStorage.removeItem('cctDraft'); } catch(_) {}
                    clearForm();
                    backToSelection();
                    const msg = !isOnline() ? 'Sem internet. Inspeção salva offline e será sincronizada.' : 'Usuário não autenticado. Inspeção salva offline e será sincronizada.';
                    showFloatingNotification('warning', msg);
                    try { pushNotification('info', 'Nova inspeção (offline)', inspection.frota ? `Inspeção lançada para ${inspection.frota}` : 'Inspeção lançada', { modulo:'cct', tipo: inspection.tipo||'', frota: inspection.frota||'', mecanico: inspection.mecanico||'', data: inspection.data||'', local_id: inspection.local_id||'' }); } catch(_) {}
                }
            } catch (error) {
                const offlineItem2 = { ...inspection, offline: true };
                offlineItem2.id = offlineItem2.local_id;
                addOrReplaceInspection(offlineItem2);
                queueInspection(offlineItem2);
                updateStats();
                updateAnalytics();
                showFloatingNotification('warning', 'Falha ao salvar online. Inspeção salva offline e será sincronizada.');
                try { pushNotification('info', 'Nova inspeção (offline)', inspection.frota ? `Inspeção lançada para ${inspection.frota}` : 'Inspeção lançada'); } catch(_) {}
                try { localStorage.removeItem('cctDraft'); } catch(_) {}
                clearForm();
                backToSelection();
            } finally {
                showLoading(false);
                savingInspection = false;
                saveBtns.forEach(b => { b.disabled = false; });
            }
        }

        // Exportar dados
        async function exportData() {
            showLoading(true);
            
            try {
                let data = [];
                if (isOnline()) {
                    const resp = await supabase
                        .from('inspections')
                        .select('*')
                        .order('created_at', { ascending: false });
                    if (resp.error) { throw resp.error; }
                    data = resp.data || [];
                } else {
                    data = inspections.slice();
                }
                const exportData = {
                    inspections: data || [],
                    stats: {
                        total: data.length,
                        today: data.filter(i => i.data === new Date().toISOString().split('T')[0]).length,
                        average: data.length > 0 ? 
                            data.reduce((sum, i) => sum + i.results.percentage, 0) / data.length : 0
                    },
                    exportDate: new Date().toISOString(),
                    exportedBy: currentUser.email
                };
                
                const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `checklist-export-${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                showFloatingNotification('success', 'Dados exportados com sucesso!');
            } catch (error) {
                console.error('Erro ao exportar dados:', error);
                showFloatingNotification('error', 'Erro ao exportar dados');
            } finally {
                showLoading(false);
            }
        }

        // Mostrar/ocultar loading
        function showLoading(show) {
            const overlay = document.getElementById('loadingOverlay');
            if (show) {
                overlay.classList.remove('hidden');
            } else {
                overlay.classList.add('hidden');
            }
        }

        const fallbackTanks = [
            { frota: '6290', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6291', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6292', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6293', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6294', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6295', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6296', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6297', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6298', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6299', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6300', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6301', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6302', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6303', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6304', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6305', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6306', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6307', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6308', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6309', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6310', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6311', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6312', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6313', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6314', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6315', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6316', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6317', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6318', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6319', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6320', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6321', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6322', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6323', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6324', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6325', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6326', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6327', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6328', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' },
            { frota: '6329', descricao: 'Reboque Tanque Rodofort', tipo: 'tanques' }
        ];

        async function loadEquipments() {
            let fetched = [];
            try {
                if (isOnline()) {
                    const resp = await supabase
                        .from('equipments')
                        .select('*')
                        .order('created_at', { ascending: false });
                    if (!resp.error) {
                        fetched = resp.data || [];
                    } else {
                        fetched = getCachedEquipments() || [];
                    }
                } else {
                    fetched = getCachedEquipments() || [];
                }
            } catch (_) {
                fetched = getCachedEquipments() || [];
            }
            
            // Merge fallback tanks
            const map = new Map();
            fetched.forEach(e => map.set(String(e.frota), e));
            fallbackTanks.forEach(e => {
                if (!map.has(String(e.frota))) map.set(String(e.frota), { ...e, status: 'ativo' });
            });
            equipments = Array.from(map.values());
            setCachedEquipments(equipments);
        }

        function typeAliases(t) {
            const map = {
                caminhao: ['caminhao','truck'],
                trator: ['trator','tractor'],
                colhedora: ['colhedora','harvester'],
                reboque: ['reboque','trailer'],
                plantadora: ['plantadora','planter'],
                distribuidora: ['distribuidora','distributor'],
                manutencao: ['manutencao','maintenance'],
                transbordo: ['transbordo'],
                cct_coque: ['cct_coque','cctCoque'],
                cobridores: ['cobridores'],
                tanques: ['tanques', 'irrigacao_tanques']
            };
            return map[t] || [t];
        }

        function populateFrotaOptions(type) {
            const sel = document.getElementById('frotaSelect');
            if (!sel) return;
            const aliases = typeAliases(type);
            const list = (equipments || []).filter(e => aliases.includes(e.tipo || e.setor) && (e.status || 'ativo') === 'ativo');
            const opts = ['<option value="">Selecione uma frota</option>', '<option value="custom">Outro (digitar)</option>']
                .concat(list.map(e => `<option value="${e.frota}">${e.frota}${e.descricao ? ' - ' + e.descricao : ''}</option>`));
            sel.innerHTML = opts.join('');
            const custom = document.getElementById('frotaCustom');
            if (custom) custom.classList.add('hidden');
        }

        function bindFrotaSelect() {
            const sel = document.getElementById('frotaSelect');
            const custom = document.getElementById('frotaCustom');
            if (!sel || sel._bound) return;
            sel.addEventListener('change', () => {
                if (custom) {
                    if (sel.value === 'custom') custom.classList.remove('hidden'); else custom.classList.add('hidden');
                }
            });
            sel._bound = true;
        }

        function populateFrotaOptionsFor(type, selectId, customId) {
            const sel = document.getElementById(selectId);
            if (!sel) return;
            const aliases = typeAliases(type);
            const list = (equipments || []).filter(e => aliases.includes(e.tipo || e.setor) && (e.status || 'ativo') === 'ativo');
            const opts = ['<option value="">Selecione uma frota</option>', '<option value="custom">Outro (digitar)</option>']
                .concat(list.map(e => `<option value="${e.frota}">${e.frota}${e.descricao ? ' - ' + e.descricao : ''}</option>`));
            sel.innerHTML = opts.join('');
            const custom = document.getElementById(customId);
            if (custom) custom.classList.add('hidden');
        }

        function bindFrotaSelectFor(selectId, customId) {
            const sel = document.getElementById(selectId);
            const custom = document.getElementById(customId);
            if (!sel || sel._bound) return;
            sel.addEventListener('change', () => {
                if (custom) {
                    if (sel.value === 'custom') custom.classList.remove('hidden'); else custom.classList.add('hidden');
                }
            });
            sel._bound = true;
        }

        function showHistoricoTab(which) {
            const cal = document.getElementById('histCalList');
            const c3p = document.getElementById('histC3pList');
            const tCal = document.getElementById('histTabCal');
            const tC3p = document.getElementById('histTabC3p');
            if (!cal || !c3p || !tCal || !tC3p) return;
            if (which === 'c3p') {
                cal.classList.add('hidden');
                c3p.classList.remove('hidden');
                tCal.classList.remove('active');
                tC3p.classList.add('active');
            } else {
                c3p.classList.add('hidden');
                cal.classList.remove('hidden');
                tC3p.classList.remove('active');
                tCal.classList.add('active');
            }
        }

        async function loadHistoricoPneus() {
            try {
                const status = document.getElementById('histStatus');
                if (status) status.textContent = 'Carregando...';
                await loadEquipments();
                const tipo = document.getElementById('histEquipTipo')?.value || 'all';
                const frotaSel = document.getElementById('histFrotaSelect');
                const frotaCus = document.getElementById('histFrotaCustom');
                const frota = (frotaSel && frotaSel.value === 'custom') ? (frotaCus?.value || '') : (frotaSel?.value || '');
                const di = document.getElementById('histDataIni')?.value || '';
                const df = document.getElementById('histDataFim')?.value || '';
                const calRows = document.getElementById('histCalRows');
                const c3pRows = document.getElementById('histC3pRows');
                const toDate = s => { try { return new Date(s); } catch(_) { return null; } };
                const inRange = (dt) => {
                    const dti = di ? new Date(di+'T00:00:00') : null;
                    const dtf = df ? new Date(df+'T23:59:59') : null;
                    if (dti && dt < dti) return false;
                    if (dtf && dt > dtf) return false;
                    return true;
                };
                let calList = [];
                let c3pList = [];
                const online = isOnline();
                if (online) {
                    const calResp = await supabase.from('calibragem').select('*').order('created_at', { ascending: false }).limit(100);
                    const c3pResp = await supabase.from('controle_3p').select('*').order('created_at', { ascending: false }).limit(100);
                    calList = (calResp.data || []);
                    c3pList = (c3pResp.data || []);
                }
                const pendCal = getPendingCalibragem();
                const pendC3p = getPendingControle3p();
                calList = [...pendCal, ...calList];
                c3pList = [...pendC3p, ...c3pList];
                const matchTipo = (rec) => tipo === 'all' || String(rec.header?.equipamento || '').toLowerCase().includes(tipo);
                const matchFrota = (rec) => !frota || String(rec.header?.frota || '') === frota;
                const fmtDate = (s) => { try { const d = new Date(s || rec.header?.data_ini); return d.toLocaleDateString('pt-BR'); } catch(_) { return s || ''; } };
                const renderCal = calList
                    .filter(rec => matchTipo(rec) && matchFrota(rec) && inRange(toDate(rec.created_at || rec.header?.data_ini || new Date())))
                    .map(rec => {
                        const d = fmtDate(rec.created_at || rec.header?.data_ini);
                        const f = rec.header?.frota || '';
                        const e = rec.header?.equipamento || '';
                        const u = rec.user_id || '';
                        const lid = String(rec.local_id || rec.id || '');
                        return `
                            <div class="py-3 flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">${f} — ${e}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${d}${rec.offline ? ' • Offline' : ''}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300" onclick="viewCalibragem('${lid}')">Ver</button>
                                    <button class="px-2 py-1 bg-yellow-500 text-white rounded-md" onclick="openEditCalibragem('${lid}')">Editar</button>
                                    <button class="px-2 py-1 bg-red-600 text-white rounded-md" onclick="deleteCalibragem('${lid}')">Excluir</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                const renderC3p = c3pList
                    .filter(rec => matchTipo(rec) && matchFrota(rec) && inRange(toDate(rec.created_at || rec.header?.data_ini || new Date())))
                    .map(rec => {
                        const d = fmtDate(rec.created_at || rec.header?.data_ini);
                        const f = rec.header?.frota || '';
                        const e = rec.header?.equipamento || '';
                        const u = rec.user_id || '';
                        const lid = String(rec.local_id || rec.id || '');
                        return `
                            <div class="py-3 flex items-center justify-between">
                                <div>
                                    <div class="text-sm font-medium text-gray-900 dark:text-white">${f} — ${e}</div>
                                    <div class="text-xs text-gray-500 dark:text-gray-400">${d}${rec.offline ? ' • Offline' : ''}</div>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300" onclick="viewControle3p('${lid}')">Ver</button>
                                    <button class="px-2 py-1 bg-yellow-500 text-white rounded-md" onclick="openEditControle3p('${lid}')">Editar</button>
                                    <button class="px-2 py-1 bg-red-600 text-white rounded-md" onclick="deleteControle3p('${lid}')">Excluir</button>
                                </div>
                            </div>
                        `;
                    }).join('');
                if (calRows) calRows.innerHTML = renderCal || '<div class="py-3 text-sm text-gray-500 dark:text-gray-400">Sem registros</div>';
                if (c3pRows) c3pRows.innerHTML = renderC3p || '<div class="py-3 text-sm text-gray-500 dark:text-gray-400">Sem registros</div>';
                if (status) status.textContent = `${(calList||[]).length} calibragens • ${(c3pList||[]).length} fichas 3P`;
            } catch(_) {}
        }

        async function findCalibragemByLocalId(localId) {
            try {
                if (!localId) return null;
                const pend = getPendingCalibragem().find(i => String(i.local_id) === String(localId));
                if (pend) return pend;
                if (isOnline()) {
                    const resp = await supabase.from('calibragem').select('*').eq('local_id', localId).limit(1);
                    if (!resp.error && resp.data && resp.data.length) return resp.data[0];
                }
                return null;
            } catch(_) { return null; }
        }

        async function findControle3pByLocalId(localId) {
            try {
                if (!localId) return null;
                const pend = getPendingControle3p().find(i => String(i.local_id) === String(localId));
                if (pend) return pend;
                if (isOnline()) {
                    const resp = await supabase.from('controle_3p').select('*').eq('local_id', localId).limit(1);
                    if (!resp.error && resp.data && resp.data.length) return resp.data[0];
                }
                return null;
            } catch(_) { return null; }
        }

        function openRecordModal(title, html) {
            const m = document.getElementById('recordModal');
            const t = document.getElementById('recordModalTitle');
            const c = document.getElementById('recordDetails');
            const p = document.getElementById('printRecordBtn');
            if (!m || !t || !c) return;
            t.textContent = title || '';
            c.innerHTML = html || '';
            m.classList.remove('hidden');
            if (p) {
                p.onclick = () => printRecord();
                p.disabled = false;
            }
        }

        function closeRecordModal() {
            const m = document.getElementById('recordModal');
            if (m) m.classList.add('hidden');
        }

        async function viewCalibragem(localId) {
            const rec = await findCalibragemByLocalId(localId);
            if (!rec) { showCustomAlert('Registro não encontrado'); return; }
            const h = rec.header || {};
            const sulco = rec.sulco || {};
            const calib = rec.calibragem || {};
            const pos = rec.pos || {};
            const header = `
                <div class="p-4 bg-blue-50 dark:bg-blue-900/30 border border-blue-200 dark:border-blue-800 rounded-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-semibold text-gray-900 dark:text-white">${h.frota || ''} — ${h.equipamento || ''}</div>
                            <div class="muted">${h.data_ini || ''} ${h.hora_ini || ''} — ${h.data_fim || ''} ${h.hora_fim || ''}</div>
                        </div>
                        <div class="muted">Hodo/Hor: ${h.hodo || ''}</div>
                    </div>
                </div>`;
            const posRows = ['1de','1di','2de','2di','3de','3di','4de','4di','1ee','1ei','2ee','2ei','3ee','3ei','4ee','4ei','est1','est2']
                .map(k => `<tr><td>${k.toUpperCase()}</td><td>${(pos[k])||''}</td></tr>`).join('');
            const sulcoRows = ['1de','1di','2de','2di','3de','3di','4de','4di','1ee','1ei','2ee','2ei','3ee','3ei','4ee','4ei']
                .map(k => `<tr><td>${k.toUpperCase()}</td><td>${(sulco[k]?.a)||''}</td><td>${(sulco[k]?.b)||''}</td></tr>`).join('') + `<tr><td>EST</td><td colspan="2">${sulco.est || ''}</td></tr>`;
            const calibRows = ['1de','1di','2de','2di','3de','3di','4de','4di','1ee','1ei','2ee','2ei','3ee','3ei','4ee','4ei','est1','est2']
                .map(k => `<tr><td>${k.toUpperCase()}</td><td>${(calib[k]?.encon)||''}</td><td>${(calib[k]?.colo)||''}</td></tr>`).join('');
            const body = `
                <div class="section">
                    <div class="text-sm font-semibold mb-2">Posição Nº Fogo</div>
                    <table class="record-table"><thead><tr><th>Posição</th><th>Nº Fogo</th></tr></thead><tbody>${posRows}</tbody></table>
                </div>
                <div class="section">
                    <div class="text-sm font-semibold mb-2">Sulco (mm)</div>
                    <table class="record-table"><thead><tr><th>Posição</th><th>A</th><th>B</th></tr></thead><tbody>${sulcoRows}</tbody></table>
                </div>
                <div class="section">
                    <div class="text-sm font-semibold mb-2">Calibragem (psi)</div>
                    <table class="record-table"><thead><tr><th>Posição</th><th>Encontrada</th><th>Aplicada</th></tr></thead><tbody>${calibRows}</tbody></table>
                </div>
                <div class="section">
                    <div class="text-sm font-semibold mb-1">Observações</div>
                    <div class="muted">${rec.observacoes || ''}</div>
                </div>
            `;
            openRecordModal('Calibragem', header + body);
        }

        async function viewControle3p(localId) {
            const rec = await findControle3pByLocalId(localId);
            if (!rec) { showCustomAlert('Registro não encontrado'); return; }
            const h = rec.header || {};
            const header = `
                <div class="p-4 bg-purple-50 dark:bg-purple-900/30 border border-purple-200 dark:border-purple-800 rounded-md">
                    <div class="flex items-center justify-between">
                        <div>
                            <div class="text-sm font-semibold text-gray-900 dark:text-white">${h.frota || ''} — ${h.equipamento || ''}</div>
                            <div class="muted">${h.data_ini || ''} ${h.hora_ini || ''} — ${h.data_fim || ''} ${h.hora_fim || ''}</div>
                        </div>
                        <div class="muted">OS/Item: ${h.os_item || ''}</div>
                    </div>
                </div>`;
            const rows = Array.isArray(rec.rows) ? rec.rows : [];
            const bodyRows = rows.map((r,i)=>`<tr><td>${i+1}</td><td>${r.posicao||''}</td><td>${r.fogo||''}</td><td>${r.medida||''}</td><td>${r.fabricante||''}</td><td>${r.modelo||''}</td><td>${r.indice||''}</td><td>${r.dot||''}</td><td>${r.sulco1||''}</td><td>${r.sulco2||''}</td><td>${r.sulco3||''}</td><td>${r.pressao||''}</td></tr>`).join('');
            const body = `
                <div class="section">
                    <div class="text-sm font-semibold mb-2">Itens</div>
                    <table class="record-table"><thead><tr><th>#</th><th>Posição</th><th>Nº Fogo</th><th>Medida</th><th>Fabricante</th><th>Modelo</th><th>Índice</th><th>DOT</th><th>Sulco 1</th><th>Sulco 2</th><th>Sulco 3</th><th>Pressão</th></tr></thead><tbody>${bodyRows}</tbody></table>
                </div>
            `;
            openRecordModal('Ficha Controle 3P', header + body);
        }

        async function openEditCalibragem(localId) {
            const rec = await findCalibragemByLocalId(localId);
            if (!rec) { showCustomAlert('Registro não encontrado'); return; }
            showSection('calibragem');
            const h = rec.header || {};
            const eq = document.getElementById('calEquipamento');
            if (eq) eq.value = h.equipamento || 'caminhao';
            const vv = String(eq?.value || '').toLowerCase();
            setCalibMap(vv.includes('transbord') ? 'transbordo' : 'truck');
            await loadEquipments();
            populateFrotaOptionsFor(eq?.value || 'caminhao','calFrotaSelect','calFrotaCustom');
            const sel = document.getElementById('calFrotaSelect');
            const cus = document.getElementById('calFrotaCustom');
            const hasFrota = Array.from(sel?.options || []).some(o => o.value === h.frota);
            if (sel) sel.value = hasFrota ? h.frota : 'custom';
            if (cus) { if (!hasFrota) { cus.classList.remove('hidden'); cus.value = h.frota || ''; } else { cus.value = ''; cus.classList.add('hidden'); } }
            const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
            setVal('calHodo', h.hodo);
            setVal('calOS', h.os_item);
            setVal('calMatricula', h.matricula);
            setVal('calNome', h.nome);
            setVal('calDataIni', h.data_ini);
            setVal('calHoraIni', h.hora_ini);
            setVal('calDataFim', h.data_fim);
            setVal('calHoraFim', h.hora_fim);
            const pos = rec.pos || {};
            Object.keys(pos || {}).forEach(k => { setVal('pos_'+k, pos[k]); });
            const sulco = rec.sulco || {};
            Object.keys(sulco || {}).forEach(k => {
                const v = sulco[k];
                if (k === 'est') { setVal('sulco_est', v || ''); } else { setVal('sulco_'+k+'_a', v?.a || ''); setVal('sulco_'+k+'_b', v?.b || ''); }
            });
            const calib = rec.calibragem || {};
            Object.keys(calib || {}).forEach(k => { setVal('calib_'+k+'_encon', calib[k]?.encon || ''); setVal('calib_'+k+'_colo', calib[k]?.colo || ''); });
            setVal('calObservacoes', rec.observacoes);
        }

        async function openEditControle3p(localId) {
            const rec = await findControle3pByLocalId(localId);
            if (!rec) { showCustomAlert('Registro não encontrado'); return; }
            showSection('controle3p');
            const h = rec.header || {};
            const eq = document.getElementById('c3pEquipamento');
            if (eq) eq.value = h.equipamento || 'caminhao';
            await loadEquipments();
            populateFrotaOptionsFor(eq?.value || 'caminhao','c3pFrotaSelect','c3pFrotaCustom');
            const sel = document.getElementById('c3pFrotaSelect');
            const cus = document.getElementById('c3pFrotaCustom');
            const hasFrota = Array.from(sel?.options || []).some(o => o.value === h.frota);
            if (sel) sel.value = hasFrota ? h.frota : 'custom';
            if (cus) { if (!hasFrota) { cus.classList.remove('hidden'); cus.value = h.frota || ''; } else { cus.value = ''; cus.classList.add('hidden'); } }
            const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
            setVal('c3pHodo', h.hodo);
            setVal('c3pOS', h.os_item);
            setVal('c3pMatricula', h.matricula);
            setVal('c3pNome', h.nome);
            setVal('c3pDataIni', h.data_ini);
            setVal('c3pHoraIni', h.hora_ini);
            setVal('c3pDataFim', h.data_fim);
            setVal('c3pHoraFim', h.hora_fim);
            const rows = rec.rows || [];
            rows.forEach(r => {
                const id = r.seq;
                const setBy = (field, v) => { const el = document.querySelector(`#ctrl3pTableBody input[data-id="${id}"][data-field="${field}"]`); if (el) el.value = v || ''; };
                setBy('posicao', r.posicao);
                setBy('fogo', r.fogo);
                setBy('medida', r.medida);
                setBy('fabricante', r.fabricante);
                setBy('modelo', r.modelo);
                setBy('indice', r.indice);
                setBy('dot', r.dot);
                setBy('sulco1', r.sulco1);
                setBy('sulco2', r.sulco2);
                setBy('sulco3', r.sulco3);
                setBy('pressao', r.pressao);
            });
        }

        async function deleteCalibragem(localId) {
            try {
                if (!confirm('Deseja excluir este lançamento de calibragem?')) return;
                let q = getPendingCalibragem();
                const idx = q.findIndex(i => String(i.local_id) === String(localId));
                if (idx >= 0) { q.splice(idx,1); setPendingCalibragem(q); }
                if (isOnline()) { await supabase.from('calibragem').delete().eq('local_id', localId); }
                loadHistoricoPneus();
                showFloatingNotification('success', 'Calibragem excluída');
            } catch(_) { showFloatingNotification('error', 'Falha ao excluir'); }
        }

        async function deleteControle3p(localId) {
            try {
                if (!confirm('Deseja excluir esta Ficha 3P?')) return;
                let q = getPendingControle3p();
                const idx = q.findIndex(i => String(i.local_id) === String(localId));
                if (idx >= 0) { q.splice(idx,1); setPendingControle3p(q); }
                if (isOnline()) { await supabase.from('controle_3p').delete().eq('local_id', localId); }
                loadHistoricoPneus();
                showFloatingNotification('success', 'Ficha 3P excluída');
            } catch(_) { showFloatingNotification('error', 'Falha ao excluir'); }
        }
        function initHistoricoPneus() {
            try {
                const tipoSel = document.getElementById('histEquipTipo');
                const apply = (v) => {
                    const vv = String(v || '').toLowerCase();
                    if (vv === 'all') {
                        populateFrotaOptionsFor('caminhao','histFrotaSelect','histFrotaCustom');
                    } else {
                        populateFrotaOptionsFor(vv,'histFrotaSelect','histFrotaCustom');
                    }
                };
                const bindF = () => bindFrotaSelectFor('histFrotaSelect','histFrotaCustom');
                loadEquipments().then(() => { apply(tipoSel?.value || 'all'); bindF(); });
                if (tipoSel) tipoSel.addEventListener('change', () => apply(tipoSel.value));
                const now = new Date();
                const df = document.getElementById('histDataFim');
                const di = document.getElementById('histDataIni');
                const dEnd = now.toISOString().split('T')[0];
                const dStart = new Date(now.getTime() - 30*24*60*60*1000).toISOString().split('T')[0];
                if (df) df.value = dEnd;
                if (di) di.value = dStart;
                loadHistoricoPneus();
            } catch(_) {}
        }

        async function addEquipment() {
            const tipo = document.getElementById('equipTipo').value;
            const frota = document.getElementById('equipFrota').value.trim();
            const descricao = document.getElementById('equipDesc').value.trim();
            const status = document.getElementById('equipStatus').value;
            if (!tipo || !frota) {
                showCustomAlert('Informe setor e frota.');
                return;
            }
            const item = { tipo, frota, descricao, status, created_at: new Date().toISOString() };
            showLoading(true);
            try {
                if (isOnline()) {
                    const { data, error } = await supabase
                        .from('equipments')
                        .insert([item])
                        .select();
                    if (error) throw error;
                    equipments.unshift(data && data[0] ? data[0] : item);
                } else {
                    equipments.unshift(item);
                    queueEquipment(item);
                }
                setCachedEquipments(equipments);
                populateEquipmentList();
                showFloatingNotification('success', 'Equipamento cadastrado');
                document.getElementById('equipFrota').value = '';
                document.getElementById('equipDesc').value = '';
            } catch (e) {
                equipments.unshift(item);
                setCachedEquipments(equipments);
                queueEquipment(item);
                populateEquipmentList();
                showFloatingNotification('warning', 'Falha ao cadastrar online. Salvo localmente.');
                document.getElementById('equipFrota').value = '';
                document.getElementById('equipDesc').value = '';
            } finally {
                showLoading(false);
            }
        }

        function populateEquipmentList() {
            const container = document.getElementById('equipList');
            const filterSel = document.getElementById('equipFilterTipo');
            if (!container) return;
            const tipo = filterSel ? filterSel.value : 'all';
            const aliases = tipo === 'all' ? null : typeAliases(tipo);
            const list = (equipments || []).filter(e => !aliases ? true : aliases.includes(e.tipo || e.setor));
            if (list.length === 0) {
                container.innerHTML = '<div class="text-gray-500 dark:text-gray-400">Nenhuma frota cadastrada</div>';
                return;
            }
            container.innerHTML = list.map(e => `
                <div class="p-4 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm font-medium text-gray-900 dark:text-white">${e.frota}</p>
                            <p class="text-xs text-gray-500 dark:text-gray-400">${(e.tipo||e.setor)}${e.descricao ? ' • ' + e.descricao : ''}</p>
                        </div>
                        <span class="text-xs px-2 py-1 rounded-full ${ (e.status||'ativo')==='ativo' ? 'bg-green-100 text-green-700 dark:bg-green-900 dark:text-green-200' : 'bg-gray-100 text-gray-700 dark:bg-gray-800 dark:text-gray-300' }">${e.status||'ativo'}</span>
                    </div>
                </div>
            `).join('');
            if (filterSel && !filterSel._bound) {
                filterSel.addEventListener('change', populateEquipmentList);
                filterSel._bound = true;
            }
        }

        // Funções auxiliares
        function updateDateTime() {
            const now = new Date();
            const options = { 
                year: 'numeric', 
                month: '2-digit', 
                day: '2-digit',
                hour: '2-digit', 
                minute: '2-digit'
            };
            document.getElementById('currentDateTime').textContent = now.toLocaleDateString('pt-BR', options);
        }

        function dateOnlyToLocalDate(s) {
            const parts = String(s || '').split('-');
            if (parts.length === 3) return new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
            return new Date(s);
        }

        function formatDateBR(s) {
            const str = String(s || '');
            if (str.includes('T')) return new Date(str).toLocaleDateString('pt-BR');
            const p = str.split('-');
            if (p.length === 3) return `${p[2]}/${p[1]}/${p[0]}`;
            return new Date(str).toLocaleDateString('pt-BR');
        }

        function setCurrentDate() {
            const today = new Date().toISOString().split('T')[0];
            const dateInput = document.getElementById('dataInspecao');
            if (dateInput) {
                dateInput.value = today;
                dateInput.min = today;
                dateInput.max = today;
                dateInput.readOnly = true;
            }
        }

        function showSection(sectionId) {
            if (['historico','global-analytics','relatorios','equipamentos'].includes(sectionId)) {
                viewMode = 'global';
                dehydrateCCTSubsections();
            }
            if (isRestrictedUser()) { 
                const allow = getAllowedSectionsFor((currentUser||getCachedUser()||{}).email || ''); 
                // Compatibility for legacy 'analytics' permission
                const checkId = sectionId === 'global-analytics' ? 'analytics' : sectionId;
                if (!allow.includes(sectionId) && !allow.includes(checkId)) { 
                    showCustomAlert('Acesso restrito.'); 
                    sectionId = allow[0] || 'cct_coque'; 
                } 
            }
            if (sectionId === 'admin' && !isAdmin()) { showCustomAlert('Acesso restrito.'); sectionId = 'dashboard'; }
            // Update navigation
            document.querySelectorAll('.nav-btn').forEach(btn => {
                btn.classList.remove('active', 'border-primary', 'text-primary');
                btn.classList.add('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-300');
            });
            const selector = `button[onclick="showSection('${sectionId}')"]`;
            const activeBtn = document.querySelector(selector) || (sectionId === 'admin' ? document.getElementById('adminNavBtn') : null);
            if (activeBtn) {
                activeBtn.classList.add('active', 'border-primary', 'text-primary');
                activeBtn.classList.remove('border-transparent', 'text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400', 'dark:hover:text-gray-300');
            }
            
            // Show/hide sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.classList.add('hidden');
            });
            if (sectionId === 'cct_coque') {
                const targetSection = document.getElementById('cct_coque');
                if (targetSection) {
                    targetSection.classList.remove('hidden');
                    targetSection.classList.add('fade-in');
                }
                hydrateCCTSubsections();
                const lastSub = localStorage.getItem('lastSubCCT') || 'inicio';
                showCCTSubsection(lastSub);
                try { localStorage.setItem('lastSection','cct_coque'); } catch(_) {}
                return;
            }
            if (sectionId === 'irrigacao') {
                const targetSection2 = document.getElementById('irrigacao');
                if (targetSection2) {
                    targetSection2.classList.remove('hidden');
                    targetSection2.classList.add('fade-in');
                }
                const lastSub2 = localStorage.getItem('lastSubIRR') || 'inicio';
                showIrrSubsection(lastSub2);
                try { localStorage.setItem('lastSection','irrigacao'); } catch(_) {}
                return;
            }
            
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.remove('hidden');
                targetSection.classList.add('fade-in');
            }
            try { localStorage.setItem('lastSection', sectionId); } catch(_) {}
            
            // Dashboard specific updates
            if (sectionId === 'dashboard') {
                updateDashboardStats();
            }

            if (sectionId === 'admin') { renderAccessControls(); bindAdminActions(); }
            if (sectionId === 'historico_pneus') { initHistoricoPneus(); }

            // Reset nova inspeção section
            if (sectionId === 'nova-inspecao') {
                backToSelection();
            }
            if (sectionId === 'historico') {
                updateHistoryTable();
            }
            if (sectionId === 'global-analytics') {
                const sel = document.getElementById('chartPeriod');
                const days = sel ? parseInt(sel.value, 10) : 30;
                initializeCharts();
                updateAnalytics();
                updateAnalyticsSummary(days);
            }
            if (sectionId === 'equipamentos') {
                populateEquipmentList();
            }
            if (sectionId === 'calibragem') {
                initCalibragemForm();
            }
            if (sectionId === 'controle3p') {
                initControle3pForm();
            }
        }

        function hydrateCCTSubsections() {
            const map = [
                {src: 'historico', dest: 'cct-sub-historico'},
                {src: 'global-analytics', dest: 'cct-sub-analytics'},
                {src: 'relatorios', dest: 'cct-sub-relatorios'},
                {src: 'equipamentos', dest: 'cct-sub-equipamentos'}
            ];
            map.forEach(item => {
                const src = document.getElementById(item.src);
                const dest = document.getElementById(item.dest);
                if (src && dest && dest.childElementCount === 0) {
                    while (src.firstChild) { dest.appendChild(src.firstChild); }
                }
            });
        }

        function dehydrateCCTSubsections() {
            try {
                const map = [
                    {src: 'historico', dest: 'cct-sub-historico'},
                    {src: 'global-analytics', dest: 'cct-sub-analytics'},
                    {src: 'relatorios', dest: 'cct-sub-relatorios'},
                    {src: 'equipamentos', dest: 'cct-sub-equipamentos'}
                ];
                map.forEach(item => {
                    const src = document.getElementById(item.src);
                    const dest = document.getElementById(item.dest);
                    if (src && dest && src.childElementCount === 0) {
                        while (dest.firstChild) { src.appendChild(dest.firstChild); }
                    }
                });
                restoreGlobalFilters();
            } catch(_) {}
        }

        function showCCTSubsection(sub) {
            viewMode = 'cct';
            if (isRestrictedUser()) {
                const email = ((currentUser||getCachedUser()||{}).email || '').toLowerCase();
                const allow = getAllowedSubsectionsFor(email, 'cct_coque');
                if (sub !== 'inicio' && allow.length && !allow.includes(sub)) { showCustomAlert('Acesso restrito.'); showCCTSubsection('inicio'); return; }
            }
            document.querySelectorAll('#cct-sub-historico,#cct-sub-analytics,#cct-sub-relatorios,#cct-sub-equipamentos').forEach(el => el.classList.add('hidden'));
            document.querySelectorAll('.cct-sub-btn').forEach(btn => {
                btn.classList.remove('border-primary','text-primary');
                btn.classList.add('border-transparent','text-gray-600');
            });
            const eqSel = document.getElementById('equipmentSelection');
            const form = document.getElementById('checklistForm');
            if (sub === 'inicio') {
                if (eqSel) eqSel.classList.remove('hidden');
                if (form) form.classList.add('hidden');
                const btn = Array.from(document.querySelectorAll('.cct-sub-btn')).find(b => b.getAttribute('onclick')?.includes("'inicio'"));
                if (btn) { btn.classList.add('border-primary','text-primary'); btn.classList.remove('border-transparent','text-gray-600'); }
                try { localStorage.setItem('lastSection','cct_coque'); localStorage.setItem('lastSubCCT','inicio'); } catch(_) {}
                return;
            }
            if (eqSel) eqSel.classList.add('hidden');
            if (form) form.classList.add('hidden');
            const target = document.getElementById('cct-sub-' + sub);
            if (target) { target.classList.remove('hidden'); target.classList.add('fade-in'); }
            const btn = Array.from(document.querySelectorAll('.cct-sub-btn')).find(b => b.getAttribute('onclick')?.includes("'"+sub+"'"));
            if (btn) { btn.classList.add('border-primary','text-primary'); btn.classList.remove('border-transparent','text-gray-600'); }
            if (sub === 'historico') {
                updateHistoryTable();
                ensureCCTFilters('historico');
            }
            if (sub === 'analytics') {
                const sel = document.getElementById('chartPeriod');
                const days = sel ? parseInt(sel.value, 10) : 30;
                initializeCharts();
                populateAnalyticsFilters();
                updateAnalytics();
                updateAnalyticsSummary(days);
                ensureCCTFilters('analytics');
                updateModeTypeCounts('cct');
            }
            if (sub === 'equipamentos') {
                populateEquipmentList();
            }
            try { localStorage.setItem('lastSection','cct_coque'); localStorage.setItem('lastSubCCT', sub); } catch(_) {}
        }

        function ensureCCTFilters(area) {
            try {
                if (area === 'historico') {
                    const container = document.getElementById('cct-sub-historico');
                    if (!container) return;
                    const custom = container.querySelector('#cctFiltroRow');
                    if (custom) custom.remove();
                    const tipoSel = container.querySelector('#filtroTipo');
                    if (tipoSel) {
                        const box = tipoSel.closest('.bg-white');
                        if (box) box.classList.remove('hidden');
                        // Ajusta o label para CCT
                        const label = box.querySelector('label');
                        if (label) label.textContent = 'Tipo de Equipamento (CCT)';
                        // Remove tipos de Irrigação
                        ['pivot','bombeamento','tubulacoes'].forEach(v => {
                            const opt = tipoSel.querySelector(`option[value="${v}"]`);
                            if (opt) opt.remove();
                        });
                    }
                } else if (area === 'analytics') {
                    const container = document.getElementById('cct-sub-analytics');
                    if (!container) return;
                    const globalEq = container.querySelector('#equipmentFilter');
                    if (globalEq) { const wrap = globalEq.closest('.flex'); if (wrap) wrap.classList.add('hidden'); }
                    if (!document.getElementById('cctAnalyticsFilters')) {
                        const row = document.createElement('div');
                        row.id = 'cctAnalyticsFilters';
                        row.className = 'mb-4';
                        row.innerHTML = `
                            <div class="flex flex-wrap items-center gap-3">
                                <select id="chartPeriodCCT" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="7">Últimos 7 dias</option>
                                    <option value="30" selected>Últimos 30 dias</option>
                                    <option value="90">Últimos 90 dias</option>
                                </select>
                                <select id="equipmentFilterCCT" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="all" selected>Todos equipamentos</option>
                                    <option value="caminhao">Caminhão</option>
                                    <option value="trator">Trator</option>
                                    <option value="colhedora">Colhedora</option>
                                    <option value="reboque">Reboque</option>
                                    <option value="plantadora">Plantadora</option>
                                    <option value="distribuidora">Distribuidora</option>
                                    <option value="cobridores">Cobridores</option>
                                    <option value="transbordo">Transbordo</option>
                                    <option value="tortao">Tortão</option>
                                </select>
                                <select id="leaderFilterCCT" class="text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white px-3 py-1">
                                    <option value="all" selected>Todos líderes</option>
                                </select>
                                <button id="clearAnalyticsFiltersCCT" class="text-sm px-3 py-1 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">Limpar</button>
                            </div>`;
                        container.insertBefore(row, container.firstChild);
                        const btn = document.getElementById('clearAnalyticsFiltersCCT');
                        if (btn) btn.addEventListener('click', () => {
                            const p = document.getElementById('chartPeriodCCT');
                            const e = document.getElementById('equipmentFilterCCT');
                            const l = document.getElementById('leaderFilterCCT');
                            if (p) p.value = '30'; if (e) e.value = 'all'; if (l) l.value = 'all';
                            const days = 30; buildCharts(days); updateAnalyticsSummary(days); updateAnalytics();
                        });
                    }
                    if (!document.getElementById('cctTypeCounts')) {
                        const grid = document.createElement('div');
                        grid.id = 'cctTypeCounts';
                        grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-4';
                        grid.innerHTML = `
                            <div class="flex items-center justify-between"><span class="text-sm">Caminhões</span><span id="cctCountCaminhoes" class="text-lg font-semibold">0</span></div>
                            <div class="flex items-center justify-between"><span class="text-sm">Tratores</span><span id="cctCountTratores" class="text-lg font-semibold">0</span></div>
                            <div class="flex items-center justify-between"><span class="text-sm">Colhedoras</span><span id="cctCountColhedoras" class="text-lg font-semibold">0</span></div>
                            <div class="flex items-center justify-between"><span class="text-sm">Plantadoras</span><span id="cctCountPlantadoras" class="text-lg font-semibold">0</span></div>
                            <div class="flex items-center justify-between"><span class="text-sm">Distribuidoras</span><span id="cctCountDistribuidoras" class="text-lg font-semibold">0</span></div>
                            <div class="flex items-center justify-between"><span class="text-sm">Reboques</span><span id="cctCountReboques" class="text-lg font-semibold">0</span></div>
                            <div class="flex items-center justify-between"><span class="text-sm">Transbordos</span><span id="cctCountTransbordo" class="text-lg font-semibold">0</span></div>
                            <div class="flex items-center justify-between"><span class="text-sm">Tortão</span><span id="cctCountTortao" class="text-lg font-semibold">0</span></div>
                        `;
                        container.insertBefore(grid, container.firstChild.nextSibling);
                    }
                }
            } catch(_) {}
        }

        function filterHistoryCCT() {
            const tipoEl = document.getElementById('filtroTipoCCT');
            const diEl = document.getElementById('filtroDataInicialCCT');
            const dfEl = document.getElementById('filtroDataFinalCCT');
            const tipo = tipoEl ? tipoEl.value : '';
            const di = diEl ? diEl.value : '';
            const df = dfEl ? dfEl.value : '';
            const diTime = di ? dateOnlyToLocalDate(di).getTime() : null;
            const dfTime = df ? dateOnlyToLocalDate(df).getTime() : null;
            const all = inspections.slice();
            const filtered = all.filter(i => {
                const matchesTipo = !tipo || i.tipo === tipo;
                const t = dateOnlyToLocalDate(i.data).getTime();
                const afterStart = diTime == null || t >= diTime;
                const beforeEnd = dfTime == null || t <= dfTime;
                return matchesTipo && afterStart && beforeEnd;
            });
            updateHistoryTable(filtered);
        }

        function showIrrSubsection(sub) {
            viewMode = 'irr';
            if (isRestrictedUser()) {
                const email = ((currentUser||getCachedUser()||{}).email || '').toLowerCase();
                const allow = getAllowedSubsectionsFor(email, 'irrigacao');
                if (sub !== 'inicio' && allow.length && !allow.includes(sub)) { showCustomAlert('Acesso restrito.'); const start = document.getElementById('irr-sub-inicio'); document.querySelectorAll('#irr-sub-inicio,#irr-sub-historico,#irr-sub-analytics,#irr-sub-relatorios,#irr-sub-equipamentos').forEach(el => el.classList.add('hidden')); if (start) { start.classList.remove('hidden'); start.classList.add('fade-in'); } return; }
            }
            document.querySelectorAll('#irr-sub-inicio,#irr-sub-historico,#irr-sub-analytics,#irr-sub-relatorios,#irr-sub-equipamentos').forEach(el => el.classList.add('hidden'));
            const irrForm = document.getElementById('irrChecklistForm');
            if (irrForm) irrForm.classList.add('hidden');
            document.querySelectorAll('.irr-sub-btn').forEach(btn => {
                btn.classList.remove('border-primary','text-primary');
                btn.classList.add('border-transparent','text-gray-600');
            });
            if (sub === 'inicio') {
                const start = document.getElementById('irr-sub-inicio');
                if (start) {
                    start.classList.remove('hidden');
                    start.classList.add('fade-in');
                    const cards = document.getElementById('irrEquipCards');
                    if (cards) cards.classList.remove('hidden');
                    if (irrForm) irrForm.classList.add('hidden');
                }
                const btn = Array.from(document.querySelectorAll('.irr-sub-btn')).find(b => b.getAttribute('onclick')?.includes("'inicio'"));
                if (btn) { btn.classList.add('border-primary','text-primary'); btn.classList.remove('border-transparent','text-gray-600'); }
                try { localStorage.setItem('lastSection','irrigacao'); localStorage.setItem('lastSubIRR','inicio'); } catch(_) {}
                return;
            }
            const target = document.getElementById('irr-sub-' + sub);
            if (target) { target.classList.remove('hidden'); target.classList.add('fade-in'); }
            const btn = Array.from(document.querySelectorAll('.irr-sub-btn')).find(b => b.getAttribute('onclick')?.includes("'"+sub+"'"));
            if (btn) { btn.classList.add('border-primary','text-primary'); btn.classList.remove('border-transparent','text-gray-600'); }
            if (sub === 'equipamentos') { populateIrrEquipmentList(); }
            if (sub === 'historico') { renderIrrHistory(); }
            if (sub === 'analytics') { populateIrrLeaderFilter(); initializeIrrCharts(); updateIrrAnalytics(); updateIrrAnalyticsSummary(); }
            if (sub === 'analytics') {
                const container = document.getElementById('irr-sub-analytics');
                if (container && !document.getElementById('irrTypeCounts')) {
                    const grid = document.createElement('div');
                    grid.id = 'irrTypeCounts';
                    grid.className = 'grid grid-cols-2 gap-4 mb-4';
                    grid.innerHTML = `
                        <div class="flex items-center justify-between"><span class="text-sm">MotoBombas</span><span id="irrCountMotobombas" class="text-lg font-semibold">0</span></div>
                        <div class="flex items-center justify-between"><span class="text-sm">Hidro Roll</span><span id="irrCountHidroroll" class="text-lg font-semibold">0</span></div>
                        <div class="flex items-center justify-between"><span class="text-sm">Caminhões</span><span id="irrCountCaminhoes" class="text-lg font-semibold">0</span></div>
                        <div class="flex items-center justify-between"><span class="text-sm">Tanques</span><span id="irrCountTanques" class="text-lg font-semibold">0</span></div>
                    `;
                    container.insertBefore(grid, container.firstChild);
                }
                updateModeTypeCounts('irr');
            }
            try { localStorage.setItem('lastSection','irrigacao'); localStorage.setItem('lastSubIRR', sub); } catch(_) {}
        }

        let irrigInspections = [];
        let irrigEquipments = [];
        let irrPhotoSessionId = null;
        const irrigEquipmentConfigs = {
            motobombas: {
                sections: [
                    {
                        name: 'TIPO DE SERVIÇO',
                        items: [
                            'Verificar tanque',
                            'Verificar cinta do tanque - reparar se necessário',
                            'Verificar entrada de ar no sistema',
                            'Verificar lava radiador',
                            'Verificar vazamento no radiador',
                            'Verificar bomba de centrífuga',
                            'Verificar gaxeta',
                            'Verificar buchas e folga na chaveta',
                            'Verificar parafusos e trincas da caixa e sucção',
                            'Verificar vazamentos no motor',
                            'Verificar vazamento na bomba motor',
                            'Verificar altura dos pneus',
                            'Realizar manutenção primária',
                            'Verificar eixos e folga do cabeçalho',
                            'Verificar guincho de levante do mangote',
                            'Verificar cabo de aço e catraca do guincho',
                            'Verificar medidor de pressão de óleo do motor',
                            'Verificar relógio hidrômetro do motor',
                            'Verificar relógio amperímetro da parte elétrica',
                            'Verificar relógio de temperatura do motor',
                            'Verificar vela eletrônica',
                            'Verificar altura dos pneus',
                            'Realizar inventário de peças',
                            'Verificar pino de freio',
                            'Verificar partes móveis pintura e proteção',
                            'Verificar mangueira e proteções laterais',
                            'Revisar montador',
                            'Revisar motor de partida',
                            'Revisar chicote da bateria, suporte e fixação',
                            'Revisar horímetro',
                            'Revisar painel de instrumentos',
                            'Teste de sensores',
                            'Verificar entrada de ar no mangote de sucção',
                            'Verificar abraçadeiras do mangote de sucção',
                            'Verificar trincas no cano de saída inox',
                            'Verificar válvula de saída',
                            'Verificar folga nos cubos',
                            'Verificar retentores com vazamento',
                            'Verificar embuchamento',
                            'Verificar parafusos da roda',
                            'Verificar folgas na roda'
                        ]
                    }
                ]
            },
            hidroroll: {
                sections: [
                    {
                        name: 'TIPO DE SERVIÇO',
                        items: [
                            'Verificar pinos e folga do cabeçalho',
                            'Verificar rala de giro',
                            'Verificar parafusos da rala',
                            'Verificar suporte e pino do giro',
                            'Verificar estrutura do chassi',
                            'Verificar desgaste e trincas da cremalheira',
                            'Verificar folga no pino de recuo',
                            'Verificar folga das alavancas da marcha',
                            'Verificar funcionamento do farol de sinalização',
                            'Verificar instalação do by pass',
                            'Verificar painel de instrumentos e operação',
                            'Verificar giroflex',
                            'Verificar faróis (sinalizações e iluminação)',
                            'Revisar alternador e baterias',
                            'Verificar carenagens',
                            'Verificar rolamentos',
                            'Verificar desgaste da chaveta do guia',
                            'Verificar desgaste da rosca do guia',
                            'Verificar regular, limpar e lubrificar corrente do guia',
                            'Verificar cavalete de desarme',
                            'Verificar limpeza da sapata da ancoragem',
                            'Verificar trocar juntas e abraçadeiras',
                            'Verificar aspersor',
                            'Verificar caixa do painel',
                            'Verificar funcionamento do painel',
                            'Verificar proteção dos cabos do painel',
                            'Verificar sensores',
                            'Verificar suspiro de óleo do redutor',
                            'Verificar vazamento no retentor do redutor',
                            'Verificar folga no eixo do redutor',
                            'Verificar sistema de freio do redutor',
                            'Verificar redutor e corrente do guia',
                            'Verificar fixação do moto redutor',
                            'Verificar válvula do moto redutor',
                            'Verificar partes móveis pintura e proteção',
                            'Verificar pino de freio',
                            'Verificar selo mecânico da turbina',
                            'Verificar correia, esticador e polia da turbina',
                            'Verificar vazamentos nas mangueiras',
                            'Verificar sistema by pass',
                            'Verificar regular e limpar rolo do guia da mangueira',
                            'Verificar cubos do redutor',
                            'Verificar parafusos do cubo',
                            'Reapertar rodas',
                            'Conferir parafusos e porcas',
                            'Colocar tampa de válvula',
                            'Calibrar pneus e medir sulco',
                            'Inventariar pneus equipamento',
                            'Desmontar, lavar peças, examinar, engraxar e montar (cubos de roda)'
                        ]
                    }
                ]
            },
            caminhoes: {
                title: 'Checklist de Liberação - Caminhão',
                sections: [
                    {
                        name: 'CABINE',
                        items: [
                            'Bucha da suspensão',
                            'Batente e dobradiça portas',
                            'Borrachas das portas',
                            'Palhetas do limpador para-brisa',
                            'Maçanetas (internas/externas) e manivela dos vidros',
                            'Bancos (motorista e passageiro)',
                            'Conjunto de basculamento da cabine',
                            'Reservatório e mangueira do limpador de para-brisa',
                            'Estado da escada',
                            'Estado dos retrovisores',
                            'Paralama dianteiro'
                        ]
                    },
                    {
                        name: 'CHASSI',
                        items: [
                            'Trincas no chassi e travessas',
                            'Rampa e quinta roda',
                            'Suportes de fixação (tq combustível, bateria, tq arla)',
                            'Danos paralamas traseiros',
                            'Danos e fixação do para barro',
                            'Trincas e fixação da boca de lobo',
                            'Parafuso de fixação do implemento',
                            'Plataformas e suportes dos cones'
                        ]
                    },
                    {
                        name: 'MOTOR',
                        items: [
                            'Radiadores, reservatório de água e intercooler',
                            'Tensores de correia, roletes e polias',
                            'Mangueiras e abraçadeiras do sist. de arrefecimento',
                            'Mangueiras e abraçadeiras do sist. de admissão e intercooler',
                            'Regulagem de válvulas do motor e vazamentos (água/diesel/lub)',
                            'Coxins do motor',
                            'Protetores e fixação do silencioso',
                            'Folga no eixo da turbina ou vazamentos',
                            'Carcaça do filtro e tubulação de ar'
                        ]
                    },
                    {
                        name: 'SISTEMA ELÉTRICO',
                        items: [
                            'Sinalização traseira e dianteira',
                            'Faróis e piscas',
                            'Chicotes elétricos',
                            'Luzes do painel',
                            'Alternador, correia e tensor',
                            'Ventilador, correia e tensor',
                            'Funcionamento dos vidros',
                            'Ar condicionado',
                            'Ventilador e distribuição do ar',
                            'Funcionamento do limpador de para-brisa',
                            'Motor de partida'
                        ]
                    },
                    {
                        name: 'TRANSMISSÃO',
                        items: [
                            'Embreagem (folga/funcionamento)',
                            'Caixa de câmbio (vazamentos/ruídos)',
                            'Cardans e cruzetas',
                            'Acoplamentos e flanges',
                            'Diferencial (fixação/vazamentos)',
                            'Semieixos e juntas',
                            'Suportes e coxins da transmissão'
                        ]
                    },
                    {
                        name: 'EIXO DIANTEIRO',
                        items: [
                            'Rolamentos e cubos',
                            'Manga de eixo',
                            'Amortecedores',
                            'Molas/feixes e fixações',
                            'Barra estabilizadora',
                            'Barra de direção e terminais',
                            'Geometria/folgas de direção'
                        ]
                    },
                    {
                        name: 'EIXO TRASEIRO',
                        items: [
                            'Molas/feixes e fixações',
                            'Amortecedores',
                            'Braços/estabilizadores',
                            'Rolamentos e cubos',
                            'Eixo/diferencial (ruídos/vazamentos)'
                        ]
                    },
                    {
                        name: 'SISTEMA PNEUMÁTICO',
                        items: [
                            'Reservatórios de ar',
                            'Válvulas e conexões',
                            'Mangueiras e flexíveis',
                            'Câmaras de freio',
                            'Tubulações do sistema',
                            'Vazamentos/pressão'
                        ]
                    },
                    {
                        name: 'DIREÇÃO',
                        items: [
                            'Bomba da direção',
                            'Caixa de direção',
                            'Mangueiras e vazamentos',
                            'Folgas no sistema',
                            'Alinhamento/funcionamento'
                        ]
                    }
                ]
            },
            tanques: {
                title: 'Checklist de Liberação - Tanques',
                sections: [
                    {
                        name: 'TIPO DE SERVIÇO',
                        items: [
                            'VERIFICAR MESA (ESTRUTURA, TRINCAS)',
                            'VERIFICAR CHAPA DE FIXAÇÃO',
                            'SOLDA NO CABEÇALHO - REPARAR SE NECESSÁRIO',
                            'CORRIGIR TRINCAS',
                            'PINTURA - REFAZER',
                            'CATALOGAR PEÇAS',
                            'DESMONTAR CUBOS DE RODA',
                            'LAVAR E VERIFICAR ROLAMENTOS',
                            'MONTAR CUBOS',
                            'CORRIGIR TRINCAS E FUROS - REPARAR SE NECESSÁRIO',
                            'CORRIGIR CORRIMÃO - REPARAR SE NECESSÁRIO'
                        ]
                    }
                ]
            }
        };

        let irrCurrentInspection = { tipo:'', frota:'', mecanico:'', data:'', reforma:'nao', items:[], results:{ ok:0, notOk:0, percentage:0 } };

        function selectIrrEquipment(type) {
            irrCurrentInspection = { tipo:type, frota:'', mecanico:'', data:'', reforma:'nao', items:[], results:{ ok:0, notOk:0, percentage:0 } };
            const f = document.getElementById('irrChecklistForm');
            const sel = document.getElementById('irr-sub-inicio');
            if (sel) {
                const cards = document.getElementById('irrEquipCards');
                if (cards) cards.classList.add('hidden');
                if (f) sel.appendChild(f);
            }
            if (f) { f.classList.remove('hidden'); f.classList.add('fade-in'); }
            const tt = document.getElementById('irrChecklistTitle');
            const conf = irrigEquipmentConfigs[type];
            if (tt) tt.textContent = (conf && conf.title) ? conf.title : ({ motobombas:'Checklist • MotoBombas', hidroroll:'Checklist • Hidro Roll', caminhoes:'Checklist • Caminhões', tanques:'Checklist • Tanques' }[type] || 'Checklist • Irrigação');
            irrPhotoSessionId = (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
            generateIrrChecklistItems(type);
            irrPopulateFrotaOptions();
            irrBindFrotaSelect();
            const mechEl = document.getElementById('irrMecanico');
            if (mechEl) {
                const u = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
                mechEl.value = getDisplayName(u);
            }
            const d = document.getElementById('irrDataInspecao');
            if (d) { const t = new Date().toISOString().split('T')[0]; d.value = t; d.max = t; }
            clearIrrResults();
            toggleMobileBar(true);
            try {
                const bind = (id, evt='input') => { const el = document.getElementById(id); if (el && !el._draftBound) { el.addEventListener(evt, saveIrrDraft); el._draftBound = true; } };
                bind('irrDataInspecao','change'); bind('irrMecanico'); bind('irrReformaStatus','change'); bind('irrFrotaSelect','change'); bind('irrFrotaCustom');
                const raw = localStorage.getItem('irrDraft');
                if (raw) {
                    const dft = JSON.parse(raw);
                    if (dft && dft.tipo === type) {
                        const ok = confirm('Encontramos um rascunho anterior de Irrigação. Deseja retomar?');
                        if (ok) restoreIrrDraft(); else { try { localStorage.removeItem('irrDraft'); } catch(_) {} clearIrrResults(); }
                    } else if (dft && dft.tipo && dft.tipo !== type) {
                        const ok2 = confirm('Existe rascunho de outro tipo. Deseja descartar?');
                        if (ok2) { try { localStorage.removeItem('irrDraft'); } catch(_) {} clearIrrResults(); }
                    }
                }
            } catch(_) {}
        }

        function generateIrrChecklistItems(type) {
            const container = document.getElementById('irrChecklistItems');
            const config = irrigEquipmentConfigs[type];
            if (!container) return;
            container.innerHTML = '';
            irrCurrentInspection.items = [];
            let index = 0;
            const isMobile = window.innerWidth < 640;
            if (config && Array.isArray(config.sections)) {
                config.sections.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'mb-6';
                    const secId = 'irr_section_'+index+'_'+Math.random().toString(36).slice(2);
                    sectionDiv.innerHTML = `
                        <button class="w-full flex items-center justify-between px-4 py-2 bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-md" onclick="toggleChecklistSection('${secId}')">
                            <h5 class="text-sm font-semibold text-green-800 dark:text-green-200">${section.name}</h5>
                            <svg class="w-4 h-4 text-green-700 dark:text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div id="${secId}" class="${isMobile ? 'hidden' : ''} space-y-2 mt-2"></div>
                    `;
                    container.appendChild(sectionDiv);
                    const itemsWrap = sectionDiv.querySelector('#'+secId);
                    section.items.forEach(item => {
                        const itemData = { id:index, name:item, section:section.name, status:null, note:'', photos:[] };
                        irrCurrentInspection.items.push(itemData);
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'p-4 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg';
                        itemDiv.innerHTML = `
                            <div class="flex items-center justify-between">
                                <span class="text-gray-900 dark:text-white">${item}</span>
                                <div class="flex space-x-3">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="irr_item_${index}" value="ok" onchange="updateIrrItemStatus(${index}, 'ok')" class="form-radio h-6 w-6 sm:h-4 sm:w-4 text-primary">
                                        <span class="ml-2 text-sm text-green-600 dark:text-green-400">OK</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="irr_item_${index}" value="notok" onchange="updateIrrItemStatus(${index}, 'notok')" class="form-radio h-6 w-6 sm:h-4 sm:w-4 text-primary">
                                        <span class="ml-2 text-sm text-red-600 dark:text-red-400">NÃO OK</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="irr_item_${index}" value="na" onchange="updateIrrItemStatus(${index}, 'na')" class="form-radio h-6 w-6 sm:h-4 sm:w-4 text-primary">
                                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">NÃO APLICA</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-3 hidden" id="irr_note_${index}">
                                <textarea rows="2" placeholder="Observação deste item (opcional)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white" oninput="updateIrrItemNote(${index}, this.value)"></textarea>
                            </div>
                            <div class="mt-3">
                                <input type="file" accept="image/*" capture="environment" class="hidden" id="irr_photo_input_${index}" multiple onchange="handleIrrItemPhoto(${index}, this.files)">
                                <button type="button" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600" onclick="document.getElementById('irr_photo_input_${index}').click()">Adicionar foto</button>
                                <div id="irr_photos_${index}" class="mt-2 flex gap-2 flex-wrap"></div>
                            </div>
                        `;
                        itemsWrap.appendChild(itemDiv);
                        index++;
                    });
                });
            }
        }

        function saveIrrDraft() {
            try {
                const draft = {
                    tipo: irrCurrentInspection.tipo,
                    data: document.getElementById('irrDataInspecao')?.value || '',
                    mecanico: document.getElementById('irrMecanico')?.value || '',
                    frotaSel: document.getElementById('irrFrotaSelect')?.value || '',
                    frotaCustom: document.getElementById('irrFrotaCustom')?.value || '',
                    reforma: document.getElementById('irrReformaStatus')?.value || 'nao',
                    items: Array.isArray(irrCurrentInspection.items) ? irrCurrentInspection.items.map(i => ({ id:i.id, status:i.status, note:i.note, photos:i.photos||[] })) : []
                };
                localStorage.setItem('irrDraft', JSON.stringify(draft));
            } catch(_) {}
        }

        function restoreIrrDraft() {
            try {
                const raw = localStorage.getItem('irrDraft');
                if (!raw) return;
                const draft = JSON.parse(raw);
                if (!draft || draft.tipo !== irrCurrentInspection.tipo) return;
                const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
                setVal('irrDataInspecao', draft.data||'');
                setVal('irrMecanico', draft.mecanico||'');
                const fSel = document.getElementById('irrFrotaSelect');
                const fCus = document.getElementById('irrFrotaCustom');
                if (fSel) { fSel.value = draft.frotaSel||''; }
                if (fCus) { fCus.value = draft.frotaCustom||''; if ((draft.frotaSel||'') === 'custom') fCus.classList.remove('hidden'); }
                const refEl = document.getElementById('irrReformaStatus'); if (refEl) refEl.value = draft.reforma||'nao';
                if (Array.isArray(draft.items)) {
                    draft.items.forEach(it => {
                        const status = it.status;
                        if (status === 'ok' || status === 'notok' || status === 'na') {
                            const radios = document.querySelectorAll(`input[name="irr_item_${it.id}"]`);
                            radios.forEach(r => { r.checked = (r.value === status); });
                            updateIrrItemStatus(it.id, status);
                        }
                        if (typeof it.note === 'string') { updateIrrItemNote(it.id, it.note); const nb = document.getElementById('irr_note_'+it.id); if (nb && status === 'notok') nb.classList.remove('hidden'); }
                        if (Array.isArray(it.photos) && it.photos.length) { irrCurrentInspection.items[it.id].photos = it.photos.slice(0,6); renderIrrItemPhotos(it.id); }
                    });
                }
                calculateIrrResults();
            } catch(_) {}
        }

        function updateIrrItemStatus(itemId, status) {
            irrCurrentInspection.items[itemId].status = status;
            const noteBox = document.getElementById('irr_note_'+itemId);
            if (noteBox) {
                if (status === 'notok') noteBox.classList.remove('hidden'); else { noteBox.classList.add('hidden'); updateIrrItemNote(itemId, ''); }
            }
            calculateIrrResults();
            saveIrrDraft();
        }

        function updateIrrItemNote(itemId, value) { irrCurrentInspection.items[itemId].note = value || ''; saveIrrDraft(); }

        async function handleIrrItemPhoto(itemId, fileList) {
            if (!fileList || fileList.length === 0) return;
            const files = Array.from(fileList).slice(0, 6);
            for (const f of files) {
                try {
                    const canUpload = isOnline() && currentUser && currentUser.id && INSPECTION_PHOTOS_BUCKET;
                    if (canUpload) {
                        const safeName = (f.name || 'foto').replace(/[^A-Za-z0-9._-]/g, '_');
                        const key = `${irrPhotoSessionId}/${itemId}/${Date.now()}_${Math.random().toString(36).slice(2)}_${safeName}`;
                        const up = await supabase.storage.from(INSPECTION_PHOTOS_BUCKET).upload(key, f, { contentType: f.type || 'image/jpeg', upsert: true });
                        if (up && !up.error) {
                            const pub = supabase.storage.from(INSPECTION_PHOTOS_BUCKET).getPublicUrl(key);
                            const url = String((pub && pub.data && pub.data.publicUrl) || '');
                            if (url) {
                                if (!Array.isArray(irrCurrentInspection.items[itemId].photos)) irrCurrentInspection.items[itemId].photos = [];
                                irrCurrentInspection.items[itemId].photos.push(url);
                                renderIrrItemPhotos(itemId);
                                saveIrrDraft();
                                continue;
                            }
                        }
                    }
                    const reader = new FileReader();
                    await new Promise((resolve) => {
                        reader.onload = () => {
                            const url = String(reader.result || '');
                            if (!Array.isArray(irrCurrentInspection.items[itemId].photos)) irrCurrentInspection.items[itemId].photos = [];
                            irrCurrentInspection.items[itemId].photos.push(url);
                            renderIrrItemPhotos(itemId);
                            saveIrrDraft();
                            resolve();
                        };
                        reader.readAsDataURL(f);
                    });
                } catch (_) {
                    try {
                        const reader2 = new FileReader();
                        await new Promise((resolve) => {
                            reader2.onload = () => {
                                const url2 = String(reader2.result || '');
                                if (!Array.isArray(irrCurrentInspection.items[itemId].photos)) irrCurrentInspection.items[itemId].photos = [];
                                irrCurrentInspection.items[itemId].photos.push(url2);
                                renderIrrItemPhotos(itemId);
                                saveIrrDraft();
                                resolve();
                            };
                            reader2.readAsDataURL(f);
                        });
                    } catch (_) {}
                }
            }
            const pi = document.getElementById(`irr_photo_input_${itemId}`);
            if (pi) pi.value = '';
        }

        function renderIrrItemPhotos(itemId) {
            const wrap = document.getElementById(`irr_photos_${itemId}`);
            if (!wrap) return;
            const photos = Array.isArray(irrCurrentInspection.items[itemId].photos) ? irrCurrentInspection.items[itemId].photos : [];
            wrap.innerHTML = photos.map((src, idx) => `
                <div class="relative">
                    <img src="${src}" class="w-16 h-16 object-cover rounded-md border border-gray-200 dark:border-gray-600" />
                    <button type="button" class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-red-600 text-white text-xs" onclick="removeIrrItemPhoto(${itemId}, ${idx})">×</button>
                </div>
            `).join('');
        }

        function removeIrrItemPhoto(itemId, idx) {
            const photos = irrCurrentInspection.items[itemId].photos || [];
            if (photos[idx] != null) { photos.splice(idx, 1); }
            renderIrrItemPhotos(itemId);
        }

        function calculateIrrResults() {
            let ok = 0, notOk = 0;
            irrCurrentInspection.items.forEach(item => { if (item.status === 'ok') ok++; else if (item.status === 'notok') notOk++; });
            const total = ok + notOk;
            const percentage = total > 0 ? Math.round((ok / total) * 100) : 0;
            irrCurrentInspection.results = { ok, notOk, percentage };
            const iok = document.getElementById('irrItensOK'); if (iok) iok.textContent = ok;
            const inok = document.getElementById('irrItensNaoOK'); if (inok) inok.textContent = notOk;
            const per = document.getElementById('irrPercentual'); if (per) per.textContent = percentage + '%';
            const nivelEl = document.getElementById('irrNivelManutencao');
            if (nivelEl) {
                let nivel = '';
                if (percentage >= 90) nivel = 'Excelente'; else if (percentage >= 80) nivel = 'Bom'; else if (percentage >= 70) nivel = 'Regular'; else if (percentage > 0) nivel = 'Crítico'; else nivel = '-';
                nivelEl.textContent = 'Nível de Manutenção: ' + nivel;
            }
        }

        function clearIrrResults() {
            irrCurrentInspection.results = { ok:0, notOk:0, percentage:0 };
            const iok = document.getElementById('irrItensOK'); if (iok) iok.textContent = '0';
            const inok = document.getElementById('irrItensNaoOK'); if (inok) inok.textContent = '0';
            const per = document.getElementById('irrPercentual'); if (per) per.textContent = '0%';
            const nivelEl = document.getElementById('irrNivelManutencao'); if (nivelEl) nivelEl.textContent = 'Nível de Manutenção: -';
        }

        function irrPopulateFrotaOptions() {
            const sel = document.getElementById('irrFrotaSelect');
            if (!sel) return;
            while (sel.options.length > 2) sel.remove(2);
            irrigEquipments.filter(e => e.status !== 'inativo').forEach(e => {
                const o = document.createElement('option'); o.value = e.frota; o.textContent = e.frota; sel.appendChild(o);
            });
        }

        function irrBindFrotaSelect() {
            const sel = document.getElementById('irrFrotaSelect');
            const custom = document.getElementById('irrFrotaCustom');
            if (!sel || !custom) return;
            sel.onchange = function() {
                if (sel.value === 'custom') { custom.classList.remove('hidden'); custom.value = ''; }
                else { custom.classList.add('hidden'); irrCurrentInspection.frota = sel.value; }
            };
            custom.oninput = function() { irrCurrentInspection.frota = custom.value; };
        }

        function clearIrrForm() {
            const sel = document.getElementById('irrFrotaSelect'); if (sel) sel.value = '';
            const custom = document.getElementById('irrFrotaCustom'); if (custom) { custom.value=''; custom.classList.add('hidden'); }
            const mech = document.getElementById('irrMecanico'); if (mech) mech.value='';
            irrCurrentInspection.items.forEach(i => { i.status = null; i.note=''; });
            document.querySelectorAll('[id^="irr_note_"]').forEach(n => n.classList.add('hidden'));
            clearIrrResults();
        }

        async function saveIrrInspection() {
            if (savingInspection) return;
            const date = document.getElementById('irrDataInspecao')?.value || '';
            const mech = document.getElementById('irrMecanico')?.value || '';
            const sel = document.getElementById('irrFrotaSelect');
            const custom = document.getElementById('irrFrotaCustom');
            const frota = sel && sel.value === 'custom' ? (custom?.value || '') : (sel?.value || '');
            if (!irrCurrentInspection.tipo) { showCustomAlert('Selecione o tipo de equipamento.'); return; }
            if (!date || !mech || !frota) { showCustomAlert('Preencha Data, Mecânico e Frota.'); return; }
            showLoading(true);
            savingInspection = true;
            const saveBtns = Array.from(document.querySelectorAll('button[onclick="saveIrrInspection()"]'));
            saveBtns.forEach(b => { b.disabled = true; });
            irrCurrentInspection.data = date;
            irrCurrentInspection.mecanico = mech;
            irrCurrentInspection.frota = frota;
            irrCurrentInspection.created_at = new Date().toISOString();
            irrCurrentInspection.local_id = 'irr_' + Date.now() + '_' + Math.random().toString(36).slice(2);
            const user = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
            const isAuthenticated = !!(user && user.id && user.id !== 'offline');
            const record = JSON.parse(JSON.stringify(irrCurrentInspection));
            record.user_id = user && user.id ? user.id : null;
            const dbInspection = { data: record.data, tipo: record.tipo, frota: record.frota, mecanico: record.mecanico, observacao: record.observacao, items: record.items, results: record.results, user_id: record.user_id, created_at: record.created_at, local_id: record.local_id };
            let savedOnline = false;
            if (isOnline() && isAuthenticated) {
                try {
                    const { data: upData, error } = await supabase
                        .from('irrig_inspections')
                        .upsert([dbInspection], { onConflict: 'local_id' })
                        .select();
                    if (!error && upData && upData[0]) { record.id = upData[0].id; savedOnline = true; }
                } catch (_) {}
            }
            if (!savedOnline) { record.id = record.local_id; queueIrrInspection(dbInspection); }
            const existingIdx = Array.isArray(irrigInspections) ? irrigInspections.findIndex(i => String(i.local_id) === String(record.local_id)) : -1;
            if (existingIdx >= 0) irrigInspections[existingIdx] = record; else irrigInspections.push(record);
            setCachedIrrInspections(irrigInspections);
            renderIrrHistory();
            updateStats();
            if (savedOnline) {
                try { await supabase.from('system_events').insert([{ type:'new_inspection', title:'Nova inspeção (Irrigação)', message: `${record.tipo||''} • ${record.frota||''} • ${record.mecanico||''}`, payload: { tipo: record.tipo||'', frota: record.frota||'', mecanico: record.mecanico||'', data: record.data||'', id: record.id||'', local_id: record.local_id||'', modulo: 'irr' } }]); } catch(_) {}
                try { systemBroadcastChannel && systemBroadcastChannel.send({ type:'broadcast', event:'new_inspection', payload: { modulo:'irr', tipo: record.tipo||'', frota: record.frota||'', mecanico: record.mecanico||'', data: record.data||'', id: record.id||'', local_id: record.local_id||'' } }); } catch(_) {}
            }
            try { pushNotification('info', 'Nova inspeção (Irrigação)', record.frota ? `Inspeção lançada para ${record.frota}` : 'Inspeção lançada', { modulo:'irr', tipo: record.tipo||'', frota: record.frota||'', mecanico: record.mecanico||'', data: record.data||'', id: record.id||'', local_id: record.local_id||'' }); } catch(_) {}
            showFloatingNotification('success', 'Inspeção de irrigação salva!');
            showIrrSubsection('historico');
            try { localStorage.removeItem('irrDraft'); } catch(_) {}
            savingInspection = false;
            saveBtns.forEach(b => { b.disabled = false; });
            showLoading(false);
        }

        function populateIrrEquipmentList() {
            const container = document.querySelector('#irr-sub-equipamentos');
            if (!container) return;
            container.innerHTML = '';
            const wrap = document.createElement('div');
            wrap.className = 'space-y-6';
            const form = document.createElement('div');
            form.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700';
            form.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Novo Equipamento • Irrigação</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Tipo</label>
                        <select id="irrEquipTipo" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="motobombas">MotoBombas</option>
                            <option value="hidroroll">Hidro Roll</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Frota</label>
                        <input type="text" id="irrEquipFrota" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Descrição</label>
                        <input type="text" id="irrEquipDesc" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Status</label>
                        <select id="irrEquipStatus" class="w-full px-3 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                            <option value="ativo" selected>Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button onclick="addIrrEquipment()" class="px-6 py-3 bg-primary text-white rounded-md hover:bg-primary-dark">Salvar</button>
                    <button onclick="populateIrrEquipmentList()" class="px-6 py-3 border border-gray-300 dark:border-gray-600 text-gray-700 dark:text-gray-300 rounded-md hover:bg-gray-50 dark:hover:bg-gray-700">Atualizar Lista</button>
                </div>
            `;
            wrap.appendChild(form);
            const list = document.createElement('div');
            list.className = 'bg-white dark:bg-gray-800 p-6 rounded-xl border border-gray-200 dark:border-gray-700';
            list.innerHTML = `
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-6">Frotas Cadastradas • Irrigação</h3>
                <div id="irrEquipList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            `;
            wrap.appendChild(list);
            container.appendChild(wrap);
            const equipList = document.getElementById('irrEquipList');
            equipList.innerHTML = '';
            irrigEquipments.forEach(e => {
                const card = document.createElement('div');
                card.className = 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg';
                card.innerHTML = `<div class="font-semibold">${e.frota}</div><div class="text-sm text-gray-600 dark:text-gray-400">${e.tipo} • ${e.status}</div><div class="text-xs text-gray-500 dark:text-gray-500">${e.desc||''}</div>`;
                equipList.appendChild(card);
            });
        }

        function addIrrEquipment() {
            const tipo = document.getElementById('irrEquipTipo')?.value || 'motobombas';
            const frota = document.getElementById('irrEquipFrota')?.value || '';
            const desc = document.getElementById('irrEquipDesc')?.value || '';
            const status = document.getElementById('irrEquipStatus')?.value || 'ativo';
            if (!frota.trim()) return;
            irrigEquipments.push({ tipo, frota, desc, status });
            populateIrrEquipmentList();
        }

        function renderIrrHistory(dataOverride) {
            const container = document.querySelector('#irr-sub-historico');
            if (!container) return;
            const body = document.getElementById('irrHistoryBody');
            body.innerHTML = '';
            const data = Array.isArray(dataOverride) ? dataOverride : irrigInspections;
            if (data.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td'); td.colSpan = 6; td.className = 'px-6 py-8 text-center text-gray-500 dark:text-gray-400'; td.textContent = 'Nenhuma inspeção encontrada';
                tr.appendChild(td); body.appendChild(tr); return;
            }
            data.forEach(i => {
                const admin = isAdmin();
                const inspId = String(i.id || i.local_id);
                const pending = !i.id || String(i.id) === String(i.local_id);
                const statusBadge = pending
                    ? `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 ml-2">Pendente</span>`
                    : `<span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 ml-2">Sincronizado</span>`;
                const actions = admin ? `
                    <button onclick="openEditInspection('${inspId}')" class="ml-3 text-yellow-600 hover:text-yellow-700 text-sm font-medium">Editar</button>
                    <button onclick="deleteInspection('${inspId}')" class="ml-3 text-red-600 hover:text-red-700 text-sm font-medium">Excluir</button>
                ` : '';
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${i.data||'-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${i.tipo}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${i.frota||'-'} ${statusBadge}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${i.mecanico||'-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${i.results?.percentage||0}%</td>
                    <td class="px-6 py-4">
                        <button onclick="viewInspection('${inspId}')" class="text-primary hover:text-primary-dark text-sm font-medium">Ver detalhes</button>
                        ${actions}
                    </td>`;
                body.appendChild(tr);
            });
        }

        function filterIrrHistory() {
            const tipo = document.getElementById('irrFiltroTipo')?.value || '';
            const di = document.getElementById('irrFiltroDataInicial')?.value || '';
            const df = document.getElementById('irrFiltroDataFinal')?.value || '';
            const start = di ? new Date(di) : null;
            const end = df ? new Date(df) : null;
            const filtered = irrigInspections.filter(i => {
                if (tipo && i.tipo !== tipo) return false;
                if (start) { const id = new Date(i.data); if (id < start) return false; }
                if (end) { const id2 = new Date(i.data); if (id2 > end) return false; }
                return true;
            });
            renderIrrHistory(filtered);
        }

        let irrChartsInitialized = false; let irrPerfChart = null; let irrEquipChart = null;
        function initializeIrrCharts() {
            if (irrChartsInitialized) return;
            const perf = document.getElementById('irrPerformanceChart');
            const equip = document.getElementById('irrEquipmentChart');
            if (perf && window.Chart) {
                irrPerfChart = new Chart(perf, { type:'line', data:{ labels:[], datasets:[{ label:'Aprovação', data:[], borderColor:'#5D5CDE' }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
            if (equip && window.Chart) {
                irrEquipChart = new Chart(equip, { type:'doughnut', data:{ labels:['MotoBombas','Hidro Roll'], datasets:[{ data:[0,0], backgroundColor:['#F43F5E','#10B981'] }] }, options:{ responsive:true, maintainAspectRatio:false } });
            }
            irrChartsInitialized = true;
        }

        function updateIrrAnalytics() {
            const periodSel = document.getElementById('irrChartPeriod');
            const days = periodSel ? parseInt(periodSel.value, 10) : 30;
            const toDate = new Date();
            const fromDate = new Date(); fromDate.setDate(toDate.getDate() - days);
            const eq = document.getElementById('irrEquipmentFilter')?.value || 'all';
            const leader = document.getElementById('irrLeaderFilter')?.value || 'all';
            const filtered = irrigInspections.filter(i => {
                if (!i.data) return false;
                const d = new Date(i.data);
                if (!(d >= fromDate && d <= toDate)) return false;
                if (eq !== 'all' && i.tipo !== eq) return false;
                if (leader !== 'all' && (i.mecanico||'') !== leader) return false;
                return true;
            });
            if (irrPerfChart) {
                const labels = filtered.map((i, idx) => idx+1);
                const data = filtered.map(i => i.results?.percentage||0);
                irrPerfChart.data.labels = labels; irrPerfChart.data.datasets[0].data = data; irrPerfChart.update();
            }
            if (irrEquipChart) {
                const counts = { motobombas:0, hidroroll:0 };
                filtered.forEach(i => { if (counts[i.tipo] != null) counts[i.tipo]++; });
                irrEquipChart.data.datasets[0].data = [counts.motobombas, counts.hidroroll];
                irrEquipChart.update();
            }
        }

        function updateIrrAnalyticsSummary() {
            const periodSel = document.getElementById('irrChartPeriod');
            const days = periodSel ? parseInt(periodSel.value, 10) : 30;
            const toDate = new Date();
            const fromDate = new Date(); fromDate.setDate(toDate.getDate() - days);
            const eq = document.getElementById('irrEquipmentFilter')?.value || 'all';
            const leader = document.getElementById('irrLeaderFilter')?.value || 'all';
            const filtered = irrigInspections.filter(i => {
                if (!i.data) return false;
                const d = new Date(i.data);
                if (!(d >= fromDate && d <= toDate)) return false;
                if (eq !== 'all' && i.tipo !== eq) return false;
                if (leader !== 'all' && (i.mecanico||'') !== leader) return false;
                return true;
            });
            const percentages = filtered.map(i => i.results?.percentage||0);
            const avg = percentages.length ? Math.round(percentages.reduce((a,b)=>a+b,0)/percentages.length) : 0;
            const criticalCount = filtered.reduce((acc,i)=> acc + (i.results?.notOk>0 ? 1 : 0), 0);
            const productivity = avg;
            const rateEl = document.getElementById('irrApprovalRate'); if (rateEl) rateEl.textContent = avg + '%';
            const avgTimeEl = document.getElementById('irrAvgTime'); if (avgTimeEl) avgTimeEl.textContent = '0min';
            const critCardEl = document.getElementById('irrCriticalCountCard'); if (critCardEl) critCardEl.textContent = String(criticalCount);
            const prodEl = document.getElementById('irrProductivity'); if (prodEl) prodEl.textContent = productivity + '%';
            const critBadgeEl = document.getElementById('irrCriticalCountBadge'); if (critBadgeEl) critBadgeEl.textContent = criticalCount + ' ativos';
            const issues = document.getElementById('irrCriticalIssues');
            if (issues) {
                issues.innerHTML = '';
                const recent = filtered.filter(i => (i.results?.notOk||0)>0).slice(-3).reverse();
                if (recent.length === 0) {
                    const d = document.createElement('div'); d.className = 'text-gray-500 dark:text-gray-400'; d.textContent = 'Nenhum problema crítico no período'; issues.appendChild(d);
                } else {
                    recent.forEach(i => {
                        const card = document.createElement('div'); card.className = 'p-4 border border-gray-200 dark:border-gray-700 rounded-lg';
                        card.innerHTML = `<div class="font-semibold text-gray-900 dark:text-white">${i.tipo} • ${i.frota||'-'}</div><div class="text-sm text-gray-600 dark:text-gray-400">${i.data||'-'} • Líder: ${i.mecanico||'-'}</div><div class="mt-2 text-sm"><span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-200">${i.results?.notOk||0} não ok</span></div>`; issues.appendChild(card);
                    });
                }
            }
            const top = document.getElementById('irrTopMecanicos');
            if (top) {
                top.innerHTML = '';
                const byLeader = {};
                filtered.forEach(i => {
                    const k = i.mecanico||'-';
                    if (!byLeader[k]) byLeader[k] = []; byLeader[k].push(i.results?.percentage||0);
                });
                const pairs = Object.entries(byLeader).map(([name, arr]) => ({ name, avg: Math.round(arr.reduce((a,b)=>a+b,0)/arr.length) }));
                pairs.sort((a,b)=> b.avg - a.avg);
                pairs.slice(0,5).forEach(p => {
                    const row = document.createElement('div'); row.className = 'flex items-center justify-between p-3 border border-gray-200 dark:border-gray-700 rounded-lg';
                    row.innerHTML = `<span class="text-gray-900 dark:text-white">${p.name}</span><span class="text-sm font-semibold text-green-600 dark:text-green-400">${p.avg}%</span>`; top.appendChild(row);
                });
                if (pairs.length === 0) { const r = document.createElement('div'); r.className='text-gray-500 dark:text-gray-400'; r.textContent='Sem dados para líderes'; top.appendChild(r); }
            }
        }

        function populateIrrLeaderFilter() {
            const sel = document.getElementById('irrLeaderFilter'); if (!sel) return;
            const set = new Set(); irrigInspections.forEach(i => { if ((i.mecanico||'').trim()) set.add(i.mecanico.trim()); });
            const current = sel.value;
            sel.innerHTML = '<option value="all" selected>Todos líderes</option>';
            Array.from(set).sort().forEach(name => { const o=document.createElement('option'); o.value=name; o.textContent=name; sel.appendChild(o); });
            sel.value = current && current !== '' ? current : 'all';
        }

        function clearIrrAnalyticsFilters() {
            const periodSel = document.getElementById('irrChartPeriod'); if (periodSel) periodSel.value = '30';
            const eqSel = document.getElementById('irrEquipmentFilter'); if (eqSel) eqSel.value = 'all';
            const leaderSel = document.getElementById('irrLeaderFilter'); if (leaderSel) leaderSel.value = 'all';
        }

        function generateIrrReportCSV(rows, filename) {
            const csv = rows.map(r => r.map(v => '"'+String(v).replace(/"/g,'""')+'"').join(',')).join('\n');
            const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = filename || 'relatorio_irrigacao.csv'; a.click();
            URL.revokeObjectURL(url);
        }

        function generateIrrReport() {
            let type = document.getElementById('irrReportType')?.value || 'geral';
            if ((!type || type === 'geral') && typeof window !== 'undefined' && window.quickIrrReportType) { type = window.quickIrrReportType; }
            const period = document.getElementById('irrReportPeriod')?.value || '30';
            const eqType = document.getElementById('irrReportEqType')?.value || 'all';
            let format = document.getElementById('irrReportFormat')?.value || 'csv';
            const supported = ['csv','excel','pdf','json'];
            if (!supported.includes(format)) { format = 'csv'; }
            const daysMap = { '7': 7, '30': 30, '90': 90 };
            const days = daysMap[period] || 30;
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - days + 1);
            let filtered = irrigInspections.filter(i => {
                const d = new Date(i.data || new Date());
                return d >= start && d <= end;
            });
            if (eqType && eqType !== 'all') {
                filtered = filtered.filter(i => String(i.tipo) === eqType);
            }
            const quickTypes = ['summary','performance','maintenance','trends','compliance','costs'];
            if (quickTypes.includes(type)) {
                if (type === 'performance') {
                    filtered = filtered.slice().sort((a,b) => (b.results?.percentage||0) - (a.results?.percentage||0));
                } else if (type === 'maintenance') {
                    filtered = filtered.filter(i => {
                        const items = Array.isArray(i.items) ? i.items : [];
                        const hasNonOkItem = items.some(it => {
                            const s = it.status;
                            const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                            const hasNote = !!(it.note && String(it.note).trim());
                            return sval === 'notok' || (!s && hasNote);
                        });
                        return (i.results?.notOk||0) > 0 || hasNonOkItem;
                    });
                } else if (type === 'trends') {
                    filtered = filtered.slice().sort((a,b) => new Date(a.data) - new Date(b.data));
                } else if (type === 'compliance') {
                    filtered = filtered.filter(i => (i.results?.percentage||0) >= 90);
                } else if (type === 'costs') {
                    filtered = filtered.filter(i => (i.results?.notOk||0) > 0);
                }
            } else if (type === 'criticos') {
                filtered = filtered.filter(i => (i.results?.notOk||0) > 0);
            }
            const total = filtered.length;
            const avg = total ? Math.round(filtered.reduce((s,i)=>s+(i.results?.percentage||0),0)/total) : 0;
            const counts = { motobombas:0, hidroroll:0, tortao:0 };
            filtered.forEach(i => { if (counts[i.tipo] !== undefined) counts[i.tipo]++; });
            if (format === 'json') {
                const payload = { type, period, summary: { total, average: avg, counts }, inspections: filtered };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `relatorio_irrigacao_${type}_${period}.json`; a.click(); URL.revokeObjectURL(a.href);
            } else if (format === 'csv') {
                const header = ['data','tipo','frota','lider','ok','nao_ok','percentual','observacao'];
                const rows = filtered.map(i => {
                    const obs = i.observacao || (Array.isArray(i.items) ? ((i.items.find(it => String(it.name) === 'Observação')?.note) || '') : '');
                    const esc = (v) => { const s = String(v ?? ''); if (s.includes(',') || s.includes('"') || s.includes('\n')) return '"' + s.replaceAll('"', '""') + '"'; return s; };
                    return [esc(i.data), esc(i.tipo), esc(i.frota), esc(i.mecanico), esc(i.results?.ok||0), esc(i.results?.notOk||0), esc(i.results?.percentage||0), esc(obs)].join(',');
                });
                const csv = [header.join(','), ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `relatorio_irrigacao_${type}_${period}.csv`; a.click(); URL.revokeObjectURL(a.href);
            } else if (format === 'excel') {
                const header = ['Data','Tipo','Frota','Líder','OK','NÃO OK','Percentual'];
                const rows = filtered.map(i => `
                    <tr>
                        <td>${i.data}</td>
                        <td>${i.tipo}</td>
                        <td>${i.frota}</td>
                        <td>${i.mecanico}</td>
                        <td>${i.results?.ok||0}</td>
                        <td>${i.results?.notOk||0}</td>
                        <td>${i.results?.percentage||0}</td>
                    </tr>
                `).join('');
                const html = `
                    <html><head><meta charset="utf-8" /></head><body>
                        <table border="1">
                            <thead><tr>${header.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </body></html>
                `;
                const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `relatorio_irrigacao_${type}_${period}.xls`; a.click(); URL.revokeObjectURL(a.href);
            } else if (format === 'pdf') {
                const rows = (filtered.length ? filtered.map(i => `
                    <tr>
                        <td>${formatDateBR(i.data)}</td>
                        <td>${i.tipo}</td>
                        <td>${i.frota}</td>
                        <td>${i.mecanico}</td>
                        <td>${i.results?.ok||0}</td>
                        <td>${i.results?.notOk||0}</td>
                        <td>${i.results?.percentage||0}%</td>
                    </tr>
                `).join('') : '<tr><td colspan="7">Sem registros no período selecionado</td></tr>');
                const dist = counts;
                const dateRange = `${start.toLocaleDateString('pt-BR')} — ${end.toLocaleDateString('pt-BR')}`;
                const maintSection = (type === 'maintenance') ? (() => {
                    const blocks = filtered.map(i => {
                        const arr = Array.isArray(i.items) ? i.items : [];
                        const nonOk = arr.filter(it => {
                            const s = it.status;
                            const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                            const hasNote = !!(it.note && String(it.note).trim());
                            return sval === 'notok' || (!s && hasNote);
                        });
                        if (!nonOk.length) return '';
                        const lines = nonOk.map(it => {
                            const s = it.status;
                            const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                            const statusLabel = sval === 'notok' ? 'NÃO OK' : (sval === 'ok' ? 'OK' : 'NÃO OK');
                            const choice = (it.note && String(it.note).trim()) || (it.value && String(it.value).trim()) || (it.selected && String(it.selected).trim()) || '';
                            const desc = `${(it.section?it.section+' • ':'')}${it.name}`;
                            return `<li>${desc} — ${statusLabel}${choice ? ' • Motivo: '+choice : ''}</li>`;
                        }).join('');
                        return `<div class="mcard"><div class="mh">${formatDateBR(i.data)} • ${i.tipo} • Frota: ${i.frota} • Líder: ${i.mecanico}</div><ul class="mlist">${lines}</ul></div>`;
                    }).filter(Boolean).join('');
                    return blocks ? `<div class="section"><h4>Manutenções e Motivos</h4>${blocks}</div>` : `<div class="section"><h4>Manutenções e Motivos</h4><div class="muted">Nenhum motivo registrado</div></div>`;
                })() : '';
                const doc = `
                    <html><head>
                        <meta charset="utf-8" />
                        <title>Relatório</title>
                        <style>
                            @page { size: A4 portrait; margin: 12mm; }
                            * { box-sizing: border-box; }
                            body { font-family: Inter, Arial, sans-serif; padding: 0; color: #111827; }
                            .container { max-width: 940px; margin: 0 auto; padding: 24px; }
                            .header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 16px; }
                            .brand { display:flex; align-items:center; gap:10px; }
                            .logo { width:28px; height:28px; border-radius:8px; background:#5D5CDE; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
                            .title { font-size: 18px; font-weight: 700; }
                            .subtitle { font-size: 12px; color:#6B7280; }
                            .kpis { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin: 18px 0; }
                            .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
                            .card h4 { margin:0; font-size:12px; color:#6B7280; }
                            .card .value { font-size:20px; font-weight:700; margin-top:6px; }
                            .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
                            .chip { font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #e5e7eb; color:#374151; background:#f9fafb; }
                            .table-wrap { margin-top: 16px; }
                            table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                            thead th { background: #f3f4f6; text-align: left; font-size: 11px; color:#374151; border-bottom:1px solid #e5e7eb; }
                            th, td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 11px; word-break: break-word; }
                            tbody tr:nth-child(odd) { background: #fafafa; }
                            .section { margin-top: 18px; }
                            .mcard { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; margin-top:10px; }
                            .mh { font-size:12px; color:#374151; margin-bottom:8px; }
                            .mlist { margin:0; padding-left:16px; font-size:11px; color:#111827; }
                            .footer { margin-top: 18px; font-size: 11px; color:#6B7280; text-align:right; }
                            @media screen { body { background:#f3f4f6; } .container { background:#fff; padding:24px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); } }
                        </style>
                    </head><body onload="window.print()">
                        <div class="container">
                            <div class="header">
                                <div class="brand"><div class="logo">GG</div><div><div class="title">GGOMES-LOG • Relatório ${type} (Irrigação)</div><div class="subtitle">${dateRange}</div></div></div>
                                <div class="subtitle">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
                            </div>
                            <div class="kpis">
                                <div class="card"><h4>Total</h4><div class="value">${total}</div></div>
                                <div class="card"><h4>Média de aprovação</h4><div class="value">${avg}%</div></div>
                                <div class="card"><h4>Distribuição</h4>
                            <div class="chips">
                                        <span class="chip">MotoBombas: ${dist.motobombas}</span>
                                        <span class="chip">Hidro Roll: ${dist.hidroroll}</span>
                                        <span class="chip">Tortão: ${dist.tortao}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="table-wrap">
                                <table>
                                    <thead>
                                        <tr><th>Data</th><th>Tipo</th><th>Frota</th><th>Líder</th><th>OK</th><th>NÃO OK</th><th>%</th></tr>
                                    </thead>
                                    <tbody>${rows}</tbody>
                                </table>
                            </div>
                            ${maintSection}
                            ${(type === 'performance') ? (() => {
                                const blocks = filtered.map(i => {
                                    const arr = Array.isArray(i.items) ? i.items : [];
                                    const okItems = arr.filter(it => {
                                        const s = it.status;
                                        const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                                        return sval === 'ok';
                                    });
                                    if (!okItems.length) return '';
                                    const lines = okItems.map(it => {
                                        const choice = (it.note && String(it.note).trim()) || (it.value && String(it.value).trim()) || (it.selected && String(it.selected).trim()) || '';
                                        const desc = `${(it.section?it.section+' • ':'')}${it.name}`;
                                        return `<li>${desc} — OK${choice ? ' • Observação: '+choice : ''}</li>`;
                                    }).join('');
                                    return `<div class="mcard"><div class="mh">${formatDateBR(i.data)} • ${i.tipo} • Frota: ${i.frota} • Líder: ${i.mecanico}</div><ul class="mlist">${lines}</ul></div>`;
                                }).filter(Boolean).join('');
                                return blocks ? `<div class="section"><h4>Itens OK (Performance)</h4>${blocks}</div>` : '';
                            })() : ''}
                            <div class="footer">Sistema de Checklist • ${new Date().getFullYear()}</div>
                        </div>
                    </body></html>
                `;
                const w = window.open('', '_blank'); if (w) { w.document.write(doc); w.document.close(); }
            } else { showFloatingNotification('warning', 'Formato não suportado. Use CSV, Excel ou PDF.'); }
            if (typeof window !== 'undefined') { try { window.quickIrrReportType = ''; } catch(_) {} }
        }

        function generateIrrQuickReport(type) {
            const sel = document.getElementById('irrReportType');
            const per = document.getElementById('irrReportPeriod');
            const fmt = document.getElementById('irrReportFormat');
            if (sel) sel.value = type;
            if (per) per.value = '90';
            if (fmt) fmt.value = 'pdf';
            try { window.quickIrrReportType = type; } catch(_) {}
            generateIrrReport();
        }

        function scheduleIrrReport() {
            showFloatingNotification('info', 'Agendamento de relatório de irrigação será implementado em breve.');
        }

        function selectEquipment(type) {
            currentEquipment = type;
            document.getElementById('equipmentSelection').classList.add('hidden');
            document.getElementById('checklistForm').classList.remove('hidden');
            document.getElementById('checklistForm').classList.add('fade-in');
                const titles = {
                    caminhao: 'Checklist - Caminhão',
                    trator: 'Checklist - Trator',
                    colhedora: 'Checklist - Colhedora',
                    reboque: 'Checklist - Reboque',
                    transbordo: 'Checklist - Transbordo',
                    plantadora: 'Checklist - Plantadora de Cana',
                    distribuidora: 'Checklist - Distribuidora de Cana',
                    cobridores: 'Checklist - Cobridores',
                    tortao: 'Checklist - Tortão',
                };
            document.getElementById('checklistTitle').textContent = titles[type] || 'Checklist';
            generateChecklistItems(type);
            populateFrotaOptions(type);
            bindFrotaSelect();
            setCurrentDate();
            clearResults();
            toggleMobileBar(true);
            const mechEl = document.getElementById('mecanico');
            if (mechEl) {
                const u = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
                mechEl.value = getDisplayName(u);
            }
            try {
                const bind = (id, evt='input') => { const el = document.getElementById(id); if (el && !el._draftBound) { el.addEventListener(evt, saveCCTDraft); el._draftBound = true; } };
                bind('dataInspecao','change'); bind('mecanico'); bind('observacao'); bind('reformaStatus','change'); bind('frotaSelect','change'); bind('frotaCustom');
                const raw = localStorage.getItem('cctDraft');
                if (raw) {
                    const d = JSON.parse(raw);
                    if (d && d.tipo === currentEquipment) {
                        const ok = confirm('Encontramos um rascunho anterior. Deseja retomar?');
                        if (ok) restoreCCTDraft(); else { try { localStorage.removeItem('cctDraft'); } catch(_) {} clearForm(); }
                    } else if (d && d.tipo && d.tipo !== currentEquipment) {
                        const ok2 = confirm('Existe rascunho de outro equipamento. Deseja descartar?');
                        if (ok2) { try { localStorage.removeItem('cctDraft'); } catch(_) {} clearForm(); }
                    }
                }
            } catch(_) {}
        }

        function selectFromCCT(type) {
            showSection('cct_coque');
            backToSelection();
            selectEquipment(type);
        }

        function generateChecklistItems(type) {
            const container = document.getElementById('checklistItems');
            const map = { caminhao: 'truck', trator: 'tractor', colhedora: 'harvester', reboque: 'trailer', manutencao: 'maintenance', plantadora: 'planter', distribuidora: 'distributor', cct_coque: 'cctCoque', tortao: 'tortao' };
            map.transbordo = 'transbordo';
            map.cobridores = 'cobridores';
            const key = map[type];
            const config = key ? equipmentConfigs[key] : null;
            container.innerHTML = '';
            currentInspection.items = [];
            let index = 0;
            const isMobile = window.innerWidth < 640;
            let sectionCount = 0;
            currentPhotoSessionId = (crypto && crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
            if (config && Array.isArray(config.sections)) {
                config.sections.forEach(section => {
                    const sectionDiv = document.createElement('div');
                    sectionDiv.className = 'mb-6';
                    const secId = `sectionItems_${sectionCount++}`;
                    sectionDiv.innerHTML = `
                        <button class="w-full flex items-center justify-between px-4 py-2 bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-md" onclick="toggleChecklistSection('${secId}')">
                            <h5 class="text-sm font-semibold text-green-800 dark:text-green-200">${section.name}</h5>
                            <svg class="w-4 h-4 text-green-700 dark:text-green-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                        </button>
                        <div id="${secId}" class="${isMobile ? 'hidden' : ''} space-y-2 mt-2"></div>
                    `;
                    container.appendChild(sectionDiv);
                    const itemsWrap = sectionDiv.querySelector(`#${secId}`);
                if (Array.isArray(section.items)) {
                    section.items.forEach(item => {
                        const itemData = { id: index, name: item, section: section.name, status: null, note: '', photos: [] };
                        currentInspection.items.push(itemData);
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'p-4 bg-white dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-lg';
                        itemDiv.innerHTML = `
                            <div class="flex items-center justify-between">
                                <span class="text-gray-900 dark:text-white">${item}</span>
                                <div class="flex space-x-3">
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="item_${index}" value="ok" onchange="updateItemStatus(${index}, 'ok')" class="form-radio h-6 w-6 sm:h-4 sm:w-4 text-primary">
                                        <span class="ml-2 text-sm text-green-600 dark:text-green-400">OK</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="item_${index}" value="notok" onchange="updateItemStatus(${index}, 'notok')" class="form-radio h-6 w-6 sm:h-4 sm:w-4 text-primary">
                                        <span class="ml-2 text-sm text-red-600 dark:text-red-400">NÃO OK</span>
                                    </label>
                                    <label class="inline-flex items-center">
                                        <input type="radio" name="item_${index}" value="na" onchange="updateItemStatus(${index}, 'na')" class="form-radio h-6 w-6 sm:h-4 sm:w-4 text-primary">
                                        <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">NÃO APLICA</span>
                                    </label>
                                </div>
                            </div>
                            <div class="mt-3 hidden" id="note_${index}">
                                <textarea rows="2" placeholder="Observação deste item (opcional)" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" oninput="updateItemNote(${index}, this.value)"></textarea>
                            </div>
                            <div class="mt-3">
                                <input type="file" accept="image/*" capture="environment" class="hidden" id="photo_input_${index}" multiple onchange="handleItemPhoto(${index}, this.files)">
                                <button type="button" class="px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-600" onclick="document.getElementById('photo_input_${index}').click()">Adicionar foto</button>
                                <div id="photos_${index}" class="mt-2 flex gap-2 flex-wrap"></div>
                            </div>
                        `;
                        itemsWrap.appendChild(itemDiv);
                        index++;
                    });
                }
                // Observações da seção (nota sem status)
                const secIndex = index;
                currentInspection.items.push({ id: secIndex, name: `Observações da seção - ${section.name}`, section: section.name, status: null, note: '' });
                const secNoteDiv = document.createElement('div');
                secNoteDiv.className = 'p-4 bg-gray-50 dark:bg-gray-800 border border-dashed border-gray-300 dark:border-gray-600 rounded-lg';
                secNoteDiv.innerHTML = `
                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Observações da seção</label>
                    <textarea rows="2" placeholder="Observações gerais desta seção" class="w-full px-3 py-2 text-sm border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent" oninput="updateItemNote(${secIndex}, this.value)"></textarea>
                `;
                itemsWrap.appendChild(secNoteDiv);
                index++;
                });
            }
        }

        function saveCCTDraft() {
            try {
                const draft = {
                    tipo: currentEquipment,
                    data: document.getElementById('dataInspecao')?.value || '',
                    mecanico: document.getElementById('mecanico')?.value || '',
                    observacao: document.getElementById('observacao')?.value || '',
                    reforma: document.getElementById('reformaStatus')?.value || 'nao',
                    frotaSel: document.getElementById('frotaSelect')?.value || '',
                    frotaCustom: document.getElementById('frotaCustom')?.value || '',
                    items: Array.isArray(currentInspection.items) ? currentInspection.items.map(i => ({ id:i.id, status:i.status, note:i.note, photos:i.photos||[] })) : []
                };
                localStorage.setItem('cctDraft', JSON.stringify(draft));
            } catch(_) {}
        }

        function restoreCCTDraft() {
            try {
                const raw = localStorage.getItem('cctDraft');
                if (!raw) return;
                const draft = JSON.parse(raw);
                if (!draft || draft.tipo !== currentEquipment) return;
                const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
                setVal('dataInspecao', draft.data||'');
                setVal('mecanico', draft.mecanico||'');
                setVal('observacao', draft.observacao||'');
                const refEl = document.getElementById('reformaStatus'); if (refEl) refEl.value = draft.reforma||'nao';
                const fSel = document.getElementById('frotaSelect');
                const fCus = document.getElementById('frotaCustom');
                if (fSel) { fSel.value = draft.frotaSel||''; }
                if (fCus) { fCus.value = draft.frotaCustom||''; if ((draft.frotaSel||'') === 'custom') fCus.classList.remove('hidden'); }
                if (Array.isArray(draft.items)) {
                    draft.items.forEach(it => {
                        const status = it.status;
                        if (status === 'ok' || status === 'notok' || status === 'na') {
                            const radios = document.querySelectorAll(`input[name="item_${it.id}"]`);
                            radios.forEach(r => { r.checked = (r.value === status); });
                            updateItemStatus(it.id, status);
                        }
                        if (typeof it.note === 'string') { updateItemNote(it.id, it.note); const nb = document.getElementById('note_'+it.id); if (nb && status === 'notok') nb.classList.remove('hidden'); }
                        if (Array.isArray(it.photos) && it.photos.length) { currentInspection.items[it.id].photos = it.photos.slice(0,6); renderItemPhotos(it.id); }
                    });
                }
                calculateResults();
            } catch(_) {}
        }

        function toggleChecklistSection(id) {
            const el = document.getElementById(id);
            if (!el) return;
            if (el.classList.contains('hidden')) el.classList.remove('hidden'); else el.classList.add('hidden');
        }

        async function handleItemPhoto(itemId, fileList) {
            if (!fileList || fileList.length === 0) return;
            const files = Array.from(fileList).slice(0, 6);
            for (const f of files) {
                try {
                    const canUpload = isOnline() && currentUser && currentUser.id && INSPECTION_PHOTOS_BUCKET;
                    if (canUpload) {
                        const safeName = (f.name || 'foto').replace(/[^A-Za-z0-9._-]/g, '_');
                        const key = `${currentPhotoSessionId}/${itemId}/${Date.now()}_${Math.random().toString(36).slice(2)}_${safeName}`;
                        const up = await supabase.storage.from(INSPECTION_PHOTOS_BUCKET).upload(key, f, { contentType: f.type || 'image/jpeg', upsert: true });
                        if (up && !up.error) {
                            const pub = supabase.storage.from(INSPECTION_PHOTOS_BUCKET).getPublicUrl(key);
                            const url = String((pub && pub.data && pub.data.publicUrl) || '');
                            if (url) {
                                if (!Array.isArray(currentInspection.items[itemId].photos)) currentInspection.items[itemId].photos = [];
                                currentInspection.items[itemId].photos.push(url);
                                renderItemPhotos(itemId);
                                continue;
                            }
                        }
                    }
                    const reader = new FileReader();
                    await new Promise((resolve) => {
                        reader.onload = () => {
                            const url = String(reader.result || '');
                            if (!Array.isArray(currentInspection.items[itemId].photos)) currentInspection.items[itemId].photos = [];
                            currentInspection.items[itemId].photos.push(url);
                            renderItemPhotos(itemId);
                            resolve();
                        };
                        reader.readAsDataURL(f);
                    });
                } catch (_) {
                    try {
                        const reader2 = new FileReader();
                        await new Promise((resolve) => {
                            reader2.onload = () => {
                                const url2 = String(reader2.result || '');
                                if (!Array.isArray(currentInspection.items[itemId].photos)) currentInspection.items[itemId].photos = [];
                                currentInspection.items[itemId].photos.push(url2);
                                renderItemPhotos(itemId);
                                resolve();
                            };
                            reader2.readAsDataURL(f);
                        });
                    } catch (_) {}
                }
            }
            const pi = document.getElementById(`photo_input_${itemId}`);
            if (pi) pi.value = '';
        }

        function renderItemPhotos(itemId) {
            const wrap = document.getElementById(`photos_${itemId}`);
            if (!wrap) return;
            const photos = Array.isArray(currentInspection.items[itemId].photos) ? currentInspection.items[itemId].photos : [];
            wrap.innerHTML = photos.map((src, idx) => `
                <div class="relative">
                    <img src="${src}" class="w-16 h-16 object-cover rounded-md border border-gray-200 dark:border-gray-600" />
                    <button type="button" class="absolute -top-2 -right-2 w-6 h-6 rounded-full bg-red-600 text-white text-xs" onclick="removeItemPhoto(${itemId}, ${idx})">×</button>
                </div>
            `).join('');
        }

        function removeItemPhoto(itemId, idx) {
            const photos = currentInspection.items[itemId].photos || [];
            if (photos[idx] != null) { photos.splice(idx, 1); }
            renderItemPhotos(itemId);
            saveCCTDraft();
        }

        function updateItemStatus(itemId, status) {
            currentInspection.items[itemId].status = status;
            const noteBox = document.getElementById(`note_${itemId}`);
            if (noteBox) {
                if (status === 'notok') noteBox.classList.remove('hidden'); else { noteBox.classList.add('hidden'); updateItemNote(itemId, ''); }
            }
            calculateResults();
            saveCCTDraft();
        }

        function updateItemNote(itemId, value) {
            currentInspection.items[itemId].note = value || '';
            saveCCTDraft();
        }

        function calculateResults() {
            let ok = 0, notOk = 0;
            
            currentInspection.items.forEach(item => {
                if (item.status === 'ok') ok++;
                else if (item.status === 'notok') notOk++;
            });
            
            const total = ok + notOk;
            const percentage = total > 0 ? Math.round((ok / total) * 100) : 0;
            
            currentInspection.results = { ok, notOk, percentage };
            
            // Update UI
            document.getElementById('itensOK').textContent = ok;
            document.getElementById('itensNaoOK').textContent = notOk;
            document.getElementById('percentual').textContent = percentage + '%';
            const ms = document.getElementById('mobileSummary');
            if (ms) { ms.textContent = `${ok} OK • ${notOk} NÃO OK • ${percentage}%`; }
            
            // Update maintenance level
            let nivel = '';
            if (percentage >= 90) nivel = 'Excelente';
            else if (percentage >= 80) nivel = 'Bom';
            else if (percentage >= 70) nivel = 'Regular';
            else if (percentage > 0) nivel = 'Crítico';
            else nivel = '-';
            
            document.getElementById('nivelManutencao').textContent = `Nível de Manutenção: ${nivel}`;
        }

        function clearResults() {
            currentInspection.results = { ok: 0, notOk: 0, percentage: 0 };
            document.getElementById('itensOK').textContent = '0';
            document.getElementById('itensNaoOK').textContent = '0';
            document.getElementById('percentual').textContent = '0%';
            document.getElementById('nivelManutencao').textContent = 'Nível de Manutenção: -';
        }

        function clearForm() {
            // Clear form inputs
            const frotaSel = document.getElementById('frotaSelect');
            const frotaCustom = document.getElementById('frotaCustom');
            if (frotaSel) frotaSel.value = '';
            if (frotaCustom) { frotaCustom.value = ''; frotaCustom.classList.add('hidden'); }
            const reforma = document.getElementById('reformaStatus');
            if (reforma) reforma.value = 'nao';
            const frotaLegacy = document.getElementById('frota');
            if (frotaLegacy) frotaLegacy.value = '';
            document.getElementById('mecanico').value = '';
            if (document.getElementById('observacao')) document.getElementById('observacao').value = '';
            setCurrentDate();
            
            // Clear checklist selections
            document.querySelectorAll('input[type="radio"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Reset current inspection data
            currentInspection.items.forEach(item => {
                item.status = null;
                item.note = '';
            });
            
            clearResults();
        }

        function backToSelection() {
            document.getElementById('checklistForm').classList.add('hidden');
            document.getElementById('equipmentSelection').classList.remove('hidden');
            currentEquipment = '';
            clearForm();
            toggleMobileBar(false);
        }

        function updateStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const all = viewMode === 'cct' ? inspections.slice() : (viewMode === 'irr' ? (Array.isArray(irrigInspections) ? irrigInspections.slice() : []) : getAllInspectionsCombined());
                const todayInspections = all.filter(inspection => inspection.data === today);
                
                // Count by equipment type
                const counts = {
                    caminhao: all.filter(i => i.tipo === 'caminhao').length,
                    trator: all.filter(i => i.tipo === 'trator').length,
                    colhedora: all.filter(i => i.tipo === 'colhedora').length,
                    plantadora: all.filter(i => i.tipo === 'plantadora').length,
                    distribuidora: all.filter(i => i.tipo === 'distribuidora').length,
                    reboque: all.filter(i => i.tipo === 'reboque').length,
                    transbordo: all.filter(i => i.tipo === 'transbordo').length,
                    tortao: all.filter(i => i.tipo === 'tortao').length,
                    motobombas: all.filter(i => i.tipo === 'motobombas').length,
                    hidroroll: all.filter(i => i.tipo === 'hidroroll').length
                };
                
                const totalEquipments = Object.values(counts).reduce((a, b) => a + b, 0);
                const avgLevel = all.length > 0 ? 
                    Math.round(all.reduce((sum, i) => sum + (i.results?.percentage||0), 0) / all.length) : 0;
                const todayOk = todayInspections.reduce((s, i) => s + (i.results?.ok || 0), 0);
                const todayNotOk = todayInspections.reduce((s, i) => s + (i.results?.notOk || 0), 0);
                const todayTotal = todayOk + todayNotOk;
                const taxaHoje = todayTotal > 0 ? Math.round((todayOk / todayTotal) * 100) : 0;
                
                // Update dashboard (safely)
                const safeSet = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
                
                safeSet('totalInspecoes', all.length);
                safeSet('inspecoesHoje', todayInspections.length);
                safeSet('equipamentosAtivos', totalEquipments);
                safeSet('nivelMedio', avgLevel + '%');
                safeSet('taxaHoje', taxaHoje + '%');
                safeSet('productivity', avgLevel + '%');
                
                updateRing('nivelMedioCircle', avgLevel);
                updateRing('taxaHojeCircle', taxaHoje);
                updateSparkline();
                
                // Update equipment counts (safely)
                safeSet('countCaminhoes', counts.caminhao);
                safeSet('countTratores', counts.trator);
                safeSet('countColhedoras', counts.colhedora);
                safeSet('countPlantadoras', counts.plantadora);
                safeSet('countDistribuidoras', counts.distribuidora);
                safeSet('countReboques', counts.reboque);
                safeSet('countTransbordo', counts.transbordo);
                safeSet('countTortao', counts.tortao);
                safeSet('countMotobombas', counts.motobombas);
                safeSet('countHidroroll', counts.hidroroll);
                
                // Update recent inspections
                updateRecentInspections();
                
                // Update history table
                updateHistoryTable();
                populateAnalyticsFilters();
                updateModeTypeCounts(viewMode === 'irr' ? 'irr' : 'cct');
            } catch (e) {
                console.warn('Error in updateStats:', e);
            }
        }

        function updateModeTypeCounts(mode) {
            try {
                const all = mode === 'cct' ? (Array.isArray(inspections) ? inspections.slice() : []) : (Array.isArray(irrigInspections) ? irrigInspections.slice() : []);
                if (mode === 'cct') {
                    const counts = {
                        caminhao: all.filter(i => i.tipo === 'caminhao').length,
                        trator: all.filter(i => i.tipo === 'trator').length,
                        colhedora: all.filter(i => i.tipo === 'colhedora').length,
                        plantadora: all.filter(i => i.tipo === 'plantadora').length,
                        distribuidora: all.filter(i => i.tipo === 'distribuidora').length,
                        reboque: all.filter(i => i.tipo === 'reboque').length,
                        transbordo: all.filter(i => i.tipo === 'transbordo').length,
                        tortao: all.filter(i => i.tipo === 'tortao').length
                    };
                    const ids = {
                        caminhao:'cctCountCaminhoes', trator:'cctCountTratores', colhedora:'cctCountColhedoras', plantadora:'cctCountPlantadoras', distribuidora:'cctCountDistribuidoras', reboque:'cctCountReboques', transbordo:'cctCountTransbordo', tortao:'cctCountTortao'
                    };
                    Object.keys(ids).forEach(k => { const el = document.getElementById(ids[k]); if (el) el.textContent = counts[k]; });
                } else if (mode === 'irr') {
                    const counts = {
                        motobombas: all.filter(i => i.tipo === 'motobombas').length,
                        hidroroll: all.filter(i => i.tipo === 'hidroroll').length,
                        caminhoes: all.filter(i => i.tipo === 'caminhoes').length,
                        tanques: all.filter(i => i.tipo === 'tanques').length
                    };
                    const elMoto = document.getElementById('irrCountMotobombas'); if (elMoto) elMoto.textContent = counts.motobombas;
                    const elHidro = document.getElementById('irrCountHidroroll'); if (elHidro) elHidro.textContent = counts.hidroroll;
                    const elCaminhoes = document.getElementById('irrCountCaminhoes'); if (elCaminhoes) elCaminhoes.textContent = counts.caminhoes;
                    const elTanques = document.getElementById('irrCountTanques'); if (elTanques) elTanques.textContent = counts.tanques;
                }
            } catch(_) {}
        }

        function getAllInspectionsCombined() {
            try {
                const base = Array.isArray(inspections) ? inspections.slice() : [];
                const irr = Array.isArray(irrigInspections) ? irrigInspections.slice() : [];
                return base.concat(irr.map(i => ({
                    id: i.id || null,
                    local_id: i.local_id || ('irr_' + (i.data || '') + '_' + Math.random().toString(36).slice(2)),
                    data: i.data,
                    tipo: i.tipo,
                    frota: i.frota,
                    mecanico: i.mecanico,
                    items: i.items,
                    results: i.results,
                    created_at: i.created_at || i.data
                })));
            } catch(_) { return Array.isArray(inspections) ? inspections.slice() : []; }
        }

        function updateRing(id, percentage) {
            const circle = document.getElementById(id);
            if (!circle) return;
            const r = circle.r.baseVal.value;
            const c = r * 2 * Math.PI;
            const off = c - (percentage / 100) * c;
            circle.style.strokeDasharray = `${c} ${c}`;
            circle.style.strokeDashoffset = off;
            if (percentage >= 80) circle.style.stroke = '#10B981';
            else if (percentage >= 60) circle.style.stroke = '#F59E0B';
            else circle.style.stroke = '#EF4444';
        }

        function updateRecentInspections() {
            const container = document.getElementById('inspecoesRecentes');
            const all = viewMode === 'cct' ? inspections.slice() : (viewMode === 'irr' ? (Array.isArray(irrigInspections) ? irrigInspections.slice() : []) : getAllInspectionsCombined());
            const recent = all.slice().sort((a,b) => {
                const ta = new Date(a.created_at || a.data).getTime();
                const tb = new Date(b.created_at || b.data).getTime();
                return tb - ta;
            }).slice(0, 5);
            
            if (recent.length === 0) {
                container.innerHTML = `
                    <div class="text-center text-gray-500 dark:text-gray-400 py-8">
                        <svg class="mx-auto h-12 w-12 text-gray-300 dark:text-gray-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                        </svg>
                        <p class="mt-2">Nenhuma inspeção realizada ainda</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = recent.map(inspection => {
                const statusColor = inspection.results.percentage >= 80 ? 'green' : 
                                  inspection.results.percentage >= 60 ? 'yellow' : 'red';
                
                return `
                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                        <div>
                            <p class="font-medium text-gray-900 dark:text-white">${inspection.frota}</p>
                            <p class="text-sm text-gray-500 dark:text-gray-400">${inspection.tipo.charAt(0).toUpperCase() + inspection.tipo.slice(1)} - ${formatDateBR(inspection.data)}</p>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800 dark:bg-${statusColor}-900 dark:text-${statusColor}-200">
                                ${inspection.results.percentage}%
                            </span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function updateHistoryTable(list) {
            if (!list) {
                if (viewMode === 'cct') list = inspections.slice();
                else if (viewMode === 'irr') list = (Array.isArray(irrigInspections) ? irrigInspections.slice() : []);
                else list = getAllInspectionsCombined();
            }
            const tbody = document.getElementById('historyTableBody');
            if (!list || list.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            <svg class="mx-auto h-12 w-12 text-gray-300 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/>
                            </svg>
                            Nenhuma inspeção encontrada
                        </td>
                    </tr>
                `;
                return;
            }
            
            const admin = isAdmin();
            tbody.innerHTML = list.slice().reverse().map(inspection => {
                const statusColor = inspection.results.percentage >= 80 ? 'green' : 
                                  inspection.results.percentage >= 60 ? 'yellow' : 'red';
                const statusText = inspection.results.percentage >= 80 ? 'Aprovado' : 
                                 inspection.results.percentage >= 60 ? 'Atenção' : 'Reprovado';
                const inspId = (inspection.id ?? inspection.local_id ?? '').toString();
                const isPending = !!inspection.offline || (!inspection.id && !!inspection.local_id);
                const stateBadge = isPending
                    ? `<span class=\"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200 ml-2\">Pendente</span>`
                    : `<span class=\"inline-flex items-center px-2 py-0.5 rounded-full text-[10px] font-medium bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 ml-2\">Sincronizado</span>`;
                const actions = admin ? `
                    <button onclick=\"openEditInspection('${inspId}')\" class=\"ml-3 text-yellow-600 hover:text-yellow-700 text-sm font-medium\">Editar</button>
                    <button onclick=\"deleteInspection('${inspId}')\" class=\"ml-3 text-red-600 hover:text-red-700 text-sm font-medium\">Excluir</button>
                ` : '';
                
                return `
                    <tr class="hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${formatDateBR(inspection.data)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${inspection.tipo.charAt(0).toUpperCase() + inspection.tipo.slice(1)}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${inspection.frota}</td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${inspection.mecanico}</td>
                        <td class="px-6 py-4">
                            <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-${statusColor}-100 text-${statusColor}-800 dark:bg-${statusColor}-900 dark:text-${statusColor}-200">
                                ${statusText}
                            </span>
                            ${stateBadge}
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-900 dark:text-white">${inspection.results.percentage}%</td>
                        <td class="px-6 py-4">
                            <button onclick="viewInspection('${inspId}')" class="text-primary hover:text-primary-dark text-sm font-medium">
                                Ver detalhes
                            </button>
                            ${actions}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function toggleMobileBar(show) {
            const bar = document.getElementById('mobileActionBar');
            if (!bar) return;
            if (show) bar.classList.remove('hidden'); else bar.classList.add('hidden');
        }

        function filterHistory() {
            const tipo = document.getElementById('filtroTipo').value;
            const di = document.getElementById('filtroDataInicial').value;
            const df = document.getElementById('filtroDataFinal').value;
            const diTime = di ? dateOnlyToLocalDate(di).getTime() : null;
            const dfTime = df ? dateOnlyToLocalDate(df).getTime() : null;
            const all = viewMode === 'cct' ? inspections.slice() : (viewMode === 'irr' ? (Array.isArray(irrigInspections) ? irrigInspections.slice() : []) : getAllInspectionsCombined());
            const filtered = all.filter(i => {
                const matchesTipo = !tipo || i.tipo === tipo;
                const t = dateOnlyToLocalDate(i.data).getTime();
                const afterStart = diTime == null || t >= diTime;
                const beforeEnd = dfTime == null || t <= dfTime;
                return matchesTipo && afterStart && beforeEnd;
            });
            updateHistoryTable(filtered);
        }

        function debounce(fn, delay) {
            let timer;
            return function(...args) {
                clearTimeout(timer);
                timer = setTimeout(() => fn.apply(this, args), delay);
            }
        }

        function isAdmin() {
            const u = currentUser || getCachedUser();
            return !!(u && u.email === 'gutemberggg10@gmail.com');
        }

        let accessControls = [];
        function getCachedAccessControls() { return accessControls; }
        function setCachedAccessControls(list) { accessControls = Array.isArray(list) ? list : []; }
        async function loadAccessControls() {
            let rules = [];
            if (isOnline()) {
                try {
                    const resp = await supabase.from('access_controls').select('*').order('created_at', { ascending: false });
                    const statusEl = document.getElementById('adminAccessControlsStatus');
                    if (!resp.error) {
                        rules = resp.data || [];
                        if (statusEl) statusEl.textContent = `Regras carregadas do servidor (${rules.length})`;
                    } else {
                        const msg = resp.error?.message || 'Tabela access_controls indisponível. Use o guia abaixo para criação.';
                        const det = resp.error?.details ? ` Detalhes: ${resp.error.details}` : '';
                        if (statusEl) statusEl.textContent = `${msg}.${det}`.trim();
                    }
                } catch (e) {
                    rules = [];
                    const statusEl = document.getElementById('adminAccessControlsStatus');
                    const msg = e?.message || 'Erro ao carregar regras do servidor.';
                    if (statusEl) statusEl.textContent = msg;
                }
            }
            setCachedAccessControls(rules);
            return rules;
        }
        function getAccessRuleFor(email) {
            const rules = getCachedAccessControls();
            const e = (email || '').toLowerCase();
            return rules.find(r => (r.email || '').toLowerCase() === e) || null;
        }
        function isRestrictedUser() {
            const email = ((currentUser||getCachedUser()||{}).email || '').toLowerCase();
            const rule = getAccessRuleFor(email);
            return !!(rule && ((rule.role || 'restricted') === 'restricted'));
        }
        function getAllowedSectionsFor(email) {
            const rule = getAccessRuleFor(email);
            if (rule && Array.isArray(rule.allowed_sections) && rule.allowed_sections.length) return rule.allowed_sections;
            const all = ['dashboard','historico','global-analytics','relatorios','nova-inspecao','equipamentos','inventario','calibragem','controle3p','cct_coque','irrigacao'];
            if (isAdmin()) return all.concat(['admin']);
            return all; // sem regra: usuário não-restrito (exceto admin)
        }

        function getAllowedSubsectionsFor(email, section) {
            const rule = getAccessRuleFor(email);
            const map = rule && rule.allowed_subsections ? rule.allowed_subsections : {};
            const subs = Array.isArray(map[section]) ? map[section] : [];
            return subs;
        }

        function applyAccessControls() {
            const adminBtn = document.getElementById('adminNavBtn');
            if (adminBtn) { if (isAdmin()) adminBtn.classList.remove('hidden'); else adminBtn.classList.add('hidden'); }
            const restricted = isRestrictedUser();
            const allow = getAllowedSectionsFor((currentUser||getCachedUser()||{}).email || '');
            const sections = ['dashboard','historico','global-analytics','relatorios','nova-inspecao','equipamentos','inventario','calibragem','controle3p','cct_coque','irrigacao','admin'];
            sections.forEach(id => {
                const btn = id === 'admin' ? document.getElementById('adminNavBtn') : document.querySelector(`button[onclick="showSection('${id}')"]`);
                if (!btn) return;
                // Check legacy 'analytics' permission
                const checkId = id === 'global-analytics' ? 'analytics' : id;
                if (restricted && !allow.includes(id) && !allow.includes(checkId)) { btn.classList.add('hidden'); } else { btn.classList.remove('hidden'); }
            });
            const search = document.getElementById('globalSearch');
            if (search) { if (restricted) search.parentElement.classList.add('hidden'); else search.parentElement.classList.remove('hidden'); }
        }

        function openEditInspection(id) {
            if (!isAdmin()) { showCustomAlert('Acesso restrito.'); return; }
            const matchId = String(id);
            let source = 'cct';
            let inspection = inspections.find(i => String(i.id) === matchId) || inspections.find(i => String(i.local_id) === matchId);
            if (!inspection && Array.isArray(irrigInspections)) {
                inspection = irrigInspections.find(i => String(i.id) === matchId) || irrigInspections.find(i => String(i.local_id) === matchId);
                if (inspection) source = 'irr';
            }
            if (!inspection) { showCustomAlert('Inspeção não encontrada'); return; }
            const modal = document.getElementById('editModal');
            document.getElementById('editId').value = matchId;
            const srcEl = document.getElementById('editSource'); if (srcEl) srcEl.value = source;
            document.getElementById('editData').value = inspection.data;
            document.getElementById('editFrota').value = inspection.frota;
            document.getElementById('editMecanico').value = inspection.mecanico;
            try {
                const obsItem = Array.isArray(inspection.items) ? inspection.items.find(it => String(it.name) === 'Observação') : null;
                document.getElementById('editObs').value = inspection.observacao || ((obsItem && obsItem.note) ? obsItem.note : '');
            } catch(_) { document.getElementById('editObs').value = inspection.observacao || ''; }
            if (modal) modal.classList.remove('hidden');
        }

        async function saveEditInspection() {
            if (!isAdmin()) { showCustomAlert('Acesso restrito.'); return; }
            const id = String(document.getElementById('editId').value || '');
            const source = String(document.getElementById('editSource').value || 'cct');
            const data = document.getElementById('editData').value;
            const frota = document.getElementById('editFrota').value.trim();
            const mecanico = document.getElementById('editMecanico').value.trim();
            const observacao = document.getElementById('editObs').value.trim();
            if (!id || !data || !frota || !mecanico) { showCustomAlert('Preencha todos os campos.'); return; }
            showLoading(true);
            try {
                if (source === 'irr') {
                    const idxIrr = Array.isArray(irrigInspections) ? irrigInspections.findIndex(i => String(i.id) === id || String(i.local_id) === id) : -1;
                    if (idxIrr < 0) { throw new Error('Inspeção de irrigação não encontrada'); }
                    irrigInspections[idxIrr].data = data;
                    irrigInspections[idxIrr].frota = frota;
                    irrigInspections[idxIrr].mecanico = mecanico;
                    irrigInspections[idxIrr].observacao = observacao;
                    setCachedIrrInspections(irrigInspections);
                    if (isOnline() && (currentUser || getCachedUser())) {
                        const rec = irrigInspections[idxIrr];
                        const dbInspection = { data: rec.data, tipo: rec.tipo, frota: rec.frota, mecanico: rec.mecanico, observacao: rec.observacao, items: rec.items, results: rec.results, user_id: rec.user_id, created_at: rec.created_at, local_id: rec.local_id };
                        const { error } = await supabase.from('irrig_inspections').upsert([dbInspection], { onConflict: 'local_id' });
                        if (error) { queueIrrInspection(dbInspection); }
                    }
                } else {
                    const idx = inspections.findIndex(i => String(i.id) === id || String(i.local_id) === id);
                    if (idx < 0) { throw new Error('Inspeção não encontrada'); }
                    inspections[idx].frota = frota;
                    inspections[idx].mecanico = mecanico;
                    inspections[idx].observacao = observacao;
                    setCachedInspections(inspections);
                    if (isOnline() && currentUser && currentUser.id && inspections[idx].id) {
                        const { error } = await supabase.from('inspections').update({ frota, mecanico, observacao }).eq('id', inspections[idx].id);
                        if (error) throw error;
                    }
                }
                updateStats();
                updateAnalytics();
                updateHistoryTable();
                document.getElementById('editModal').classList.add('hidden');
                showFloatingNotification('success', 'Inspeção atualizada.');
            } catch (e) {
                showCustomAlert(e.message || 'Falha ao atualizar.');
            } finally { showLoading(false); }
        }

        async function deleteInspection(id) {
            if (!isAdmin()) { showCustomAlert('Acesso restrito.'); return; }
            const matchId = String(id);
            showLoading(true);
            try {
                if (!confirm('Deseja excluir esta inspeção?')) { showLoading(false); return; }
                let removed = false;
                const idxC = inspections.findIndex(i => String(i.id) === matchId || String(i.local_id) === matchId);
                if (idxC >= 0) {
                    const record = inspections[idxC];
                    if (isOnline() && currentUser && currentUser.id && record.id) {
                        const { error } = await supabase.from('inspections').delete().eq('id', record.id);
                        if (error) throw error;
                    }
                    inspections.splice(idxC, 1);
                    setCachedInspections(inspections);
                    removed = true;
                }
                if (!removed && Array.isArray(irrigInspections)) {
                    const idxI = irrigInspections.findIndex(i => String(i.id) === matchId || String(i.local_id) === matchId);
                    if (idxI >= 0) {
                        const recordI = irrigInspections[idxI];
                        if (isOnline() && currentUser && currentUser.id && recordI.id) {
                            const { error } = await supabase.from('irrig_inspections').delete().eq('id', recordI.id);
                            if (error) throw error;
                        }
                        irrigInspections.splice(idxI, 1);
                        setCachedIrrInspections(irrigInspections);
                        removed = true;
                    }
                }
                if (!removed) { throw new Error('Inspeção não encontrada'); }
                updateStats();
                updateAnalytics();
                updateHistoryTable();
                closeModal('inspectionModal');
                showFloatingNotification('success', 'Inspeção excluída.');
            } catch (e) {
                showCustomAlert(e.message || 'Falha ao excluir.');
            } finally { showLoading(false); }
        }

        function viewInspection(id) {
            if (isRestrictedUser()) { showCustomAlert('Acesso restrito.'); return; }
            const matchId = String(id);
            const all = getAllInspectionsCombined();
            const inspection = all.find(i => String(i.id) === matchId) || all.find(i => String(i.local_id) === matchId);
            if (!inspection) return;
            currentInspectionId = matchId;
            const details = document.getElementById('inspectionDetails');
            const reformaItem = Array.isArray(inspection.items) ? inspection.items.find(it => String(it.name) === 'Status: Equipamento em reforma') : null;
            const reformaText = reformaItem ? (reformaItem.note || (reformaItem.status === 'ok' ? 'Sim' : 'Não')) : 'Não';
            const header = `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Data</p>
                        <p class="font-medium text-gray-900 dark:text-white">${formatDateBR(inspection.data)}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Equipamento</p>
                        <p class="font-medium text-gray-900 dark:text-white">${inspection.tipo}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Frota</p>
                        <p class="font-medium text-gray-900 dark:text-white">${inspection.frota}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Líder</p>
                        <p class="font-medium text-gray-900 dark:text-white">${inspection.mecanico}</p>
                    </div>
                    <div>
                        <p class="text-sm text-gray-500 dark:text-gray-400">Em reforma</p>
                        <p class="font-medium text-gray-900 dark:text-white">${reformaText}</p>
                    </div>
                </div>
            `;
            let itemsHtml = `<div class="text-center text-gray-500 dark:text-gray-400 py-6">Sem itens registrados</div>`;
            if (Array.isArray(inspection.items) && inspection.items.length > 0) {
                const groups = {};
                const sectionNotes = {};
                inspection.items.forEach(it => {
                    if (String(it.name).startsWith('Observações da seção - ')) {
                        const sec = String(it.name).replace('Observações da seção - ', '');
                        sectionNotes[sec] = it.note || '';
                    } else {
                        const sec = it.section || 'Geral';
                        if (!groups[sec]) groups[sec] = [];
                        groups[sec].push(it);
                    }
                });
                const sections = Object.keys(groups);
                itemsHtml = sections.map(sec => {
                    const rows = groups[sec].map((it, idx) => {
                        const ok = it.status === 'ok';
                        const color = ok ? 'green' : 'red';
                        const label = ok ? 'OK' : 'NÃO OK';
                        const statusHtml = `<span class=\"px-2 py-1 rounded text-xs font-medium bg-${color}-100 text-${color}-800 dark:bg-${color}-900 dark:text-${color}-200\">${label}</span>`;
                        const noteHtml = it.note ? `<div class=\"mt-1 text-xs text-gray-600 dark:text-gray-300\">Obs: ${it.note}</div>` : '';
                        const photos = Array.isArray(it.photos) ? it.photos : [];
                        const photosHtml = photos.length ? `<div class=\"mt-2 flex gap-2 flex-wrap\">${photos.map(p => `<img src='${p}' class='w-16 h-16 object-cover rounded-md border border-gray-200 dark:border-gray-600'/>`).join('')}</div>` : '';
                        return `
                            <div class=\"p-3 bg-gray-50 dark:bg-gray-700 rounded-md\">
                                <div class=\"flex items-center justify-between\">
                                    <span class=\"text-gray-900 dark:text-white\">${it.name}</span>
                                    ${statusHtml}
                                </div>
                                ${noteHtml}
                                ${photosHtml}
                            </div>
                        `;
                    }).join('');
                    const secNote = sectionNotes[sec] ? `<div class=\"mt-2 text-xs text-gray-700 dark:text-gray-200\"><span class=\"font-medium\">Observações da seção:</span> ${sectionNotes[sec]}</div>` : '';
                    return `
                        <div class=\"mb-4\">
                            <div class=\"px-4 py-2 bg-green-100 dark:bg-green-900/30 border border-green-200 dark:border-green-800 rounded-md mb-2\">
                                <h5 class=\"text-sm font-semibold text-green-800 dark:text-green-200\">${sec}</h5>
                            </div>
                            <div class=\"space-y-2\">${rows}</div>
                            ${secNote}
                        </div>
                    `;
                }).join('');
            }
            const obsBlock = inspection.observacao ? `
                <div class="mt-4">
                    <p class="text-sm text-gray-500 dark:text-gray-400 mb-1">Observação</p>
                    <p class="text-sm text-gray-900 dark:text-white">${inspection.observacao}</p>
                </div>
            ` : '';
            const summary = `
                <div class="flex items-center justify-between">
                    <div class="text-sm text-gray-500 dark:text-gray-400">Resultado</div>
                    <div class="text-sm text-gray-900 dark:text-white">${inspection.results.ok} OK, ${inspection.results.notOk} NÃO OK (${inspection.results.percentage}%)</div>
                </div>
            `;
            details.innerHTML = header + `<div class="space-y-2">${itemsHtml}</div>` + obsBlock + summary;
            const btn = document.getElementById('printInspectionBtn');
            if (btn) { btn.disabled = false; }
            const adminBar = document.getElementById('inspectionAdminBar');
            if (adminBar) {
                if (isAdmin()) { adminBar.classList.remove('hidden'); } else { adminBar.classList.add('hidden'); }
            }
            showModal('inspectionModal');
        }

        function printInspection(id) {
            if (isRestrictedUser()) { showCustomAlert('Acesso restrito.'); return; }
            const matchId = String(id);
            const inspection = inspections.find(i => String(i.id) === matchId || String(i.local_id) === matchId);
            if (!inspection) { showCustomAlert('Inspeção não encontrada'); return; }
            const sectionNotes = {};
            const normalItems = Array.isArray(inspection.items) ? inspection.items.filter(it => {
                if (String(it.name).startsWith('Observações da seção - ')) {
                    const sec = String(it.name).replace('Observações da seção - ', '');
                    sectionNotes[sec] = it.note || '';
                    return false;
                }
                return true;
            }) : [];
            const rows = normalItems.map((it, idx) => `
                <tr>
                    <td>${idx+1}</td>
                    <td>${it.section || ''}</td>
                    <td>${it.name}</td>
                    <td>${it.status === 'ok' ? 'OK' : (it.status === 'notok' ? 'NÃO OK' : '')}</td>
                    <td>${it.note || ''}</td>
                </tr>
            `).join('');
            const groups = {};
            const order = [];
            normalItems.forEach((it) => {
                const s = it.section || 'Geral';
                if (!groups[s]) { groups[s] = []; order.push(s); }
                groups[s].push(it);
            });
            const groupedHtml = order.map((secName) => {
                const items = groups[secName] || [];
                const secRows = items.map((it, iidx) => `
                    <tr>
                        <td>${iidx+1}</td>
                        <td>${it.name}</td>
                        <td>${it.status === 'ok' ? 'OK' : (it.status === 'notok' ? 'NÃO OK' : '')}</td>
                        <td>${it.note || ''}</td>
                    </tr>
                `).join('');
                const secNote = sectionNotes[secName] ? `<div style="font-size:11px;color:#374151;margin-top:6px;"><strong>Observações:</strong> ${sectionNotes[secName]}</div>` : '';
                return `
                    <div class="sec">
                        <h4>${secName}</h4>
                        <table>
                            <thead><tr><th>#</th><th>Item</th><th>Status</th><th>Observação</th></tr></thead>
                            <tbody>${secRows}</tbody>
                        </table>
                        ${secNote}
                    </div>
                `;
            }).join('');
            const photoItems = normalItems.filter(it => Array.isArray(it.photos) && it.photos.length > 0);
            const photosHtml = photoItems.length ? `
                <div class="sections">
                    <h3 style="font-size:13px;margin:14px 0 8px;">Fotos dos Itens</h3>
                    ${photoItems.map((it) => `
                        <div class="sec">
                            <h4>${it.section || ''} • ${it.name}</h4>
                            <div class="photo-grid">
                                ${it.photos.map(p => `<img src='${p}' />`).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '';
            const doc = `
                <html><head>
                    <meta name="viewport" content="width=device-width, initial-scale=1" />
                    <meta charset="utf-8" />
                    <title>Checklist</title>
                    <style>
                        @page { size: A4 portrait; margin: 12mm; }
                        * { box-sizing: border-box; }
                        body { font-family: Inter, Arial, sans-serif; padding: 0; color: #111827; }
                        .container { max-width: 940px; margin: 0 auto; padding: 24px; }
                        .header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 16px; }
                        .brand { display:flex; align-items:center; gap:10px; }
                        .logo { width:28px; height:28px; border-radius:8px; background:#5D5CDE; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
                        .title { font-size: 18px; font-weight: 700; }
                        .subtitle { font-size: 12px; color:#6B7280; }
                        .info { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; margin: 12px 0; }
                        .info .i { border:1px solid #e5e7eb; border-radius:8px; padding:8px; }
                        .info .i h5 { margin:0; font-size:11px; color:#6B7280; }
                        .info .i p { margin:4px 0 0; font-size:13px; font-weight:600; }
                        .badges { display:flex; gap:8px; margin: 8px 0 12px; }
                        .badge { display:inline-block; border-radius:6px; padding:4px 8px; font-size:11px; border:1px solid #e5e7eb; }
                        .ok { background:#ECFDF5; color:#065F46; border-color:#D1FAE5; }
                        .nok { background:#FEF2F2; color:#7F1D1D; border-color:#FECACA; }
                        .table-wrap { margin-top: 8px; }
                        table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                        thead th { background: #f3f4f6; text-align: left; font-size: 11px; color:#374151; border-bottom:1px solid #e5e7eb; }
                        th, td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 11px; word-break: break-word; }
                        tbody tr:nth-child(odd) { background: #fafafa; }
                        .sections { margin-top: 14px; }
                        .sec { margin-top: 10px; page-break-inside: avoid; }
                        .sec h4 { font-size: 12px; margin: 0 0 6px; color:#374151; }
                        .photo-grid { display:flex; flex-wrap:wrap; gap:8px; }
                        .photo-grid img { width: 120px; height: 90px; object-fit: cover; border:1px solid #e5e7eb; border-radius:6px; }
                        .footer { margin-top: 18px; font-size: 11px; color:#6B7280; text-align:right; }
                        @media screen { body { background:#f3f4f6; } .container { background:#fff; padding:24px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); } }
                    </style>
                </head><body onload="window.print()">
                    <div class="container">
                        <div class="header">
                            <div class="brand"><div class="logo">GG</div><div><div class="title">GGOMES-LOG • Checklist</div><div class="subtitle">${formatDateBR(inspection.data)}</div></div></div>
                            <div class="subtitle">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
                        </div>
                        <div class="info">
                            <div class="i"><h5>Equipamento</h5><p>${inspection.tipo}</p></div>
                            <div class="i"><h5>Frota</h5><p>${inspection.frota}</p></div>
                            <div class="i"><h5>Líder</h5><p>${inspection.mecanico}</p></div>
                            <div class="i"><h5>Percentual</h5><p>${inspection.results.percentage}%</p></div>
                        </div>
                        <div class="badges">
                            <span class="badge ok">${inspection.results.ok} OK</span>
                            <span class="badge nok">${inspection.results.notOk} NÃO OK</span>
                        </div>
                        ${inspection.observacao ? `<div style="font-size:12px;color:#374151;margin-bottom:8px;"><strong>Observação:</strong> ${inspection.observacao}</div>` : ''}
                        <div class="sections">
                            ${groupedHtml}
                        </div>
                        ${photosHtml}
                        ${Object.keys(sectionNotes).length > 0 ? `
                        <div class="sections">
                            <h3 style="font-size:13px;margin:10px 0;">Observações por Seção</h3>
                            <table>
                                <thead><tr><th>Seção</th><th>Observações</th></tr></thead>
                                <tbody>
                                    ${Object.entries(sectionNotes).map(([sec, note]) => `<tr><td>${sec}</td><td>${note}</td></tr>`).join('')}
                                </tbody>
                            </table>
                        </div>
                        ` : ''}
                        <div class="footer">Sistema de Checklist • ${new Date().getFullYear()}</div>
                    </div>
                </body></html>
            `;
            const w = window.open('', '_blank');
            if (w) { w.document.write(doc); w.document.close(); }
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        function showCustomAlert(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 fade-in">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-blue-100 dark:bg-blue-900 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-blue-600 dark:text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Atenção</h3>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 mb-4 whitespace-pre-line">${message}</p>
                    <button onclick="this.closest('.fixed').remove()" class="w-full px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200">
                        OK
                    </button>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function showUpdatePrompt(message) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg max-w-sm w-full mx-4 fade-in">
                    <div class="flex items-center space-x-3 mb-4">
                        <div class="w-10 h-10 bg-yellow-100 dark:bg-yellow-900 rounded-full flex items-center justify-center">
                            <svg class="w-6 h-6 text-yellow-600 dark:text-yellow-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                            </svg>
                        </div>
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Atualização disponível</h3>
                    </div>
                    <p class="text-gray-600 dark:text-gray-400 mb-4 whitespace-pre-line">${message}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="confirmUpdateNow" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark transition-colors duration-200">Atualizar agora</button>
                        <button id="dismissUpdate" class="px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300">Depois</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const confirmBtn = modal.querySelector('#confirmUpdateNow');
            const dismissBtn = modal.querySelector('#dismissUpdate');
            if (confirmBtn && !confirmBtn._bound) { confirmBtn.addEventListener('click', function(){ try { location.reload(); } catch(_) {} }); confirmBtn._bound = true; }
            if (dismissBtn && !dismissBtn._bound) { dismissBtn.addEventListener('click', function(){ const m = this.closest('.fixed'); if (m) m.remove(); }); dismissBtn._bound = true; }
        }

        // Advanced Features
        
        // Search functionality
        document.getElementById('globalSearch').addEventListener('input', function(e) {
            const query = e.target.value.toLowerCase();
            if (query.length < 2) return;
            
            const results = inspections.filter(inspection => 
                inspection.frota.toLowerCase().includes(query) ||
                inspection.mecanico.toLowerCase().includes(query) ||
                inspection.tipo.toLowerCase().includes(query)
            );
            
            showSearchResults(results);
        });

        function updateDashboardStats() {
            try {
                // 1. Frota Ativa (Equipment Counts)
                const allInspections = getAllInspectionsCombined();
                const uniqueColhedoras = new Set();
                const uniquePlantadoras = new Set();
                const uniqueDistribuidoras = new Set();
                const uniqueReboques = new Set();
                const uniqueTransbordos = new Set();

                allInspections.forEach(i => {
                    if (i.tipo === 'colhedora' && i.frota) uniqueColhedoras.add(i.frota);
                    if (i.tipo === 'plantadora' && i.frota) uniquePlantadoras.add(i.frota);
                    if (i.tipo === 'distribuidora' && i.frota) uniqueDistribuidoras.add(i.frota);
                    if (i.tipo === 'reboque' && i.frota) uniqueReboques.add(i.frota);
                    if (i.tipo === 'transbordo' && i.frota) uniqueTransbordos.add(i.frota);
                });

                const countCol = document.getElementById('countColhedoras');
                const countPlant = document.getElementById('countPlantadoras');
                const countDist = document.getElementById('countDistribuidoras');
                const countReb = document.getElementById('countReboques');
                const countTrans = document.getElementById('countTransbordo');

                if (countCol) countCol.textContent = uniqueColhedoras.size;
                if (countPlant) countPlant.textContent = uniquePlantadoras.size;
                if (countDist) countDist.textContent = uniqueDistribuidoras.size;
                if (countReb) countReb.textContent = uniqueReboques.size;
                if (countTrans) countTrans.textContent = uniqueTransbordos.size;

                // 2. Recent Inspections Table
                const tbody = document.getElementById('recentInspectionsTableBody');
                if (tbody) {
                    const recent = allInspections.sort((a, b) => new Date(b.data) - new Date(a.data)).slice(0, 5);
                    tbody.innerHTML = recent.map(i => `
                        <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">${i.frota}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${i.tipo}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 dark:text-gray-400">${formatDateBR(i.data)}</td>
                            <td class="px-6 py-4 whitespace-nowrap">
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${i.results.percentage === 100 ? 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200' : 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-200'}">
                                    ${i.results.percentage}%
                                </span>
                            </td>
                        </tr>
                    `).join('');
                }

                // 3. Critical Alerts
                const alertsContainer = document.getElementById('criticalAlerts');
                if (alertsContainer) {
                    const critical = allInspections.filter(i => i.results.notOk > 0).slice(0, 5);
                    if (critical.length === 0) {
                        alertsContainer.innerHTML = `
                            <div class="text-center text-gray-500 dark:text-gray-400 py-4">
                                <p>Nenhum alerta crítico no momento</p>
                            </div>
                        `;
                    } else {
                        alertsContainer.innerHTML = critical.map(i => `
                            <div class="flex items-start space-x-3 p-3 bg-red-50 dark:bg-red-900/10 rounded-lg border border-red-100 dark:border-red-900/30 cursor-pointer hover:bg-red-100 dark:hover:bg-red-900/20 transition-colors" onclick="printInspection('${i.id}')">
                                <div class="flex-shrink-0">
                                    <svg class="w-5 h-5 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77.833.192 2.5 1.732 2.5z"/>
                                    </svg>
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">
                                        ${i.tipo} - Frota ${i.frota}
                                    </p>
                                    <p class="text-xs text-red-600 dark:text-red-400 mt-0.5">
                                        ${i.results.notOk} itens reprovados
                                    </p>
                                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">
                                        ${formatDateBR(i.data)}
                                    </p>
                                </div>
                            </div>
                        `).join('');
                    }
                }
                
                // 4. Initialize Charts (using existing logic but for dashboard)
                if (document.getElementById('dashboard').classList.contains('hidden') === false) {
                    updateDashboardCharts();
                }

                // 5. Update Top Stats Cards (Global)
                const today = new Date().toISOString().split('T')[0];
                const todayInspections = allInspections.filter(inspection => inspection.data === today);
                
                // Count active equipments (based on inspections in database, simplistic approach or could use unique)
                // Using total inspections might be misleading for "Equipamentos Ativos", let's use unique equipment count
                const allUniqueFrota = new Set(allInspections.filter(i => i.frota).map(i => i.tipo + '-' + i.frota));

                const avgLevel = allInspections.length > 0 ? 
                    Math.round(allInspections.reduce((sum, i) => sum + (i.results?.percentage||0), 0) / allInspections.length) : 0;
                
                const todayOk = todayInspections.reduce((s, i) => s + (i.results?.ok || 0), 0);
                const todayNotOk = todayInspections.reduce((s, i) => s + (i.results?.notOk || 0), 0);
                const todayTotal = todayOk + todayNotOk;
                const taxaHoje = todayTotal > 0 ? Math.round((todayOk / todayTotal) * 100) : 0;

                const elTotal = document.getElementById('totalInspecoes');
                const elHoje = document.getElementById('inspecoesHoje');
                const elAtivos = document.getElementById('equipamentosAtivos');
                const elNivel = document.getElementById('nivelMedio');
                const elTaxa = document.getElementById('taxaHoje');

                if (elTotal) elTotal.textContent = allInspections.length;
                if (elHoje) elHoje.textContent = todayInspections.length;
                if (elAtivos) elAtivos.textContent = allUniqueFrota.size;
                if (elNivel) elNivel.textContent = avgLevel + '%';
                if (elTaxa) elTaxa.textContent = taxaHoje + '%';

                updateRing('nivelMedioCircle', avgLevel);
                updateRing('taxaHojeCircle', taxaHoje);

            } catch (e) {
                console.error('Error updating dashboard stats:', e);
            }
        }


        // Notification system
        let notifications = [];

        function showNotificationCenter() {
            const center = document.getElementById('notificationCenter');
            center.classList.toggle('hidden');
            
            if (!center.classList.contains('hidden')) {
                updateNotificationList();
                markAllNotificationsRead();
            }
        }

        function updateNotificationList() {
            const container = document.getElementById('notificationList');
            
            if (notifications.length === 0) {
                container.innerHTML = `
                    <div class="p-4 text-center text-gray-500 dark:text-gray-400">
                        <p>Nenhuma notificação</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = notifications.map(notif => {
                const iconColors = {
                    warning: 'text-yellow-500',
                    info: 'text-blue-500',
                    error: 'text-red-500',
                    success: 'text-green-500'
                };
                
                const bgColors = {
                    warning: 'bg-yellow-50 dark:bg-yellow-900/20',
                    info: 'bg-blue-50 dark:bg-blue-900/20',
                    error: 'bg-red-50 dark:bg-red-900/20',
                    success: 'bg-green-50 dark:bg-green-900/20'
                };
                
                return `
                    <div class="p-3 m-2 rounded-lg ${bgColors[notif.type]} border border-gray-200 dark:border-gray-600">
                        <div class="flex items-start space-x-3">
                            <div class="flex-shrink-0">
                                <svg class="w-5 h-5 ${iconColors[notif.type]}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L3.268 16.5c-.77.833.192 2.5 1.732 2.5z"/>
                                </svg>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-sm font-medium text-gray-900 dark:text-white">${notif.title}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">${notif.message}</p>
                                <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${formatNotificationTime(notif.created_at || new Date().toISOString())}</p>
                                ${notif.link ? `<button onclick="openNotificationLink('${notif.id}')" class="mt-2 text-sm text-primary hover:text-primary-dark">Abrir no histórico</button>` : ''}
                            </div>
                            <button onclick="removeNotification('${notif.id}')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearAllNotifications() {
            notifications = [];
            setCachedNotifications([]);
            updateNotificationList();
            updateNotificationBadge();
        }

        function showFloatingNotification(type, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notificationId = 'notif-' + Date.now();
            
            const notification = document.createElement('div');
            notification.id = notificationId;
            notification.className = 'notification-slide bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg shadow-lg p-4 max-w-sm';
            
            const typeColors = {
                success: 'border-l-4 border-l-green-500',
                error: 'border-l-4 border-l-red-500',
                warning: 'border-l-4 border-l-yellow-500',
                info: 'border-l-4 border-l-blue-500'
            };
            
            notification.className += ' ' + typeColors[type];
            
            notification.innerHTML = `
                <div class="flex items-start">
                    <div class="flex-1">
                        <p class="text-sm text-gray-900 dark:text-white">${message}</p>
                    </div>
                    <button onclick="document.getElementById('${notificationId}').remove()" class="ml-3 text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (document.getElementById(notificationId)) {
                    notification.remove();
                }
            }, duration);
        }

        function pushNotification(type, title, message, link) {
            const item = { id: Date.now().toString(), type, title, message, created_at: new Date().toISOString(), read: false, link: link || null };
            notifications.unshift(item);
            setCachedNotifications(notifications);
            updateNotificationBadge();
            const center = document.getElementById('notificationCenter');
            if (center && !center.classList.contains('hidden')) updateNotificationList();
        }

        function openNotificationLink(id) {
            try {
                const notif = notifications.find(n => n.id === id);
                if (!notif || !notif.link) return;
                const l = notif.link;
                if (l.modulo === 'cct') {
                    showSection('cct_coque');
                    showCCTSubsection('historico');
                } else if (l.modulo === 'irr') {
                    showSection('irrigacao');
                    showIrrSubsection('historico');
                }
                setTimeout(() => {
                    const tbody = document.getElementById('historyTableBody');
                    if (!tbody) return;
                    const rows = Array.from(tbody.querySelectorAll('tr'));
                    const target = rows.find(tr => {
                        const tds = tr.querySelectorAll('td');
                        if (!tds || tds.length < 4) return false;
                        const tipoCell = (tds[1].textContent||'').toLowerCase();
                        const frotaCell = (tds[2].textContent||'').toLowerCase();
                        const mecCell = (tds[3].textContent||'').toLowerCase();
                        const tipoMatch = !l.tipo || tipoCell.includes((l.tipo||'').toLowerCase());
                        const frotaMatch = !l.frota || frotaCell.includes((l.frota||'').toLowerCase());
                        const mecMatch = !l.mecanico || mecCell.includes((l.mecanico||'').toLowerCase());
                        return tipoMatch && frotaMatch && mecMatch;
                    });
                    if (target) { target.scrollIntoView({ behavior:'smooth', block:'center' }); target.classList.add('bg-yellow-50'); setTimeout(()=>{ target.classList.remove('bg-yellow-50'); }, 2500); }
                }, 250);
            } catch(_) {}
        }

        function markAllNotificationsRead() {
            notifications = notifications.map(n => ({ ...n, read: true }));
            setCachedNotifications(notifications);
            updateNotificationBadge();
        }

        function removeNotification(id) {
            notifications = notifications.filter(n => n.id !== id);
            setCachedNotifications(notifications);
            updateNotificationList();
            updateNotificationBadge();
        }

        function updateNotificationBadge() {
            const badge = document.getElementById('notificationBadge');
            if (!badge) return;
            const unread = notifications.filter(n => !n.read).length;
            if (unread > 0) {
                badge.textContent = String(unread);
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
            }
        }

        function formatNotificationTime(iso) {
            if (!iso) return '';
            const d = new Date(iso);
            const diff = Math.floor((Date.now() - d.getTime()) / 60000);
            if (diff < 1) return 'agora';
            if (diff < 60) return `${diff} min atrás`;
            const h = Math.floor(diff / 60);
            if (h < 24) return `${h} h atrás`;
            const days = Math.floor(h / 24);
            return `${days} d atrás`;
        }

        function mapTypeTitle(type) {
            if (type === 'success') return 'Sucesso';
            if (type === 'error') return 'Erro';
            if (type === 'warning') return 'Aviso';
            return 'Informação';
        }

        // Charts initialization
        let performanceChart = null;
        let equipmentChart = null;
        let dashboardWeeklyChart = null;
        let dashboardStatusChart = null;
        let sparklineChart = null;
        let chartLoaderPromise = null;

        function ensureChartJs() {
            if (typeof Chart !== 'undefined') return Promise.resolve();
            if (chartLoaderPromise) return chartLoaderPromise;
            chartLoaderPromise = new Promise((resolve, reject) => {
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js';
                s.onload = () => resolve();
                s.onerror = () => {
                    const s2 = document.createElement('script');
                    s2.src = 'https://unpkg.com/chart.js@4.4.0/dist/chart.umd.min.js';
                    s2.onload = () => resolve();
                    s2.onerror = () => reject(new Error('chartjs-load-failed'));
                    document.head.appendChild(s2);
                };
                document.head.appendChild(s);
            });
            return chartLoaderPromise;
        }

        function updateDashboardCharts() {
            ensureChartJs().then(() => {
                const sel = document.getElementById('dashboardChartPeriod');
                const days = sel ? parseInt(sel.value, 10) : 7;
                
                // Bind change event if not bound
                if (sel && !sel._bound) {
                    sel.addEventListener('change', () => updateDashboardCharts());
                    sel._bound = true;
                }

                const end = new Date();
                const start = new Date();
                start.setDate(end.getDate() - days + 1);

                const all = getAllInspectionsCombined();
                const filtered = all.filter(i => {
                    const d = dateOnlyToLocalDate(i.data);
                    return d >= start && d <= end;
                });

                // 1. Weekly Volume Chart (Inspections per day)
                const byDay = {};
                // Initialize all days in range with 0
                for(let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
                     const k = d.toISOString().split('T')[0];
                     byDay[k] = 0;
                }
                filtered.forEach(i => {
                    const k = String(i.data);
                    if (byDay[k] !== undefined) byDay[k]++;
                });

                const labels = Object.keys(byDay).sort().map(d => formatDateBR(d).split('/').slice(0,2).join('/'));
                const data = Object.keys(byDay).sort().map(d => byDay[d]);

                const weeklyCtx = document.getElementById('weeklyInspectionsChart');
                if (weeklyCtx) {
                    if (!dashboardWeeklyChart) {
                        dashboardWeeklyChart = new Chart(weeklyCtx, {
                            type: 'bar',
                            data: {
                                labels,
                                datasets: [{
                                    label: 'Inspeções',
                                    data,
                                    backgroundColor: '#3B82F6',
                                    borderRadius: 4
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { display: false } },
                                scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
                            }
                        });
                    } else {
                        dashboardWeeklyChart.data.labels = labels;
                        dashboardWeeklyChart.data.datasets[0].data = data;
                        dashboardWeeklyChart.update();
                    }
                }

                // 2. Status Chart
                const statusCounts = { ok: 0, warning: 0, critical: 0 };
                filtered.forEach(i => {
                    const p = i.results?.percentage || 0;
                    if (p >= 80) statusCounts.ok++;
                    else if (p >= 60) statusCounts.warning++;
                    else statusCounts.critical++;
                });

                const statusCtx = document.getElementById('inspectionStatusChart');
                if (statusCtx) {
                    if (!dashboardStatusChart) {
                        dashboardStatusChart = new Chart(statusCtx, {
                            type: 'doughnut',
                            data: {
                                labels: ['Bom (≥80%)', 'Atenção (60-79%)', 'Crítico (<60%)'],
                                datasets: [{
                                    data: [statusCounts.ok, statusCounts.warning, statusCounts.critical],
                                    backgroundColor: ['#10B981', '#F59E0B', '#EF4444'],
                                    borderWidth: 0
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: { legend: { position: 'bottom' } },
                                cutout: '70%'
                            }
                        });
                    } else {
                        dashboardStatusChart.data.datasets[0].data = [statusCounts.ok, statusCounts.warning, statusCounts.critical];
                        dashboardStatusChart.update();
                    }
                }

            }).catch(e => console.warn('Dashboard charts failed:', e));
        }

        function initializeCharts() {
            ensureChartJs().then(() => {
            const sel = viewMode === 'cct' ? document.getElementById('chartPeriodCCT') : document.getElementById('chartPeriod');
            populateAnalyticsFilters();
            const days = sel ? parseInt(sel.value, 10) : 30;
            buildCharts(days);
            updateAnalyticsSummary(days);
            if (sel && !sel._bound) {
                sel.addEventListener('change', () => {
                    const d = parseInt(sel.value, 10);
                    buildCharts(d);
                    updateAnalyticsSummary(d);
                });
                sel._bound = true;
            }
            const eqSel = viewMode === 'cct' ? document.getElementById('equipmentFilterCCT') : document.getElementById('equipmentFilter');
            const ldSel = viewMode === 'cct' ? document.getElementById('leaderFilterCCT') : document.getElementById('leaderFilter');
            const clearBtn = viewMode === 'cct' ? document.getElementById('clearAnalyticsFiltersCCT') : document.getElementById('clearAnalyticsFilters');
            [eqSel, ldSel].forEach(el => {
                if (el && !el._bound) {
                    el.addEventListener('change', () => {
                        const d = sel ? parseInt(sel.value, 10) : 30;
                        buildCharts(d);
                        updateAnalyticsSummary(d);
                        updateAnalytics();
                    });
                    el._bound = true;
                }
            });
            if (clearBtn && !clearBtn._bound) {
                clearBtn.addEventListener('click', () => {
                    if (eqSel) eqSel.value = 'all';
                    if (ldSel) ldSel.value = 'all';
                    const d = sel ? parseInt(sel.value, 10) : 30;
                    buildCharts(d);
                    updateAnalyticsSummary(d);
                    updateAnalytics();
                });
                clearBtn._bound = true;
            }
            }).catch(() => {
                showFloatingNotification('warning', 'Gráficos indisponíveis. Verifique sua conexão.');
            });
        }

        function buildCharts(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - days + 1);
            const eqSel = viewMode === 'cct' ? document.getElementById('equipmentFilterCCT') : document.getElementById('equipmentFilter');
            const ldSel = viewMode === 'cct' ? document.getElementById('leaderFilterCCT') : document.getElementById('leaderFilter');
            const eqFilter = eqSel ? eqSel.value : 'all';
            const ldFilter = ldSel ? ldSel.value : 'all';
            const all = viewMode === 'cct' ? inspections.slice() : (viewMode === 'irr' ? (Array.isArray(irrigInspections) ? irrigInspections.slice() : []) : getAllInspectionsCombined());
            const filtered = all.filter(i => {
                const d = dateOnlyToLocalDate(i.data);
                const inRange = d >= start && d <= end;
                const byEq = eqFilter === 'all' ? true : i.tipo === eqFilter;
                const byLd = ldFilter === 'all' ? true : (i.mecanico || '') === ldFilter;
                return inRange && byEq && byLd;
            });
            const byDay = {};
            filtered.forEach(i => {
                const k = String(i.data);
                if (!byDay[k]) byDay[k] = [];
                byDay[k].push(i.results?.percentage || 0);
            });
            const labels = Object.keys(byDay).sort((a,b)=>dateOnlyToLocalDate(a)-dateOnlyToLocalDate(b)).map(d=>formatDateBR(d));
            const data = Object.keys(byDay).sort((a,b)=>dateOnlyToLocalDate(a)-dateOnlyToLocalDate(b)).map(d=>{
                const arr = byDay[d];
                const avg = arr.length ? Math.round(arr.reduce((s,v)=>s+v,0)/arr.length) : 0;
                return avg;
            });
            const perfCtx = document.getElementById('performanceChart');
            if (perfCtx && typeof Chart !== 'undefined') {
                if (!performanceChart) {
                    performanceChart = new Chart(perfCtx, {
                        type: 'line',
                        data: { labels, datasets: [{ label: 'Taxa de Aprovação (%)', data, borderColor: '#5D5CDE', backgroundColor: 'rgba(93,92,222,0.1)', fill: true, tension: 0.4 }] },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, max: 100 } }, plugins: { legend: { display: false } } }
                    });
                } else {
                    performanceChart.data.labels = labels;
                    performanceChart.data.datasets[0].data = data;
                    performanceChart.update();
                }
            }
            const equipCtx = document.getElementById('equipmentChart');
            if (equipCtx && typeof Chart !== 'undefined') {
                const isCCT = viewMode === 'cct';
                const isIRR = viewMode === 'irr';
                const mapLabels = isCCT
                    ? { caminhao: 'Caminhões', trator: 'Tratores', colhedora: 'Colhedoras', reboque: 'Reboques', plantadora: 'Plantadoras', distribuidora: 'Distribuidoras', transbordo: 'Transbordos', tortao: 'Tortão' }
                    : isIRR
                        ? { motobombas: 'MotoBombas', hidroroll: 'Hidro Roll' }
                        : { caminhao: 'Caminhões', trator: 'Tratores', colhedora: 'Colhedoras', reboque: 'Reboques', plantadora: 'Plantadoras', distribuidora: 'Distribuidoras', transbordo: 'Transbordos', motobombas: 'MotoBombas', hidroroll: 'Hidro Roll', tortao: 'Tortão' };
                const order = isCCT
                    ? ['caminhao','trator','colhedora','reboque','plantadora','distribuidora','transbordo','tortao']
                    : isIRR
                        ? ['motobombas','hidroroll']
                        : ['caminhao','trator','colhedora','reboque','plantadora','distribuidora','transbordo','motobombas','hidroroll','tortao'];
                const counts = order.reduce((acc,k)=>{ acc[k]=0; return acc; },{});
                filtered.forEach(i => { if (counts[i.tipo] !== undefined) counts[i.tipo]++; });
                const labelsEquip = order.map(k => mapLabels[k]);
                const dataEquip = order.map(k => counts[k]);
                const colors = ['#3B82F6','#10B981','#8B5CF6','#F59E0B','#06B6D4','#FB923C','#F97316','#F472B6','#0EA5E9','#22C55E','#0EA5E9'];
                if (!equipmentChart) {
                    equipmentChart = new Chart(equipCtx, {
                        type: 'doughnut',
                        data: { labels: labelsEquip, datasets: [{ data: dataEquip, backgroundColor: colors }] },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, onClick: (evt, elements) => {
                            const eqSel = isCCT ? document.getElementById('equipmentFilterCCT') : document.getElementById('equipmentFilter');
                            if (!elements || elements.length === 0 || !eqSel) return;
                            const idx = elements[0].index;
                            const order = isCCT ? ['caminhao','trator','colhedora','reboque','plantadora','distribuidora','transbordo','tortao'] : (isIRR ? ['motobombas','hidroroll'] : ['caminhao','trator','colhedora','reboque','plantadora','distribuidora','transbordo','motobombas','hidroroll','tortao']);
                            eqSel.value = order[idx] || 'all';
                            const dSel = isCCT ? document.getElementById('chartPeriodCCT') : document.getElementById('chartPeriod');
                            const d = dSel ? parseInt(dSel.value, 10) : 30;
                            buildCharts(d);
                            updateAnalyticsSummary(d);
                            updateAnalytics();
                        } }
                    });
                } else {
                    equipmentChart.data.labels = labelsEquip;
                    equipmentChart.data.datasets[0].data = dataEquip;
                    equipmentChart.update();
                }
            }
        }

        function updateAnalyticsSummary(days) {
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - days + 1);
            const eqSel = viewMode === 'cct' ? document.getElementById('equipmentFilterCCT') : document.getElementById('equipmentFilter');
            const ldSel = viewMode === 'cct' ? document.getElementById('leaderFilterCCT') : document.getElementById('leaderFilter');
            const eqFilter = eqSel ? eqSel.value : 'all';
            const ldFilter = ldSel ? ldSel.value : 'all';
            const all = viewMode === 'cct' ? inspections.slice() : (viewMode === 'irr' ? (Array.isArray(irrigInspections) ? irrigInspections.slice() : []) : getAllInspectionsCombined());
            const filtered = all.filter(i => {
                const d = new Date(i.created_at || i.data);
                const inRange = d >= start && d <= end;
                const byEq = eqFilter === 'all' ? true : i.tipo === eqFilter;
                const byLd = ldFilter === 'all' ? true : (i.mecanico || '') === ldFilter;
                return inRange && byEq && byLd;
            });
            const approvalEl = document.getElementById('approvalRate');
            const avgTimeEl = document.getElementById('avgTime');
            const productivityEl = document.getElementById('productivity');
            if (filtered.length === 0) {
                if (approvalEl) approvalEl.textContent = '0%';
                if (avgTimeEl) avgTimeEl.textContent = '—';
                if (productivityEl) productivityEl.textContent = '0%';
                return;
            }
            const avgApproval = Math.round(filtered.reduce((s, i) => s + (i.results?.percentage || 0), 0) / filtered.length);
            if (approvalEl) approvalEl.textContent = `${avgApproval}%`;
            const times = filtered
                .map(i => new Date(i.created_at || i.data).getTime())
                .sort((a, b) => a - b);
            const intervals = [];
            for (let idx = 1; idx < times.length; idx++) {
                intervals.push(times[idx] - times[idx - 1]);
            }
            const avgMs = intervals.length > 0 ? Math.round(intervals.reduce((s, v) => s + v, 0) / intervals.length) : 0;
            let avgLabel = '—';
            if (avgMs > 0) {
                const mins = Math.round(avgMs / 60000);
                if (mins < 120) avgLabel = `${mins}min`;
                else {
                    const hours = Math.round(mins / 60);
                    if (hours < 48) avgLabel = `${hours}h`;
                    else avgLabel = `${Math.round(hours / 24)}d`;
                }
            }
            if (avgTimeEl) avgTimeEl.textContent = avgLabel;
            const totalDays = days;
            const daySet = new Set(times.map(t => new Date(t).toISOString().split('T')[0]));
            const productivity = Math.round((daySet.size / totalDays) * 100);
            if (productivityEl) productivityEl.textContent = `${productivity}%`;
        }

        function populateAnalyticsFilters() {
            const ldSel = viewMode === 'cct' ? document.getElementById('leaderFilterCCT') : document.getElementById('leaderFilter');
            if (!ldSel) return;
            const all = viewMode === 'cct' ? inspections.slice() : (viewMode === 'irr' ? (Array.isArray(irrigInspections) ? irrigInspections.slice() : []) : getAllInspectionsCombined());
            const leaders = Array.from(new Set((all || []).map(i => i.mecanico).filter(Boolean))).sort();
            const current = ldSel.value;
            ldSel.innerHTML = '<option value="all" selected>Todos líderes</option>' + leaders.map(l => `<option value="${l}">${l}</option>`).join('');
            if (current && current !== 'all') { ldSel.value = current; }
        }

        function downloadChart(canvasId, name) {
            const c = document.getElementById(canvasId);
            if (!c) return;
            const url = c.toDataURL('image/png');
            const a = document.createElement('a');
            a.href = url;
            a.download = `${name}-analytics.png`;
            document.body.appendChild(a);
            a.click();
            a.remove();
        }

        function setupRealtime() {
            try {
                if (realtimeChannel && systemBroadcastChannel) return;
                realtimeChannel = supabase.channel('all-changes')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'inspections' }, (payload) => {
                        if (!savingInspection) {
                            loadInitialData();
                        }
                        const r = payload && payload.new ? payload.new : {};
                        const f = r.frota || '';
                        pushNotification('info', 'Nova inspeção', f ? `Inspeção lançada para ${f}` : 'Inspeção lançada');
                    })
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'irrig_inspections' }, (payload) => {
                        if (!savingInspection) { loadInitialData(); }
                        const r = payload && payload.new ? payload.new : {};
                        const f = r.frota || '';
                        pushNotification('info', 'Nova inspeção (Irrigação)', f ? `Inspeção lançada para ${f}` : 'Inspeção lançada');
                    })
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'equipments' }, (payload) => {
                        loadEquipments().then(() => {
                            populateEquipmentList();
                        });
                        const r = payload && payload.new ? payload.new : {};
                        const f = r.frota || '';
                        pushNotification('info', 'Novo equipamento', f ? `Equipamento ${f} cadastrado` : 'Equipamento cadastrado');
                    })
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'system_events' }, (payload) => {
                        const ev = payload && payload.new ? payload.new : {};
                        if ((ev.type || '') === 'force_refresh') {
                            showFloatingNotification('warning', 'NOVA ATUALIZAÇÃO DO SISTEMA');
                            pushNotification('info', 'Atualização', 'NOVA ATUALIZAÇÃO DO SISTEMA');
                            setTimeout(() => { try { location.reload(); } catch(_) {} }, 2000);
                        } else if ((ev.type || '') === 'new_inspection') {
                            const t = ev.title || 'Nova inspeção';
                            const m = ev.message || 'Inspeção lançada';
                            const p = ev.payload || {};
                            const link = { modulo: p.modulo || 'cct', tipo: p.tipo || '', frota: p.frota || '', mecanico: p.mecanico || '', data: p.data || '', id: p.id || '', local_id: p.local_id || '' };
                            pushNotification('info', t, m, link);
                        }
                    })
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'users' }, () => { loadUsers(); })
                    .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'users' }, () => { loadUsers(); })
                    .subscribe();

                systemBroadcastChannel = supabase.channel('system-broadcast')
                    .on('broadcast', { event: 'force_refresh' }, (payload) => {
                        const p = (payload && payload.payload) || {};
                        const msg = p.message || 'NOVA ATUALIZAÇÃO DO SISTEMA';
                        const requireConfirm = !!p.requireConfirm;
                        showFloatingNotification('warning', msg);
                        pushNotification('info', 'Atualização', msg);
                        if (requireConfirm) { showUpdatePrompt(msg); }
                        else { setTimeout(() => { try { location.reload(); } catch(_) {} }, 2000); }
                    })
                    .on('broadcast', { event: 'new_inspection' }, (payload) => {
                        const p = (payload && payload.payload) || {};
                        const modulo = p.modulo || 'cct';
                        const tipo = p.tipo || '';
                        const frota = p.frota || '';
                        const mecanico = p.mecanico || '';
                        const data = p.data || '';
                        const id = p.id || '';
                        const local_id = p.local_id || '';
                        const t = modulo === 'irr' ? 'Nova inspeção (Irrigação)' : 'Nova inspeção';
                        const m = `${tipo} • ${frota} • ${mecanico}`.trim();
                        const link = { modulo, tipo, frota, mecanico, data, id, local_id };
                        pushNotification('info', t, m, link);
                    })
                    .subscribe();
            } catch (e) {
                console.warn('Realtime não disponível:', e);
            }
        }

        function startPolling() {
            if (pollingTimer) return;
            pollingTimer = setInterval(() => {
                loadInitialData();
            }, 300000);
        }

        async function syncPendingInspections() {
            if (syncingInspections) return;
            const queue = getPendingInspections();
            if (!isOnline() || queue.length === 0) return;
            syncingInspections = true;
            showFloatingNotification('info', 'Sincronizando dados offline...');
            setPendingInspections([]);
            const remaining = [];
            for (const item of queue) {
                try {
                    const { error } = await supabase
                        .from('inspections')
                        .upsert([{ data: item.data, tipo: item.tipo, frota: item.frota, mecanico: item.mecanico, items: item.items, results: item.results, user_id: item.user_id, created_at: item.created_at, local_id: item.local_id }], { onConflict: 'local_id' });
                    if (error) { throw error; }
                    try { await supabase.from('system_events').insert([{ type:'new_inspection', title:'Nova inspeção', message: `${item.tipo||''} • ${item.frota||''} • ${item.mecanico||''}`, payload: { tipo: item.tipo||'', frota: item.frota||'', mecanico: item.mecanico||'', data: item.data||'', local_id: item.local_id||'', modulo: 'cct' } }]); } catch(_) {}
                    try { systemBroadcastChannel && systemBroadcastChannel.send({ type:'broadcast', event:'new_inspection', payload: { modulo:'cct', tipo: item.tipo||'', frota: item.frota||'', mecanico: item.mecanico||'', data: item.data||'', local_id: item.local_id||'' } }); } catch(_) {}
                } catch (e) {
                    remaining.push(item);
                }
            }
            setPendingInspections(remaining);
            await loadInitialData();
            if (remaining.length === 0) showFloatingNotification('success', 'Sincronização concluída'); else showFloatingNotification('warning', 'Alguns itens não sincronizaram');
            syncingInspections = false;
        }

        async function syncPendingIrrInspections() {
            const queue = getPendingIrrInspections();
            if (!isOnline() || queue.length === 0) return;
            setPendingIrrInspections([]);
            const remaining = [];
            for (const item of queue) {
                try {
                    const { error } = await supabase
                        .from('irrig_inspections')
                        .upsert([{ data: item.data, tipo: item.tipo, frota: item.frota, mecanico: item.mecanico, observacao: item.observacao, items: item.items, results: item.results, user_id: item.user_id, created_at: item.created_at, local_id: item.local_id }], { onConflict: 'local_id' });
                    if (error) throw error;
                } catch (_) { remaining.push(item); }
            }
            setPendingIrrInspections(remaining);
            if (remaining.length === 0) showFloatingNotification('success', 'Irrigação sincronizada'); else showFloatingNotification('warning', 'Irrigação com itens pendentes');
        }

        async function syncPendingEquipments() {
            const queue = getPendingEquipments();
            if (!isOnline() || queue.length === 0) return;
            const remaining = [];
            for (const item of queue) {
                try {
                    const { error } = await supabase
                        .from('equipments')
                        .insert([{ tipo: item.tipo, frota: item.frota, descricao: item.descricao, status: item.status, created_at: item.created_at }]);
                    if (error) throw error;
                } catch (e) {
                    remaining.push(item);
                }
            }
            setPendingEquipments(remaining);
            await loadEquipments();
            populateEquipmentList();
            if (remaining.length === 0) showFloatingNotification('success', 'Frotas sincronizadas com o banco');
        }

        function updateSparkline() {
            if (typeof Chart === 'undefined') { ensureChartJs().then(() => updateSparkline()); return; }
            const ctx = document.getElementById('inspecoesSparkline');
            if (!ctx || typeof Chart === 'undefined') return;
            const all = getAllInspectionsCombined();
            const last = all.slice(-7);
            const data = last.map(i => i.results?.percentage || 0);
            const labels = last.map(i => formatDateBR(i.data));
            if (!sparklineChart) {
                sparklineChart = new Chart(ctx, {
                    type: 'line',
                    data: { labels, datasets: [{ data, borderColor: '#5D5CDE', backgroundColor: 'rgba(93,92,222,0.15)', fill: true, tension: 0.4 }] },
                    options: { plugins: { legend: { display: false } }, scales: { x: { display: false }, y: { display: false } }, elements: { point: { radius: 0 } } }
                });
            } else {
                sparklineChart.data.labels = labels;
                sparklineChart.data.datasets[0].data = data;
                sparklineChart.update();
            }
        }

        function updateAnalytics() {
            const containerIssues = document.getElementById('criticalIssues');
            const containerTop = document.getElementById('topMecanicos');
            const badge = document.getElementById('criticalCountBadge');
            const cardCrit = document.getElementById('criticalCountCard');
            const eqSel = viewMode === 'cct' ? document.getElementById('equipmentFilterCCT') : document.getElementById('equipmentFilter');
            const ldSel = viewMode === 'cct' ? document.getElementById('leaderFilterCCT') : document.getElementById('leaderFilter');
            const eqFilter = eqSel ? eqSel.value : 'all';
            const ldFilter = ldSel ? ldSel.value : 'all';
            const all = viewMode === 'cct' ? inspections.slice() : (viewMode === 'irr' ? (Array.isArray(irrigInspections) ? irrigInspections.slice() : []) : getAllInspectionsCombined());
            const filteredAll = all.filter(i => {
                const byEq = eqFilter === 'all' ? true : i.tipo === eqFilter;
                const byLd = ldFilter === 'all' ? true : (i.mecanico || '') === ldFilter;
                return byEq && byLd;
            });
            if (containerIssues) {
                const crit = filteredAll.filter(i => (i.results?.percentage||0) < 60 || (i.results?.notOk||0) > (i.results?.ok||0)).slice(0,3);
                if (badge) { badge.textContent = `${crit.length} ativos`; }
                if (cardCrit) { cardCrit.textContent = `${crit.length}`; }
                if (crit.length === 0) {
                    containerIssues.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-6">Nenhum problema crítico</div>`;
                } else {
                    containerIssues.innerHTML = crit.map(i => {
                        const color = (i.results?.percentage||0) < 60 ? 'red' : 'yellow';
                        const nots = i.results?.notOk||0;
                        const when = i.created_at ? new Date(i.created_at).toLocaleString('pt-BR') : formatDateBR(i.data);
                        return `
                            <div class="flex items-start space-x-3 p-4 bg-${color}-50 dark:bg-${color}-900/20 rounded-lg">
                                <div class="flex-shrink-0">
                                    <div class="w-8 h-8 bg-${color}-100 dark:bg-${color}-900 rounded-full flex items-center justify-center">
                                        <svg class="w-4 h-4 text-${color}-600 dark:text-${color}-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-gray-900 dark:text-white">${i.tipo} ${i.frota}</p>
                                    <p class="text-sm text-gray-500 dark:text-gray-400">${nots} itens NÃO OK</p>
                                    <p class="text-xs text-gray-400 dark:text-gray-500 mt-1">${when}</p>
                                </div>
                            </div>
                        `;
                    }).join('');
                }
            }
            if (containerTop) {
                const byMech = {};
                filteredAll.forEach(i => {
                    const m = i.mecanico||'--';
                    if (!byMech[m]) byMech[m] = { count:0, sum:0 };
                    byMech[m].count++;
                    byMech[m].sum += i.results?.percentage||0;
                });
                const ranking = Object.entries(byMech).map(([m,v])=>({m, avg: v.count?Math.round(v.sum/v.count):0, count:v.count})).sort((a,b)=>b.avg-a.avg).slice(0,3);
                if (ranking.length === 0) {
                    containerTop.innerHTML = `<div class="text-center text-gray-500 dark:text-gray-400 py-6">Sem dados</div>`;
                } else {
                    containerTop.innerHTML = ranking.map((r,idx)=>{
                        return `
                            <div class="flex items-center justify-between p-3 bg-green-50 dark:bg-green-900/20 rounded-lg">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 bg-green-100 dark:bg-green-900 rounded-full flex items-center justify-center">
                                        <span class="text-green-600 dark:text-green-400 font-bold text-sm">${idx+1}</span>
                                    </div>
                                    <div>
                                        <p class="text-sm font-medium text-gray-900 dark:text-white">${r.m}</p>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">${r.count} inspeções</p>
                                    </div>
                                </div>
                                <span class="text-sm font-semibold text-green-700 dark:text-green-300">${r.avg}%</span>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        function initCalibragemForm() {
            try {
                const u = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
                const nm = document.getElementById('calNome');
                if (nm) nm.value = getDisplayName(u);
                const now = new Date();
                const d = now.toISOString().split('T')[0];
                const t = now.toTimeString().slice(0,5);
                const di = document.getElementById('calDataIni');
                const hi = document.getElementById('calHoraIni');
                const df = document.getElementById('calDataFim');
                const hf = document.getElementById('calHoraFim');
                if (di) di.value = d;
                if (hi) hi.value = t;
                if (df) df.value = d;
                if (hf) hf.value = t;
                attachCalibragemMasks();
                const st = document.getElementById('calibragemStatus');
                if (st) st.textContent = '';
                const eq = document.getElementById('calEquipamento');
                const pick = (v) => {
                    const vv = String(v || '').toLowerCase();
                    setCalibMap(vv.includes('transbord') ? 'transbordo' : 'truck');
                    populateFrotaOptionsFor(vv || 'caminhao', 'calFrotaSelect', 'calFrotaCustom');
                };
                const bindFrota = () => bindFrotaSelectFor('calFrotaSelect','calFrotaCustom');
                if (eq) {
                    loadEquipments().then(() => {
                        pick(eq.value);
                        bindFrota();
                    });
                    eq.addEventListener('change', () => pick(eq.value));
                } else {
                    setCalibMap('truck');
                    loadEquipments().then(() => {
                        populateFrotaOptionsFor('caminhao','calFrotaSelect','calFrotaCustom');
                        bindFrota();
                    });
                }
            } catch(_) {}
        }

        function attachCalibragemMasks() {
            try {
                const ids = Array.from(document.querySelectorAll('input[id^="sulco_"], input[id^="calib_"]'));
                ids.forEach(el => {
                    el.addEventListener('input', () => {
                        const v = String(el.value || '').replace(',', '.');
                        const n = v.replace(/[^0-9.]/g, '');
                        const parts = n.split('.');
                        const clean = parts.length > 2 ? parts[0] + '.' + parts.slice(1).join('') : n;
                        el.value = clean;
                    });
                });
            } catch(_) {}
        }

        function focusCalibragemField(key) {
            try {
                showSection('calibragem');
                const box = document.getElementById('calib_box_' + key);
                const input = document.getElementById('calib_' + key + '_encon');
                if (box) {
                    box.classList.add('calib-highlight');
                    box.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => { box.classList.remove('calib-highlight'); }, 2000);
                }
                if (input) { input.focus(); }
            } catch(_) {}
        }

        function setCalibMap(type) {
            try {
                const mt = document.getElementById('mapTruck');
                const mx = document.getElementById('mapTransbordo');
                const tbT = document.getElementById('tabTruck');
                const tbX = document.getElementById('tabTrans');
                if (!mt || !mx || !tbT || !tbX) return;
                if (type === 'transbordo') {
                    mt.classList.add('hidden');
                    mx.classList.remove('hidden');
                    tbT.classList.remove('active');
                    tbX.classList.add('active');
                } else {
                    mx.classList.add('hidden');
                    mt.classList.remove('hidden');
                    tbX.classList.remove('active');
                    tbT.classList.add('active');
                }
            } catch(_) {}
        }

        function setCalibragemEndNow() {
            try {
                const now = new Date();
                const d = now.toISOString().split('T')[0];
                const t = now.toTimeString().slice(0,5);
                const df = document.getElementById('calDataFim');
                const hf = document.getElementById('calHoraFim');
                if (df) df.value = d;
                if (hf) hf.value = t;
            } catch(_) {}
        }

        function collectCalibragemData() {
            const header = {
                frota: (() => { const sel = document.getElementById('calFrotaSelect'); const cus = document.getElementById('calFrotaCustom'); return ((sel?.value === 'custom' ? (cus?.value||'') : (sel?.value||'')) || '').trim(); })(),
                equipamento: (document.getElementById('calEquipamento')?.value || '').trim(),
                hodo: (document.getElementById('calHodo')?.value || '').trim(),
                os_item: (document.getElementById('calOS')?.value || '').trim(),
                matricula: (document.getElementById('calMatricula')?.value || '').trim(),
                nome: (document.getElementById('calNome')?.value || '').trim(),
                data_ini: (document.getElementById('calDataIni')?.value || '').trim(),
                hora_ini: (document.getElementById('calHoraIni')?.value || '').trim(),
                data_fim: (document.getElementById('calDataFim')?.value || '').trim(),
                hora_fim: (document.getElementById('calHoraFim')?.value || '').trim()
            };
            const pos = {};
            ['1de','1di','2de','2di','3de','3di','4de','4di','1ee','1ei','2ee','2ei','3ee','3ei','4ee','4ei','est1','est2'].forEach(k => {
                pos[k] = (document.getElementById('pos_' + k)?.value || '').trim();
            });
            const sulcoIds = ['1de','1di','2de','2di','3de','3di','4de','4di','1ei','1ee','2ei','2ee','3ei','3ee','4ei','4ee'];
            const sulco = {};
            sulcoIds.forEach(k => {
                const a = (document.getElementById('sulco_' + k + '_a')?.value || '').trim();
                const b = (document.getElementById('sulco_' + k + '_b')?.value || '').trim();
                sulco[k] = { a, b };
            });
            sulco.est = (document.getElementById('sulco_est')?.value || '').trim();
            const calibIds = ['1de','1di','2de','2di','3de','3di','4de','4di','1ei','1ee','2ei','2ee','3ei','3ee','4ei','4ee','est1','est2'];
            const calibragem = {};
            calibIds.forEach(k => {
                const encon = (document.getElementById('calib_' + k + '_encon')?.value || '').trim();
                const colo = (document.getElementById('calib_' + k + '_colo')?.value || '').trim();
                calibragem[k] = { encon, colo };
            });
            const observacoes = (document.getElementById('calObservacoes')?.value || '').trim();
            return { header, pos, sulco, calibragem, observacoes };
        }

        async function saveCalibragem() {
            try {
                const btn = document.getElementById('calBtnSalvar');
                if (btn) btn.disabled = true;
                const data = collectCalibragemData();
                if (!data.header.frota || !data.header.equipamento || !data.header.data_ini) { showCustomAlert('Preencha Frota, Equipamento e Data Inicial.'); if (btn) btn.disabled = false; return; }
                const user = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
                const isAuthenticated = !!(user && user.id && user.id !== 'offline');
                const local_id = (crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString());
                const record = { local_id, created_at: new Date().toISOString(), user_id: user.id, ...data };
                if (isOnline() && isAuthenticated) {
                    const { error } = await supabase.from('calibragem').upsert([record], { onConflict: 'local_id' });
                    if (error) {
                        queueCalibragem({ ...record, offline: true });
                        showFloatingNotification('warning', 'Falha ao salvar online. Salvo offline e será sincronizado.');
                    } else {
                        showFloatingNotification('success', 'Calibragem salva.');
                        clearCalibragemForm();
                    }
                } else {
                    queueCalibragem({ ...record, offline: true });
                    const msg = !isOnline() ? 'Sem internet. Salvo offline e será sincronizado.' : 'Usuário não autenticado. Salvo offline e será sincronizado.';
                    showFloatingNotification('warning', msg);
                    clearCalibragemForm();
                }
                const st = document.getElementById('calibragemStatus');
                if (st) st.textContent = 'Não esqueça de imprimir como necessário.';
                if (btn) btn.disabled = false;
            } catch(_) {}
        }

        function clearCalibragemForm() {
            try {
                const ids = [
                    'calFrotaSelect','calFrotaCustom','calEquipamento','calHodo','calOS','calMatricula','calNome','calDataIni','calHoraIni','calDataFim','calHoraFim'
                ];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                ['pos_','sulco_','calib_'].forEach(prefix => {
                    const inputs = Array.from(document.querySelectorAll('input[id^="' + prefix + '"]'));
                    inputs.forEach(el => { el.value = ''; });
                });
                const obs = document.getElementById('calObservacoes');
                if (obs) obs.value = '';
                initCalibragemForm();
            } catch(_) {}
        }

        async function syncPendingCalibragem() {
            const queue = getPendingCalibragem();
            if (!isOnline() || queue.length === 0) return;
            const remaining = [];
            for (const item of queue) {
                try {
                    const { error } = await supabase.from('calibragem').upsert([item], { onConflict: 'local_id' });
                    if (error) throw error;
                } catch (e) {
                    remaining.push(item);
                }
            }
            setPendingCalibragem(remaining);
            if (remaining.length === 0) showFloatingNotification('success', 'Calibragens sincronizadas');
        }

        function initControle3pForm() {
            try {
                const u = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
                const nm = document.getElementById('c3pNome');
                if (nm) nm.value = getDisplayName(u);
                const now = new Date();
                const d = now.toISOString().split('T')[0];
                const t = now.toTimeString().slice(0,5);
                const di = document.getElementById('c3pDataIni');
                const hi = document.getElementById('c3pHoraIni');
                const df = document.getElementById('c3pDataFim');
                const hf = document.getElementById('c3pHoraFim');
                if (di) di.value = d;
                if (hi) hi.value = t;
                if (df) df.value = d;
                if (hf) hf.value = t;
                const body = document.getElementById('ctrl3pTableBody');
                if (body) {
                    const positions = ['1º DE','1º DI','1º EE','1º EI','2º DE','2º DI','2º EE','2º EI','3º DE','3º DI','3º EE','3º EI','4º DE','4º DI','4º EE','4º EI'];
                    body.innerHTML = positions.map((pos, idx)=>{
                        const id = idx+1;
                        return `
                            <tr>
                                <td class="px-2 py-2 text-gray-700 dark:text-gray-300">${id}</td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="posicao" value="${pos}" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="fogo" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="medida" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="fabricante" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="modelo" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="indice" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="dot" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="sulco1" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="sulco2" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="sulco3" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                                <td class="px-2 py-2"><input data-id="${id}" data-field="pressao" class="w-full px-2 py-1 border border-gray-300 dark:border-gray-600 rounded-md bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></td>
                            </tr>
                        `;
                    }).join('');
                }
                const eqSel = document.getElementById('c3pEquipamento');
                const apply = (v) => {
                    const vv = String(v || '').toLowerCase();
                    populateFrotaOptionsFor(vv || 'caminhao', 'c3pFrotaSelect', 'c3pFrotaCustom');
                };
                const bindF = () => bindFrotaSelectFor('c3pFrotaSelect','c3pFrotaCustom');
                if (eqSel) {
                    loadEquipments().then(() => { apply(eqSel.value); bindF(); });
                    eqSel.addEventListener('change', () => apply(eqSel.value));
                } else {
                    loadEquipments().then(() => { populateFrotaOptionsFor('caminhao','c3pFrotaSelect','c3pFrotaCustom'); bindF(); });
                }
                const st = document.getElementById('controle3pStatus');
                if (st) st.textContent = '';
            } catch(_) {}
        }

        function collectControle3pData() {
            const header = {
                frota: (() => { const sel = document.getElementById('c3pFrotaSelect'); const cus = document.getElementById('c3pFrotaCustom'); return ((sel?.value === 'custom' ? (cus?.value||'') : (sel?.value||'')) || '').trim(); })(),
                equipamento: (document.getElementById('c3pEquipamento')?.value || '').trim(),
                hodo: (document.getElementById('c3pHodo')?.value || '').trim(),
                os_item: (document.getElementById('c3pOS')?.value || '').trim(),
                matricula: (document.getElementById('c3pMatricula')?.value || '').trim(),
                nome: (document.getElementById('c3pNome')?.value || '').trim(),
                data_ini: (document.getElementById('c3pDataIni')?.value || '').trim(),
                hora_ini: (document.getElementById('c3pHoraIni')?.value || '').trim(),
                data_fim: (document.getElementById('c3pDataFim')?.value || '').trim(),
                hora_fim: (document.getElementById('c3pHoraFim')?.value || '').trim()
            };
            const rows = Array.from(document.querySelectorAll('#ctrl3pTableBody input')).reduce((acc, el)=>{
                const id = el.getAttribute('data-id');
                const field = el.getAttribute('data-field');
                if (!acc[id]) acc[id] = { seq: parseInt(id,10) };
                acc[id][field] = (el.value||'').trim();
                return acc;
            }, {});
            return { header, rows: Object.values(rows) };
        }

        async function saveControle3p() {
            try {
                const btn = document.getElementById('c3pBtnSalvar');
                if (btn) btn.disabled = true;
                const data = collectControle3pData();
                if (!data.header.frota || !data.header.equipamento || !data.header.data_ini) { showCustomAlert('Preencha Frota, Equipamento e Data Inicial.'); if (btn) btn.disabled = false; return; }
                const user = (typeof currentUser !== 'undefined' && currentUser) || getCachedUser() || getOfflineUser();
                const isAuthenticated = !!(user && user.id && user.id !== 'offline');
                const local_id = (crypto && crypto.randomUUID ? crypto.randomUUID() : Date.now().toString());
                const record = { local_id, created_at: new Date().toISOString(), user_id: user.id, ...data };
                if (isOnline() && isAuthenticated) {
                    const { error } = await supabase.from('controle_3p').upsert([record], { onConflict: 'local_id' });
                    if (error) {
                        queueControle3p({ ...record, offline: true });
                        showFloatingNotification('warning', 'Falha ao salvar online. Salvo offline e será sincronizado.');
                    } else {
                        showFloatingNotification('success', 'Ficha 3P salva.');
                        clearControle3pForm();
                    }
                } else {
                    queueControle3p({ ...record, offline: true });
                    const msg = !isOnline() ? 'Sem internet. Salvo offline e será sincronizado.' : 'Usuário não autenticado. Salvo offline e será sincronizado.';
                    showFloatingNotification('warning', msg);
                    clearControle3pForm();
                }
                const st = document.getElementById('controle3pStatus');
                if (st) st.textContent = 'Não esqueça de imprimir como necessário.';
                if (btn) btn.disabled = false;
            } catch(_) {}
        }

        function clearControle3pForm() {
            try {
                const ids = ['c3pFrotaSelect','c3pFrotaCustom','c3pEquipamento','c3pHodo','c3pOS','c3pMatricula','c3pNome','c3pDataIni','c3pHoraIni','c3pDataFim','c3pHoraFim'];
                ids.forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
                const body = document.getElementById('ctrl3pTableBody');
                if (body) body.innerHTML = '';
                initControle3pForm();
            } catch(_) {}
        }

        async function syncPendingControle3p() {
            const queue = getPendingControle3p();
            if (!isOnline() || queue.length === 0) return;
            const remaining = [];
            for (const item of queue) {
                try {
                    const { error } = await supabase.from('controle_3p').upsert([item], { onConflict: 'local_id' });
                    if (error) throw error;
                } catch (e) {
                    remaining.push(item);
                }
            }
            setPendingControle3p(remaining);
            if (remaining.length === 0) showFloatingNotification('success', 'Fichas 3P sincronizadas');
        }

        // Report generation functions
        function generateReport() {
            let type = document.getElementById('reportType').value;
            if (!type && typeof window !== 'undefined' && window.quickReportType) { type = window.quickReportType; }
            const period = document.getElementById('reportPeriod').value;
            const eqType = document.getElementById('reportEqType')?.value || 'all';
            let format = document.getElementById('reportFormat').value;
            const supported = ['csv','excel','pdf','json'];
            if (!supported.includes(format)) { format = 'csv'; }
            const daysMap = { '7': 7, '30': 30, '90': 90 };
            const days = daysMap[period] || 30;
            const end = new Date();
            const start = new Date();
            start.setDate(end.getDate() - days + 1);
            const all = getAllInspectionsCombined();
            let filtered = all.filter(i => {
                const d = dateOnlyToLocalDate(i.data);
                return d >= start && d <= end;
            });
            if (eqType && eqType !== 'all') {
                filtered = filtered.filter(i => String(i.tipo) === eqType);
            }
            const quickTypes = ['summary','performance','maintenance','trends','compliance','costs'];
            if (quickTypes.includes(type)) {
                if (type === 'performance') {
                    filtered = filtered.slice().sort((a,b) => (b.results?.percentage||0) - (a.results?.percentage||0));
                } else if (type === 'maintenance') {
                    filtered = filtered.filter(i => {
                        const items = Array.isArray(i.items) ? i.items : [];
                        const hasNonOkItem = items.some(it => {
                            const s = it.status;
                            const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                            const hasNote = !!(it.note && String(it.note).trim());
                            return sval === 'notok' || (!s && hasNote);
                        });
                        return (i.results?.notOk||0) > 0 || hasNonOkItem;
                    });
                } else if (type === 'trends') {
                    filtered = filtered.slice().sort((a,b) => dateOnlyToLocalDate(a.data) - dateOnlyToLocalDate(b.data));
                } else if (type === 'compliance') {
                    filtered = filtered.filter(i => (i.results?.percentage||0) >= 90);
                } else if (type === 'costs') {
                    filtered = filtered.filter(i => (i.results?.notOk||0) > 0);
                }
            } else if (type === 'criticos') {
                filtered = filtered.filter(i => (i.results?.notOk||0) > 0);
            }
            const total = filtered.length;
            const avg = total ? Math.round(filtered.reduce((s,i)=>s+(i.results?.percentage||0),0)/total) : 0;
            const counts = { caminhao: 0, trator: 0, colhedora: 0, plantadora: 0, distribuidora: 0, reboque: 0, manutencao: 0, motobombas: 0, hidroroll: 0, tortao: 0 };
            filtered.forEach(i => { if (counts[i.tipo] !== undefined) counts[i.tipo]++; });
            if (format === 'json') {
                const payload = {
                    type,
                    period,
                    summary: { total, average: avg, counts },
                    inspections: filtered
                };
                const blob = new Blob([JSON.stringify(payload, null, 2)], { type: 'application/json' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `relatorio_${type}_${period}.json`;
                a.click();
                URL.revokeObjectURL(a.href);
                showFloatingNotification('success', 'Relatório JSON gerado');
            } else if (format === 'csv') {
                const header = ['data','tipo','frota','lider','ok','nao_ok','percentual','observacao'];
                const rows = filtered.map(i => {
                    const obs = i.observacao || (Array.isArray(i.items) ? ((i.items.find(it => String(it.name) === 'Observação')?.note) || '') : '');
                    const esc = (v) => {
                        const s = String(v ?? '');
                        if (s.includes(',') || s.includes('"') || s.includes('\n')) return '"' + s.replaceAll('"', '""') + '"';
                        return s;
                    };
                    return [
                        esc(i.data),
                        esc(i.tipo),
                        esc(i.frota),
                        esc(i.mecanico),
                        esc(i.results?.ok||0),
                        esc(i.results?.notOk||0),
                        esc(i.results?.percentage||0),
                        esc(obs)
                    ].join(',');
                });
                const csv = [header.join(','), ...rows].join('\n');
                const blob = new Blob([csv], { type: 'text/csv' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `relatorio_${type}_${period}.csv`;
                a.click();
                URL.revokeObjectURL(a.href);
                showFloatingNotification('success', 'Relatório CSV gerado');
            } else if (format === 'excel') {
                const header = ['Data','Tipo','Frota','Mecânico','OK','NÃO OK','Percentual'];
                const rows = filtered.map(i => `
                    <tr>
                        <td>${i.data}</td>
                        <td>${i.tipo}</td>
                        <td>${i.frota}</td>
                        <td>${i.mecanico}</td>
                        <td>${i.results?.ok||0}</td>
                        <td>${i.results?.notOk||0}</td>
                        <td>${i.results?.percentage||0}</td>
                    </tr>
                `).join('');
                const html = `
                    <html><head>
                        <meta charset="utf-8" />
                    </head><body>
                        <table border="1">
                            <thead><tr>${header.map(h=>`<th>${h}</th>`).join('')}</tr></thead>
                            <tbody>${rows}</tbody>
                        </table>
                    </body></html>
                `;
                const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `relatorio_${type}_${period}.xls`;
                a.click();
                URL.revokeObjectURL(a.href);
                showFloatingNotification('success', 'Relatório Excel (XLS) gerado');
            } else if (format === 'pdf') {
                const rows = (filtered.length ? filtered.map(i => `
                    <tr>
                        <td>${formatDateBR(i.data)}</td>
                        <td>${i.tipo}</td>
                        <td>${i.frota}</td>
                        <td>${i.mecanico}</td>
                        <td>${i.results?.ok||0}</td>
                        <td>${i.results?.notOk||0}</td>
                        <td>${i.results?.percentage||0}%</td>
                    </tr>
                `).join('') : '<tr><td colspan="7">Sem registros no período selecionado</td></tr>');
                const dist = counts;
                const dateRange = `${start.toLocaleDateString('pt-BR')} — ${end.toLocaleDateString('pt-BR')}`;
                const maintSection = (type === 'maintenance') ? (() => {
                    const blocks = filtered.map(i => {
                        const arr = Array.isArray(i.items) ? i.items : [];
                        const nonOk = arr.filter(it => {
                            const s = it.status;
                            const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                            const hasNote = !!(it.note && String(it.note).trim());
                            return sval === 'notok' || (!s && hasNote);
                        });
                        if (!nonOk.length) return '';
                        const lines = nonOk.map(it => {
                            const s = it.status;
                            const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                            const statusLabel = sval === 'notok' ? 'NÃO OK' : (sval === 'ok' ? 'OK' : 'NÃO OK');
                            const choice = (it.note && String(it.note).trim()) || (it.value && String(it.value).trim()) || (it.selected && String(it.selected).trim()) || '';
                            const desc = `${(it.section?it.section+' • ':'')}${it.name}`;
                            return `<li>${desc} — ${statusLabel}${choice ? ' • Motivo: '+choice : ''}</li>`;
                        }).join('');
                        return `<div class="mcard"><div class="mh">${formatDateBR(i.data)} • ${i.tipo} • Frota: ${i.frota} • Líder: ${i.mecanico}</div><ul class="mlist">${lines}</ul></div>`;
                    }).filter(Boolean).join('');
                    return blocks ? `<div class="section"><h4>Manutenções e Motivos</h4>${blocks}</div>` : `<div class="section"><h4>Manutenções e Motivos</h4><div class="muted">Nenhum motivo registrado</div></div>`;
                })() : '';
                const doc = `
                    <html><head>
                        <meta charset="utf-8" />
                        <title>Relatório</title>
                        <style>
                            @page { size: A4 portrait; margin: 12mm; }
                            * { box-sizing: border-box; }
                            body { font-family: Inter, Arial, sans-serif; padding: 0; color: #111827; }
                            .container { max-width: 940px; margin: 0 auto; padding: 24px; }
                            .header { display:flex; justify-content: space-between; align-items:center; margin-bottom: 16px; }
                            .brand { display:flex; align-items:center; gap:10px; }
                            .logo { width:28px; height:28px; border-radius:8px; background:#5D5CDE; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; }
                            .title { font-size: 18px; font-weight: 700; }
                            .subtitle { font-size: 12px; color:#6B7280; }
                            .kpis { display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:12px; margin: 18px 0; }
                            .card { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; }
                            .card h4 { margin:0; font-size:12px; color:#6B7280; }
                            .card .value { font-size:20px; font-weight:700; margin-top:6px; }
                            .chips { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }
                            .chip { font-size:11px; padding:4px 8px; border-radius:999px; border:1px solid #e5e7eb; color:#374151; background:#f9fafb; }
                            .table-wrap { margin-top: 16px; }
                            table { width: 100%; border-collapse: collapse; table-layout: fixed; }
                            thead th { background: #f3f4f6; text-align: left; font-size: 11px; color:#374151; border-bottom:1px solid #e5e7eb; }
                            th, td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 11px; word-break: break-word; }
                            tbody tr:nth-child(odd) { background: #fafafa; }
                            .section { margin-top: 18px; }
                            .mcard { border:1px solid #e5e7eb; border-radius:12px; padding:12px; background:#fff; margin-top:10px; }
                            .mh { font-size:12px; color:#374151; margin-bottom:8px; }
                            .mlist { margin:0; padding-left:16px; font-size:11px; color:#111827; }
                            .badge { display:inline-block; border-radius:6px; padding:2px 6px; font-size:11px; }
                            .ok { background:#ECFDF5; color:#065F46; border:1px solid #D1FAE5; }
                            .nok { background:#FEF2F2; color:#7F1D1D; border:1px solid #FECACA; }
                            .footer { margin-top: 18px; font-size: 11px; color:#6B7280; text-align:right; }
                            @media screen { body { background:#f3f4f6; } .container { background:#fff; padding:24px; box-shadow: 0 1px 6px rgba(0,0,0,0.08); } }
                        </style>
                    </head><body onload="window.print()">
                        <div class="container">
                            <div class="header">
                                <div class="brand"><div class="logo">GG</div><div><div class="title">GGOMES-LOG • Relatório ${type}</div><div class="subtitle">${dateRange}</div></div></div>
                                <div class="subtitle">Gerado em ${new Date().toLocaleString('pt-BR')}</div>
                            </div>
                            <div class="kpis">
                                <div class="card"><h4>Total</h4><div class="value">${total}</div></div>
                                <div class="card"><h4>Média de aprovação</h4><div class="value">${avg}%</div></div>
                                <div class="card"><h4>Distribuição</h4>
                                    <div class="chips">
                                        <span class="chip">Caminhões: ${dist.caminhao}</span>
                                        <span class="chip">Tratores: ${dist.trator}</span>
                                        <span class="chip">Colhedoras: ${dist.colhedora}</span>
                                        <span class="chip">Plantadoras: ${dist.plantadora}</span>
                                        <span class="chip">Distribuidoras: ${dist.distribuidora}</span>
                                        <span class="chip">Reboques: ${dist.reboque}</span>
                                        <span class="chip">Manutenção: ${dist.manutencao}</span>
                                        <span class="chip">MotoBombas: ${dist.motobombas}</span>
                                        <span class="chip">Hidro Roll: ${dist.hidroroll}</span>
                                    </div>
                                </div>
                             </div>
                             <div class="table-wrap">
                                 <table>
                                    <thead>
                                        <tr><th>Data</th><th>Tipo</th><th>Frota</th><th>Líder</th><th>OK</th><th>NÃO OK</th><th>%</th></tr>
                                    </thead>
                                    <tbody>${rows}</tbody>
                                 </table>
                             </div>
                            ${maintSection}
                            ${(type === 'performance') ? (() => {
                                const blocks = filtered.map(i => {
                                    const arr = Array.isArray(i.items) ? i.items : [];
                                    const okItems = arr.filter(it => {
                                        const s = it.status;
                                        const sval = typeof s === 'string' ? s.toLowerCase() : (typeof s === 'boolean' ? (s ? 'ok' : 'notok') : '');
                                        return sval === 'ok';
                                    });
                                    if (!okItems.length) return '';
                                    const lines = okItems.map(it => {
                                        const choice = (it.note && String(it.note).trim()) || (it.value && String(it.value).trim()) || (it.selected && String(it.selected).trim()) || '';
                                        const desc = `${(it.section?it.section+' • ':'')}${it.name}`;
                                        return `<li>${desc} — OK${choice ? ' • Observação: '+choice : ''}</li>`;
                                    }).join('');
                                    return `<div class="mcard"><div class="mh">${formatDateBR(i.data)} • ${i.tipo} • Frota: ${i.frota} • Líder: ${i.mecanico}</div><ul class="mlist">${lines}</ul></div>`;
                                }).filter(Boolean).join('');
                                return blocks ? `<div class="section"><h4>Itens OK (Performance)</h4>${blocks}</div>` : '';
                            })() : ''}
                             <div class="footer">Sistema de Checklist • ${new Date().getFullYear()}</div>
                        </div>
                    </body></html>
                `;
                const w = window.open('', '_blank');
                if (w) { w.document.write(doc); w.document.close(); }
                showFloatingNotification('success', 'Relatório PDF preparado (use Salvar como PDF)');
            } else {
                showFloatingNotification('warning', 'Formato não suportado. Use CSV, Excel ou PDF.');
            }
            if (typeof window !== 'undefined') { try { window.quickReportType = ''; } catch(_) {} }
        }

        function generateQuickReport(type) {
            const sel = document.getElementById('reportType');
            const per = document.getElementById('reportPeriod');
            const fmt = document.getElementById('reportFormat');
            if (sel) sel.value = type;
            if (per) per.value = '90';
            if (fmt) fmt.value = 'pdf';
            try { window.quickReportType = type; } catch(_) {}
            generateReport();
        }

        function scheduleReport() {
            showFloatingNotification('info', 'Funcionalidade de agendamento será implementada em breve.');
        }

        // Initialize charts when analytics section is shown
        document.addEventListener('DOMContentLoaded', function() {
            // Show notification badge if there are notifications
            if (notifications.length > 0) {
                const badge = document.getElementById('notificationBadge');
                badge.textContent = notifications.length;
                badge.classList.remove('hidden');
            }
            
            setTimeout(() => {
                const sel = document.getElementById('chartPeriod');
                const stored = localStorage.getItem('chartPeriod');
                if (sel && stored) sel.value = stored;
                initializeCharts();
                if (sel && !sel._persistBound) {
                    sel.addEventListener('change', () => localStorage.setItem('chartPeriod', sel.value));
                    sel._persistBound = true;
                }
            }, 500);
            const tip = document.getElementById('filtroTipo');
            const d1 = document.getElementById('filtroDataInicial');
            const d2 = document.getElementById('filtroDataFinal');
            const deb = debounce(filterHistory, 200);
            if (tip && !tip._bound) { tip.addEventListener('change', deb); tip._bound = true; }
            if (d1 && !d1._bound) { d1.addEventListener('input', deb); d1._bound = true; }
            if (d2 && !d2._bound) { d2.addEventListener('input', deb); d2._bound = true; }
            window.addEventListener('online', () => { showFloatingNotification('success', 'Conectado'); syncPendingInspections(); });
            window.addEventListener('offline', () => { showFloatingNotification('warning', 'Sem internet. Operando offline.'); });
            const printBtn = document.getElementById('printInspectionBtn');
            if (printBtn && !printBtn._bound) {
                printBtn.addEventListener('click', function() {
                    if (!currentInspectionId) { showCustomAlert('Selecione uma inspeção'); return; }
                    this.disabled = true;
                    try { printInspection(currentInspectionId); } finally { setTimeout(() => { this.disabled = false; }, 800); }
                });
                printBtn._bound = true;
            }
            sanitizeStrayNodes();
        });

        function openSettings() { 
            const sel = document.getElementById('themeModeSelect');
            const cur = localStorage.getItem('theme') || 'system';
            if (sel) sel.value = cur;
            showModal('settingsModal'); 
        }
        function setThemeMode(mode) {
            try { localStorage.setItem('theme', mode); } catch(_) {}
            initTheme();
        }
        function applyThemeChoice() {
            const sel = document.getElementById('themeModeSelect');
            if (sel) setThemeMode(sel.value);
            closeModal('settingsModal');
            showFloatingNotification('success', 'Tema atualizado');
        }

        function initTheme() {
            try {
                const s = localStorage.getItem('theme');
                const p = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                const d = s ? s === 'dark' : p;
                if (d) { document.documentElement.classList.add('dark'); } else { document.documentElement.classList.remove('dark'); }
            } catch (_) {}
        }

        function toggleTheme() {
            const isDark = document.documentElement.classList.toggle('dark');
            try { localStorage.setItem('theme', isDark ? 'dark' : 'light'); } catch (_) {}
        }

        // Hide notification center when clicking outside
        document.addEventListener('click', function(e) {
            const center = document.getElementById('notificationCenter');
            const button = e.target.closest('button[onclick="showNotificationCenter()"]');
            
            if (!center.contains(e.target) && !button) {
                center.classList.add('hidden');
            }
        });

        // Show welcome notification
        setTimeout(() => {
            showFloatingNotification('success', 'Bem-vindo ao Sistema Avançado de Checklist de Manutenção!', 3000);
        }, 1000);

        // Admin access management helpers
        async function saveAccessRule() {
            const emailEl = document.getElementById('adminEmailInput');
            const boxes = Array.from(document.querySelectorAll('#adminSectionsSelect input[type="checkbox"]'));
            const email = (emailEl?.value || '').trim().toLowerCase();
            const allowed = boxes.filter(b => b.checked && !b.dataset.section).map(b => b.value);
            const allowedSubsections = {};
            const cctParent = document.querySelector('#adminSectionsSelect input[value="cct_coque"]');
            const irrParent = document.querySelector('#adminSectionsSelect input[value="irrigacao"]');
            const cctSubs = Array.from(document.querySelectorAll('#adminSectionsSelect input[data-section="cct"]'));
            const irrSubs = Array.from(document.querySelectorAll('#adminSectionsSelect input[data-section="irr"]'));
            if (cctParent && cctParent.checked) { allowedSubsections['cct_coque'] = cctSubs.filter(b => b.checked).map(b => b.value); }
            if (irrParent && irrParent.checked) { allowedSubsections['irrigacao'] = irrSubs.filter(b => b.checked).map(b => b.value); }
            if (!email || allowed.length === 0) { showCustomAlert('Informe o email e selecione pelo menos uma seção.'); return; }
            if (!isOnline()) { showFloatingNotification('warning', 'Sem internet. Não foi possível salvar regras.'); return; }
            let hasAllowedSubsections = true;
            try {
                const probe = await supabase.from('access_controls').select('allowed_subsections').limit(1);
                if (probe.error) { hasAllowedSubsections = false; }
            } catch(_) { hasAllowedSubsections = false; }
            const rule = hasAllowedSubsections
                ? { email, role: 'restricted', allowed_sections: allowed, allowed_subsections: allowedSubsections, created_at: new Date().toISOString() }
                : { email, role: 'restricted', allowed_sections: allowed, created_at: new Date().toISOString() };
            try {
                const statusEl = document.getElementById('adminAccessControlsStatus');
                const exists = await supabase.from('access_controls').select('email').eq('email', email).limit(1);
                if (exists.error) {
                    const msg = exists.error?.message || 'Falha ao verificar existência no servidor';
                    const det = exists.error?.details ? ` (${exists.error.details})` : '';
                    if (statusEl) statusEl.textContent = `Erro: ${msg}${det}`;
                    showFloatingNotification('warning', 'Falha ao verificar existência no servidor');
                    return;
                }
                if (Array.isArray(exists.data) && exists.data.length > 0) {
                    const upd = hasAllowedSubsections
                        ? { role: 'restricted', allowed_sections: allowed, allowed_subsections: allowedSubsections }
                        : { role: 'restricted', allowed_sections: allowed };
                    const updResp = await supabase.from('access_controls').update(upd).eq('email', email);
                    if (updResp.error) {
                        const msg = updResp.error?.message || 'Falha ao atualizar regras no servidor';
                        const det = updResp.error?.details ? ` (${updResp.error.details})` : '';
                        if (statusEl) statusEl.textContent = `Erro: ${msg}${det}. Use o guia abaixo para criar/ajustar a tabela.`;
                        showFloatingNotification('warning', 'Falha ao atualizar regras no servidor');
                        return;
                    }
                } else {
                    const insResp = await supabase.from('access_controls').insert([rule]);
                    if (insResp.error) {
                        const msg = insResp.error?.message || 'Falha ao inserir regras no servidor';
                        const det = insResp.error?.details ? ` (${insResp.error.details})` : '';
                        const code = insResp.error?.code ? ` [${insResp.error.code}]` : '';
                        if (statusEl) statusEl.textContent = `Erro: ${msg}${det}${code}. Use o guia abaixo para criar/ajustar a tabela.`;
                        showFloatingNotification('warning', `Falha ao inserir regras: ${msg}${det}${code}`);
                        return;
                    }
                }
                showFloatingNotification('success', 'Regra salva');
                if (statusEl) statusEl.textContent = hasAllowedSubsections ? 'Regra salva no servidor.' : 'Regra salva (sem allowed_subsections). Crie a coluna via SQL se precisar subseções.';
                await loadAccessControls();
                renderAccessControls();
                applyAccessControls();
            } catch(e) {
                const statusEl = document.getElementById('adminAccessControlsStatus');
                const msg = e?.message || 'Erro ao salvar regras no servidor.';
                if (statusEl) statusEl.textContent = msg;
                showFloatingNotification('error', 'Erro ao salvar regras');
            }
        }

        async function deleteAccessRule(email) {
            const e = (email||'').toLowerCase();
            if (!isOnline()) { showFloatingNotification('warning', 'Sem internet. Não foi possível remover regras.'); return; }
            try {
                const statusEl = document.getElementById('adminAccessControlsStatus');
                const pre = await supabase.from('access_controls').select('email').eq('email', e).limit(1);
                if (pre.error) {
                    const msg = pre.error?.message || 'Falha ao verificar regra';
                    const det = pre.error?.details ? ` (${pre.error.details})` : '';
                    const code = pre.error?.code ? ` [${pre.error.code}]` : '';
                    if (statusEl) statusEl.textContent = `Erro: ${msg}${det}${code}`;
                    showFloatingNotification('warning', `Falha ao verificar regra: ${msg}${det}${code}`);
                    return;
                }
                const exists = Array.isArray(pre.data) && pre.data.length > 0;
                const resp = await supabase.from('access_controls').delete().eq('email', e).select('email');
                if (resp.error) {
                    const statusEl = document.getElementById('adminAccessControlsStatus');
                    const msg = resp.error?.message || 'Falha ao remover regras no servidor';
                    const det = resp.error?.details ? ` (${resp.error.details})` : '';
                    const code = resp.error?.code ? ` [${resp.error.code}]` : '';
                    if (statusEl) statusEl.textContent = `Erro ao remover: ${msg}${det}${code}. Ajuste políticas de delete em access_controls.`;
                    showFloatingNotification('warning', `Falha ao remover regras: ${msg}${det}${code}`);
                    return;
                }
                const deletedCount = Array.isArray(resp.data) ? resp.data.length : 0;
                if (exists && deletedCount === 0) {
                    let hasAllowedSubsections = true;
                    try { const probe = await supabase.from('access_controls').select('allowed_subsections').limit(1); if (probe.error) hasAllowedSubsections = false; } catch(_) { hasAllowedSubsections = false; }
                    const fallbackUpd = hasAllowedSubsections ? { role: 'unrestricted', allowed_sections: [], allowed_subsections: {} } : { role: 'unrestricted', allowed_sections: [] };
                    const upd = await supabase.from('access_controls').update(fallbackUpd).eq('email', e).select('email');
                    if (upd.error) {
                        const msg = upd.error?.message || 'Falha ao desativar restrição por update';
                        const det = upd.error?.details ? ` (${upd.error.details})` : '';
                        const code = upd.error?.code ? ` [${upd.error.code}]` : '';
                        if (statusEl) statusEl.textContent = `Delete negado e update falhou: ${msg}${det}${code}`;
                        showFloatingNotification('warning', 'Sem permissão para remover (RLS) e update falhou.');
                        return;
                    }
                    const post2 = await supabase.from('access_controls').select('*').eq('email', e).limit(1);
                    if (!post2.error && Array.isArray(post2.data) && post2.data[0] && (post2.data[0].role||'') !== 'restricted') {
                        showFloatingNotification('success', 'Restrição desativada (sem permissão de delete).');
                        await loadAccessControls();
                        renderAccessControls();
                        applyAccessControls();
                        return;
                    }
                    if (statusEl) statusEl.textContent = 'Delete negado e update não confirmou desativação. Ajuste RLS.';
                    showFloatingNotification('warning', 'Sem permissão para remover (RLS) ou regra não encontrada.');
                    return;
                }
                const post = await supabase.from('access_controls').select('email').eq('email', e).limit(1);
                if (!post.error && Array.isArray(post.data) && post.data.length === 0) {
                    showFloatingNotification('success', 'Regra removida');
                    await loadAccessControls();
                    renderAccessControls();
                    applyAccessControls();
                } else {
                    const msg = post.error?.message || 'Regra ainda presente após tentativa de remoção';
                    const det = post.error?.details ? ` (${post.error.details})` : '';
                    const code = post.error?.code ? ` [${post.error.code}]` : '';
                    if (statusEl) statusEl.textContent = `Remoção não confirmada: ${msg}${det}${code}`;
                    showFloatingNotification('warning', 'Remoção não confirmada');
                }
            } catch(_) { showFloatingNotification('error', 'Erro ao remover regras'); }
        }

        function renderAccessControls() {
            const list = getCachedAccessControls();
            const wrap = document.getElementById('adminRulesList');
            if (!wrap) return;
            if (!list.length) { wrap.innerHTML = '<div class="text-sm text-gray-500 dark:text-gray-400">Nenhum email restrito cadastrado</div>'; return; }
            wrap.innerHTML = list.map(r => `
                <div class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg flex items-center justify-between">
                    <div>
                        <div class="text-sm font-medium text-gray-900 dark:text-white">${r.email}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${(r.allowed_sections||[]).join(', ')}</div>
                        ${r.allowed_subsections && (r.allowed_subsections['cct_coque']||[]).length ? `<div class="text-[11px] text-gray-500 dark:text-gray-400">CCT: ${(r.allowed_subsections['cct_coque']||[]).join(', ')}</div>` : ''}
                        ${r.allowed_subsections && (r.allowed_subsections['irrigacao']||[]).length ? `<div class="text-[11px] text-gray-500 dark:text-gray-400">IRRIGAÇÃO: ${(r.allowed_subsections['irrigacao']||[]).join(', ')}</div>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button class="px-3 py-1 text-sm bg-gray-700 text-white rounded-md" onclick="editAccessRule('${r.email}')">Editar</button>
                        <button class="px-3 py-1 text-sm bg-red-600 text-white rounded-md" onclick="deleteAccessRule('${r.email}')">Remover</button>
                    </div>
                </div>
            `).join('');
        }

        function bindAdminActions() {
            const s = document.getElementById('adminSaveRuleBtn');
            const c = document.getElementById('adminClearBtn');
            const f = document.getElementById('adminForceRefreshBtn');
            const g = document.getElementById('adminCopyUsersSqlBtn');
            const gs = document.getElementById('adminCopyAuthSyncSqlBtn');
            const rs = document.getElementById('adminRunAuthSyncBtn');
            const ac = document.getElementById('adminCopyAccessControlsSqlBtn');
            const dg = document.getElementById('adminDiagnoseBtn');
            if (s && !s._bound) { s.addEventListener('click', saveAccessRule); s._bound = true; }
            if (c && !c._bound) { c.addEventListener('click', function(){ const e=document.getElementById('adminEmailInput'); if(e) e.value=''; Array.from(document.querySelectorAll('#adminSectionsSelect input[type="checkbox"]')).forEach(b=>{ b.checked=false; }); const d1=document.getElementById('adminSectionsCCTDetail'); if(d1) d1.classList.add('hidden'); const d2=document.getElementById('adminSectionsIRRDetail'); if(d2) d2.classList.add('hidden'); }); c._bound=true; }
            if (f && !f._bound) { f.addEventListener('click', adminForceRefresh); f._bound = true; }
            if (g && !g._bound) { g.addEventListener('click', adminCopyUsersSQL); g._bound = true; }
            if (gs && !gs._bound) { gs.addEventListener('click', adminCopyAuthSyncSQL); gs._bound = true; }
            if (rs && !rs._bound) { rs.addEventListener('click', adminRunAuthSync); rs._bound = true; }
            if (ac && !ac._bound) { ac.addEventListener('click', function(){
                const sql = [
                    'begin;',
                    'create table if not exists public.access_controls (',
                    '  email text primary key,',
                    "  role text default 'restricted',",
                    "  allowed_sections text[] default '{}',",
                    "  allowed_subsections jsonb default '{}'::jsonb,",
                    '  created_at timestamptz default now()',
                    ');',
                    'alter table public.access_controls enable row level security;',
                    "create policy \"ac_select_auth\" on public.access_controls for select using (auth.role() = 'authenticated');",
                    "create policy \"ac_insert_write\" on public.access_controls for insert with check ((auth.jwt()->>'email' = 'gutemberggg10@gmail.com') OR exists (select 1 from public.users u where u.email = auth.jwt()->>'email' and u.approved = true));",
                    "create policy \"ac_update_write\" on public.access_controls for update using ((auth.jwt()->>'email' = 'gutemberggg10@gmail.com') OR exists (select 1 from public.users u where u.email = auth.jwt()->>'email' and u.approved = true));",
                    "create policy \"ac_delete_write\" on public.access_controls for delete using ((auth.jwt()->>'email' = 'gutemberggg10@gmail.com') OR exists (select 1 from public.users u where u.email = auth.jwt()->>'email' and u.approved = true));",
                    'create table if not exists public.system_events (',
                    '  id bigserial primary key,',
                    '  type text not null,',
                    '  title text,',
                    '  message text,',
                    "  payload jsonb default '{}'::jsonb,",
                    '  created_at timestamptz default now()',
                    ');',
                    'alter table public.system_events enable row level security;',
                    "create policy \"se_select_auth\" on public.system_events for select using (auth.role() = 'authenticated');",
                    "create policy \"se_insert_auth\" on public.system_events for insert with check (auth.role() = 'authenticated');",
                    'alter publication supabase_realtime add table public.access_controls;',
                    'alter publication supabase_realtime add table public.inspections;',
                    'alter publication supabase_realtime add table public.irrig_inspections;',
                    'alter publication supabase_realtime add table public.equipments;',
                    'alter publication supabase_realtime add table public.system_events;',
                    'alter publication supabase_realtime add table public.users;',
                    'commit;'
                ].join('\n');
                const tryClipboard = async () => {
                    try { await navigator.clipboard.writeText(sql); showFloatingNotification('success', 'SQL copiado'); }
                    catch(_) { const ta = document.createElement('textarea'); ta.value = sql; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); showFloatingNotification('success', 'SQL copiado'); } catch(e) { showCustomAlert(sql); } ta.remove(); }
                };
                tryClipboard();
            }); ac._bound = true; }
            if (dg && !dg._bound) { dg.addEventListener('click', adminDiagnoseAccessControls); dg._bound = true; }
            const cct = document.querySelector('#adminSectionsSelect input[value="cct_coque"]');
            const irr = document.querySelector('#adminSectionsSelect input[value="irrigacao"]');
            const cctDetail = document.getElementById('adminSectionsCCTDetail');
            const irrDetail = document.getElementById('adminSectionsIRRDetail');
            function toggleDetails() { if (cct && cctDetail) { if (cct.checked) cctDetail.classList.remove('hidden'); else cctDetail.classList.add('hidden'); } if (irr && irrDetail) { if (irr.checked) irrDetail.classList.remove('hidden'); else irrDetail.classList.add('hidden'); } }
            if (cct && !cct._bound) { cct.addEventListener('change', toggleDetails); cct._bound = true; }
            if (irr && !irr._bound) { irr.addEventListener('change', toggleDetails); irr._bound = true; }
            toggleDetails();
            loadUsers();
        }

        async function adminDiagnoseAccessControls() {
            const statusEl = document.getElementById('adminAccessControlsStatus');
            try {
                const online = isOnline();
                const u = currentUser || getCachedUser() || {};
                const admin = isAdmin();
                let approved = null;
                if (online && u.email) {
                    const ur = await supabase.from('users').select('approved').eq('email', u.email).limit(1);
                    if (!ur.error && Array.isArray(ur.data) && ur.data[0]) { approved = !!ur.data[0].approved; }
                }
                let acMsg = '';
                let count = 0;
                if (online) {
                    const ar = await supabase.from('access_controls').select('email');
                    if (!ar.error) { count = (ar.data || []).length; acMsg = `Tabela ok (${count})`; }
                    else { const msg = ar.error?.message || 'Erro ao acessar access_controls'; const det = ar.error?.details ? ` (${ar.error.details})` : ''; acMsg = `${msg}${det}`; }
                }
                const parts = [];
                parts.push(`Online: ${online ? 'sim' : 'não'}`);
                parts.push(`Usuário: ${(u.email||'')}`);
                parts.push(`Admin: ${admin ? 'sim' : 'não'}`);
                if (approved !== null) parts.push(`Approved: ${approved ? 'sim' : 'não'}`);
                if (acMsg) parts.push(`access_controls: ${acMsg}`);
                if (writeMsg) parts.push(`write: ${writeMsg}`);
                const txt = parts.join(' | ');
                if (statusEl) statusEl.textContent = txt;
                showFloatingNotification('success', 'Diagnóstico concluído');
            } catch (e) {
                const msg = e?.message || 'Falha no diagnóstico';
                if (statusEl) statusEl.textContent = msg;
                showFloatingNotification('error', 'Falha no diagnóstico');
            }
        }

        function adminCopyUsersSQL() {
            const sql = [
                'begin;',
                'create table if not exists public.users (',
                '  email text primary key,',
                '  name text,',
                '  user_id text,',
                '  email_confirmed boolean default false,',
                '  approved boolean default false,',
                '  last_seen timestamptz default now(),',
                '  created_at timestamptz default now()',
                ');',
                'alter table public.users enable row level security;',
                'create policy "users_select_admin" on public.users for select using (auth.jwt()->>\'email\' = \'gutemberggg10@gmail.com\');',
                'create policy "users_select_self" on public.users for select using (email = auth.jwt()->>\'email\');',
                'create policy "users_insert_self" on public.users for insert with check (email = auth.jwt()->>\'email\');',
                'create policy "users_update_admin" on public.users for update using (auth.jwt()->>\'email\' = \'gutemberggg10@gmail.com\');',
                'alter publication supabase_realtime add table public.users;',
                'commit;'
            ].join('\n');
            const tryClipboard = async () => {
                try { await navigator.clipboard.writeText(sql); showFloatingNotification('success', 'SQL copiado'); }
                catch(_) {
                    const ta = document.createElement('textarea'); ta.value = sql; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); showFloatingNotification('success', 'SQL copiado'); } catch(e) { showCustomAlert(sql); } ta.remove();
                }
            };
            tryClipboard();
        }

        function adminCopyAuthSyncSQL() {
            const sql = [
                'begin;',
                'create or replace function public.sync_users_from_auth() returns void language plpgsql security definer set search_path = public as $$',
                'begin',
                '  insert into public.users (email, name, user_id, email_confirmed, approved, last_seen, created_at)',
                '  select u.email,',
                "         coalesce(trim((u.raw_user_meta_data->>'first_name')||' '||(u.raw_user_meta_data->>'last_name')), split_part(u.email,'@',1)),",
                '         u.id::text,',
                '         (u.email_confirmed_at is not null),',
                '         false,',
                '         now(),',
                '         coalesce(u.created_at, now())',
                '  from auth.users u',
                '  left join public.users pu on pu.email = u.email',
                '  where pu.email is null;',
                'end;',
                '$$;',
                'grant execute on function public.sync_users_from_auth() to anon, authenticated;',
                'commit;'
            ].join('\n');
            const tryClipboard = async () => {
                try { await navigator.clipboard.writeText(sql); showFloatingNotification('success', 'SQL copiado'); }
                catch(_) {
                    const ta = document.createElement('textarea'); ta.value = sql; document.body.appendChild(ta); ta.select(); try { document.execCommand('copy'); showFloatingNotification('success', 'SQL copiado'); } catch(e) { showCustomAlert(sql); } ta.remove();
                }
            };
            tryClipboard();
        }

        async function adminRunAuthSync() {
            if (!isAdmin()) { showCustomAlert('Acesso restrito.'); return; }
            if (!isOnline()) { showFloatingNotification('warning', 'Sem internet'); return; }
            try {
                const { error } = await supabase.rpc('sync_users_from_auth');
                if (error) { showFloatingNotification('warning', 'Função não disponível'); return; }
                showFloatingNotification('success', 'Sincronização concluída');
                loadUsers();
            } catch(_) { showFloatingNotification('error', 'Erro ao sincronizar'); }
        }

        async function loadUsers() {
            try {
                if (isOnline()) {
                    let { data, error } = await supabase.from('users').select('*').order('created_at', { ascending: false });
                    if (!error) {
                        usersList = data || [];
                        const onlineCount = Object.keys(onlineUsers || {}).length;
                        if (isAdmin() && (!usersList.length || (onlineCount > usersList.length))) {
                            try {
                                const rpc = await supabase.rpc('sync_users_from_auth');
                                if (!rpc.error) {
                                    const r2 = await supabase.from('users').select('*').order('created_at', { ascending: false });
                                    if (!r2.error) { usersList = r2.data || usersList; }
                                }
                            } catch(_) {}
                        }
                        renderAdminUsers();
                        return;
                    }
                    usersList = [];
                    renderAdminUsers('Tabela users não disponível ou sem acesso.');
                    return;
                }
                renderAdminUsers('Sem internet. Exibindo apenas usuários online.');
            } catch(_) { renderAdminUsers(); }
        }

        function renderAdminUsers(message) {
            const wrap = document.getElementById('adminUsersList');
            if (!wrap) return;
            const note = message ? `<div class="text-xs text-yellow-700 dark:text-yellow-300 mb-2">${message}</div>` : '';
            const unionMap = {};
            (usersList || []).forEach(u => { if (u && u.email) unionMap[u.email] = u; });
            Object.keys(onlineUsers || {}).forEach(e => { if (!unionMap[e]) unionMap[e] = { email: e, name: (onlineUsers[e] || {}).name }; });
            const merged = Object.values(unionMap);
            if (!merged || merged.length === 0) { wrap.innerHTML = note + '<div class="text-sm text-gray-500 dark:text-gray-400">Nenhum usuário encontrado</div>'; return; }
            wrap.innerHTML = note + merged.map(u => {
                const online = !!onlineUsers[u.email];
                const emailConf = typeof u.email_confirmed === 'boolean' ? u.email_confirmed : false;
                const approved = typeof u.approved === 'boolean' ? u.approved : false;
                const onlineBadge = online ? '<span class="ml-2 inline-block w-2 h-2 rounded-full bg-green-500" title="online"></span>' : '<span class="ml-2 inline-block w-2 h-2 rounded-full bg-gray-400" title="offline"></span>';
                const fromPresenceOnly = (u.email_confirmed === undefined && u.approved === undefined);
                const status = fromPresenceOnly ? 'Online • origem: presença' : `${emailConf ? 'Email confirmado' : 'Email não confirmado'} • ${approved ? 'Aprovado' : 'Pendente'}`;
                const actions = fromPresenceOnly ? '<span class="text-xs text-gray-500">Aguardando cadastro</span>' : (approved ? `<button class="px-3 py-1 text-sm bg-yellow-600 text-white rounded-md" onclick="blockUser('${u.email}')">Desativar</button>` : (emailConf ? `<button class="px-3 py-1 text-sm bg-green-600 text-white rounded-md" onclick="approveUser('${u.email}')">Aprovar</button>` : '<span class="text-xs text-gray-500">Aguardando confirmação de email</span>'));
                const name = (u.name || u.email || '').toString();
                const email = (u.email || '').toString();
                return `
                    <div class="p-3 border border-gray-200 dark:border-gray-700 rounded-lg flex items-center justify-between">
                        <div>
                            <div class="text-sm font-medium text-gray-900 dark:text-white">${name}${onlineBadge}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${email} • ${status}</div>
                        </div>
                        <div class="flex items-center gap-2">${actions}</div>
                    </div>
                `;
            }).join('');
        }

        async function approveUser(email) {
            if (!isAdmin()) { showCustomAlert('Acesso restrito.'); return; }
            try {
                if (isOnline()) {
                    const { error } = await supabase.from('users').update({ approved: true }).eq('email', email);
                    if (error) { showFloatingNotification('warning', 'Falha ao aprovar'); return; }
                    showFloatingNotification('success', 'Usuário aprovado');
                    loadUsers();
                } else {
                    showFloatingNotification('warning', 'Sem internet');
                }
            } catch(_) { showFloatingNotification('error', 'Erro ao aprovar'); }
        }

        async function blockUser(email) {
            if (!isAdmin()) { showCustomAlert('Acesso restrito.'); return; }
            try {
                if (isOnline()) {
                    const { error } = await supabase.from('users').update({ approved: false }).eq('email', email);
                    if (error) { showFloatingNotification('warning', 'Falha ao desativar'); return; }
                    showFloatingNotification('success', 'Usuário desativado');
                    loadUsers();
                } else {
                    showFloatingNotification('warning', 'Sem internet');
                }
            } catch(_) { showFloatingNotification('error', 'Erro ao desativar'); }
        }

        async function adminForceRefresh() {
            if (!isAdmin()) { showCustomAlert('Acesso restrito.'); return; }
            if (!isOnline()) { showFloatingNotification('warning', 'Sem internet. Não foi possível enviar o comando.'); return; }
            try {
                const msgEl = document.getElementById('adminUpdateMessage');
                const requireEl = document.getElementById('adminRequireConfirm');
                const message = (msgEl && msgEl.value ? msgEl.value : 'NOVA ATUALIZAÇÃO DO SISTEMA').trim();
                const requireConfirm = !!(requireEl && requireEl.checked);
                await supabase.channel('system-broadcast').send({ type: 'broadcast', event: 'force_refresh', payload: { message, requireConfirm } });
                showFloatingNotification('success', 'Comando enviado');
            } catch (_) {
                showFloatingNotification('warning', 'Falha ao enviar comando online');
            }
        }

        function getCachedUserRecord() { try { return JSON.parse(localStorage.getItem('userRecord')) || null; } catch(_) { return null; } }
        function setCachedUserRecord(r) { try { localStorage.setItem('userRecord', JSON.stringify(r)); } catch(_) {} }
        function isApprovedUser() { const r = getCachedUserRecord(); return !!(r && r.approved); }
        async function ensureUserRecord() {
            try {
                const u = currentUser || getCachedUser();
                if (!u || !u.email) return null;
                const base = { email: u.email, name: getDisplayName(u), user_id: u.id, email_confirmed: !!(u.email_confirmed_at || u.confirmed_at), last_seen: new Date().toISOString() };
                if (isOnline()) {
                    const { data, error } = await supabase.from('users').select('*').eq('email', u.email).limit(1);
                    if (!error && data && data[0]) {
                        const existing = data[0];
                        await supabase.from('users').update(base).eq('email', u.email);
                        const merged = Object.assign({}, existing, base);
                        setCachedUserRecord(merged);
                        return merged;
                    } else {
                        const rec = Object.assign({}, base, { approved: false, created_at: new Date().toISOString() });
                        const { data: ins, error: insErr } = await supabase.from('users').insert([rec]).select();
                        if (!insErr && ins && ins[0]) { setCachedUserRecord(ins[0]); return ins[0]; }
                        setCachedUserRecord(rec);
                        return rec;
                    }
                } else {
                    const cached = getCachedUserRecord();
                    if (cached) return cached;
                    const rec = Object.assign({}, base, { approved: false, created_at: new Date().toISOString() });
                    setCachedUserRecord(rec);
                    return rec;
                }
            } catch(_) { return null; }
        }

        function startPresence() {
            try {
                if (presenceChannel) return;
                const u = currentUser || getCachedUser();
                presenceChannel = supabase.channel('user-presence', { config: { presence: { key: (u && u.id) ? u.id : (u && u.email) || 'anon' } } })
                    .on('presence', { event: 'sync' }, () => {
                        const state = presenceChannel.presenceState();
                        const merged = {};
                        Object.values(state).forEach(arr => { arr.forEach(p => { if (p.email) merged[p.email] = { email: p.email, name: p.name }; }); });
                        onlineUsers = merged;
                        renderAdminUsers();
                    })
                    .subscribe(async (status) => {
                        if (status === 'SUBSCRIBED') {
                            const payload = { email: u.email, name: getDisplayName(u) };
                            try { await presenceChannel.track(payload); } catch(_) {}
                        }
                    });
            } catch(_) {}
        }

        function sanitizeStrayNodes() {
            try {
                const suspicious = [/<!DOCTYPE html/i, /<html/i, /<head>/i, /<style>/i, /\$\{/];
                const body = document.body;
                const nodes = Array.from(body.childNodes);
                nodes.forEach(n => {
                    if (n.nodeType === Node.TEXT_NODE) {
                        const t = String(n.textContent || '').trim();
                        if (t.length > 50 && suspicious.some(rx => rx.test(t))) {
                            n.remove();
                        }
                    }
                });
            } catch (_) {}
        }
        function printRecord() {
            try {
                const title = document.getElementById('recordModalTitle')?.textContent || 'Registro';
                const content = document.getElementById('recordDetails')?.innerHTML || '';
                const w = window.open('', '_blank');
                if (!w) return;
                w.document.write(`<!doctype html><html><head><meta charset='utf-8'><title>${title}</title><style>
                    body{font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; padding: 24px; color:#111827}
                    h1{font-size:20px;margin:0 0 12px}
                    .section{margin-top:16px}
                    table{width:100%;border-collapse:collapse;font-size:12px}
                    th,td{border:1px solid #e5e7eb;padding:6px;text-align:left}
                    .muted{color:#6B7280;font-size:12px}
                </style></head><body><h1>${title}</h1>${content}</body></html>`);
                w.document.close();
                w.focus();
                w.print();
            } catch(_) {}
        }
    </script>
    <div id="recordModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-start sm:items-center justify-center z-50 hidden p-4">
        <div class="record-modal bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg w-full sm:max-w-2xl max-h-[80vh] sm:max-h-[85vh] overflow-y-auto mx-0 sm:mx-4 fade-in">
            <div class="flex items-center justify-between mb-4">
                <h3 id="recordModalTitle" class="text-lg font-semibold text-gray-900 dark:text-white">Registro</h3>
                <div class="flex gap-2">
                    <button id="printRecordBtn" class="px-3 py-2 bg-primary text-white rounded-md">Imprimir</button>
                    <button onclick="closeRecordModal()" class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md text-gray-700 dark:text-gray-300">Fechar</button>
                </div>
            </div>
            <div id="recordDetails" class="space-y-4"></div>
        </div>
    </div>
</body>
</html>
       
       
